<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Customer Success Plan ‚Äî Enhanced</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --ink:#0f172a; --ink-2:#334155; --ink-3:#64748b; }
    body { font-family: 'Inter', sans-serif; background:#f1f5f9; color:var(--ink); }

    /* Unified text zones: every text/edit surface is clearly bordered with squircle borders and auto-sizing textareas */
    .text-zone { width:100%; border-radius:2px; border:1px solid rgb(203 213 225); background:#fff; box-shadow:none; transition: border-color .2s, background-color .2s; outline: none; }
    .text-zone:focus { border-color: rgb(8 145 178); box-shadow: 0 0 0 4px rgba(8,145,178,0.2); }
    .text-area { resize: none; min-height: 2.75rem; overflow: hidden; font-size: clamp(0.9rem, 0.88rem + 0.2vw, 1rem); line-height: 1.6; }
    .chip { display:inline-flex; align-items:center; gap:.25rem; padding:.25rem .5rem; font-size:.75rem; font-weight:600; border-radius:2px; border:1px solid rgba(15,23,42,.15); }

    /* Status pills */
    .status-pill { font-size: .75rem; font-weight: 600; margin-right: .5rem; padding: .125rem .625rem; border-radius: 2px; display:inline-flex; align-items:center; }
    .status-green { background:#dcfce7; color:#166534; }
    .status-yellow { background:#fef9c3; color:#854d0e; }
    .status-red { background:#fee2e2; color:#991b1b; }
    .status-gray { background:#e2e8f0; color:#1f2937; }
    .status-cyan { background:#cffafe; color:#155e75; }

    /* Colored filters for "Find Similar" area */
    .colored-filter { background:#ecfdf5; border:1px solid #6ee7b7; }
    .colored-filter:focus { border-color:#10b981; box-shadow: 0 0 0 3px rgba(16,185,129,0.25); }

    /* Cards + micro-transitions */
    .card { background:#fff; border-radius:2px; box-shadow:none; border:1px solid rgba(226,232,240,1); }
    .fade { transition: all .2s ease; }
    .removing { transform: scale(.98); opacity:0; max-height:0; padding-top:0; padding-bottom:0; margin-top:0; margin-bottom:0; border-width:0; }
    
    /* Enhanced desktop layout */
    .desktop-optimized { @apply max-w-screen-xl mx-auto; }
    
    /* Better spacing for wide screens */
    @media (min-width: 1280px) {
      .lg\:grid-cols-4 { grid-template-columns: repeat(4, minmax(0, 1fr)); }
      .lg\:col-span-3 { grid-column: span 3 / span 3; }
      .lg\:col-span-1 { grid-column: span 1 / span 1; }
    }

    /* Preview blocks inside objective cards */
    .preview-box { background:#f8fafc; border:1px solid rgb(226 232 240); border-radius:2px; padding:0.75rem; }

    /* Small helpers */
    .health-dot { width:0.75rem; height:0.75rem; border-radius:9999px; display:inline-block; margin-right:0.5rem; }
    .linkish { text-decoration-line: underline; text-decoration-style: dotted; color:#0e7490; }
    .linkish:hover { color:#0a3f56; }
    /* Modal aesthetics */
    .modal-overlay { position:fixed; inset:0; background: rgba(0,0,0,0.55); backdrop-filter: blur(2px); display:flex; align-items:center; justify-content:center; z-index:50; }
    .modal-panel { border-radius:2px; border:1px solid rgba(226,232,240,0.9); box-shadow: 0 20px 40px rgba(2,6,23,0.25); max-height:90vh; overflow-y:auto; background:#ffffff; }
    .modal-header { padding:1rem 1.5rem; border-bottom:1px solid rgba(226,232,240,0.7); background: linear-gradient(90deg, rgba(8,145,178,0.08), rgba(16,185,129,0.08)); border-top-left-radius:2px; border-top-right-radius:2px; }
    .modal-body { padding:1.5rem; }
    .modal-footer { padding:1rem 1.5rem; border-top:1px solid rgba(226,232,240,0.7); display:flex; justify-content:flex-end; gap:.75rem; }

    /* Buttons: high-contrast, modern */
    .btn { display:inline-flex; align-items:center; gap:.5rem; font-weight:600; border-radius:2px; padding:.5rem .75rem; border:1px solid transparent; transition: all .2s ease; }
    .btn-sm { padding:.25rem .5rem; font-size:.875rem; border-radius:2px; }
    .btn-primary { background:#0f172a; color:#fff; }
    .btn-primary:hover { background:#111827; }
    .btn-success { background:#059669; color:#fff; }
    .btn-success:hover { background:#047857; }
    .btn-outline { background:#fff; color:#0f172a; border-color:#cbd5e1; }
    .btn-outline:hover { background:#f1f5f9; }
    .btn-ghost { background:transparent; color:#0f172a; }
    .btn-ghost:hover { background:rgba(15,23,42,0.06); }
  </style>
</head>
<body>
  <div id="app" class="max-w-screen-xl mx-auto p-4 sm:p-6 lg:p-8">
    <header class="mb-10 p-8 bg-gradient-to-r from-slate-900 via-slate-800 to-slate-700 text-white flex justify-between items-center" style="border-radius:2px;">
      <div>
        <h1 class="text-4xl font-bold">Customer Success Plan</h1>
        <p class="text-cyan-200 mt-2">A collaborative plan to track and achieve outcomes. Last updated: Aug 12, 2025</p>
      </div>
      <div class="flex items-center gap-3">
        <button id="export-excel-btn" class="btn btn-outline bg-gradient-to-r from-emerald-600 to-teal-500 text-white border-0">Export Excel</button>
        <button id="export-pdf-btn" class="btn btn-primary flex items-center bg-gradient-to-r from-sky-600 to-indigo-500 border-0">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V7.414A2 2 0 0015.414 6L12 2.586A2 2 0 0010.586 2H6zm5 6a1 1 0 10-2 0v3.586l-1.293-1.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V8z" clip-rule="evenodd" /></svg>
          Export PDF
        </button>
      </div>
    </header>

    <!-- Mission Summary -->
    <section class="card mb-6 p-6">
      <h2 class="text-2xl font-bold mb-4">Mission Summary</h2>
      <textarea id="mission-summary" class="text-zone text-area p-3" rows="3" placeholder="Describe the primary business outcome and vision..."></textarea>
    </section>

    <!-- Mission Goals -->
    <section class="card mb-10 p-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold">Mission Goals</h2>
        <button id="add-mission-goal-btn" class="btn btn-success">+ Add Goal</button>
      </div>
      <div id="mission-goals-container" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
    </section>

    <main class="grid grid-cols-1 lg:grid-cols-4 gap-8">
      <!-- Left -->
      <div class="lg:col-span-3 space-y-8">
        <!-- Value Realized -->
        <section id="value-realized" class="card p-6">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold">Value Realized</h2>
            <button id="add-value-btn" class="btn btn-success">+ Add Value</button>
          </div>
          <div id="value-container" class="space-y-4"></div>
          <div id="no-value-message" class="hidden text-center py-10 px-4 text-slate-500">No value items added yet.</div>
        </section>

        <!-- Current Objectives -->
        <section id="current-objectives" class="card p-6">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold">Current Objectives</h2>
            <button id="add-objective-btn" class="btn btn-primary">+ Add Objective</button>
          </div>
          <div id="objectives-container" class="space-y-6"></div>
        </section>

        <!-- Past Objectives -->
        <section id="past-objectives" class="card p-6">
          <h2 class="text-2xl font-bold mb-4">Past Objectives Achieved</h2>
          <div id="past-objectives-container" class="space-y-6"></div>
          <div id="no-past-objectives" class="hidden text-center py-10 px-4 text-slate-500">Completed objectives will appear here.</div>
        </section>
      </div>

      <!-- Right -->
      <div class="lg:col-span-1 space-y-8">
        <section id="kpi-section" class="card p-6"></section>
        <section id="metrics-section" class="card p-6"></section>
        <section class="card p-6">
          <h3 class="text-lg font-semibold mb-3">Plan Details</h3>
          <label class="block text-sm font-medium mb-1">Overall Health</label>
          <select id="health-score" class="text-zone p-2">
            <option value="green">üü¢ On Track</option>
            <option value="yellow">üü° Needs Attention</option>
            <option value="red">üî¥ At Risk</option>
          </select>
        </section>

        <section class="card p-6">
          <h3 class="text-lg font-semibold mb-3">Find Similar Objectives</h3>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium mb-1">Industry</label>
              <select id="filter-industry" class="text-zone colored-filter p-2">
                <option>Technology</option>
                <option>Finance</option>
                <option>Healthcare</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Segment</label>
              <select id="filter-segment" class="text-zone colored-filter p-2">
                <option>SMB</option>
                <option>MM</option>
                <option>Enterprise</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Products Owned</label>
              <select id="filter-products" class="text-zone colored-filter p-2">
                <option value="">Select a product...</option>
                <option>Content Library</option>
                <option>AI</option>
                <option>Projects</option>
                <option>Trust Center</option>
              </select>
            </div>
            <div id="suggested-objectives-container" class="hidden pt-4 border-t">
              <h4 class="text-sm font-semibold mb-2">Suggested Objectives</h4>
              <div id="suggested-objectives-list" class="flex flex-wrap gap-2"></div>
            </div>
          </div>
        </section>

        <section class="card p-6">
          <h3 class="text-lg font-semibold mb-3">Key Stakeholders</h3>
          <div id="stakeholders-container" class="space-y-3 mb-3"></div>
          <select id="add-stakeholder-select" class="text-zone p-2">
            <option value="">+ Add a contact...</option>
            <option value="new">Add New Stakeholder...</option>
          </select>
        </section>
      </div>
    </main>
  </div>

  <script>
    // ---------- Data ----------
    const objectiveOptions = ['Reduce time spent per response', 'Adoption', 'Content library clean up', 'Increase win rate'];
    const valueOptions = ['Time Savings', 'Win Rate Increase', 'Adoption Rate', 'Cost Reduction', 'Revenue Growth', 'Productivity Gain'];

    // Predefined KPI types catalogue for auto unit + delta direction
    const KPI_TYPES = [
      { key: 'content_utilization', label: 'Content Utilization', unit: '%', direction: 'up_is_good' },
      { key: 'obsolete_content_pct', label: 'Obsolete Content Percentage', unit: '%', direction: 'down_is_good' },
      { key: 'avg_response_time', label: 'Average Response Time', unit: 'seconds', direction: 'down_is_good' },
      { key: 'customer_satisfaction', label: 'Customer Satisfaction', unit: '%', direction: 'up_is_good' },
      { key: 'tickets_resolved', label: 'Support Tickets Resolved', unit: 'count', direction: 'up_is_good' },
      { key: 'escalation_rate', label: 'Escalation Rate', unit: '%', direction: 'down_is_good' }
    ];

    // Suggested KPIs based on product selection
    const productKPIs = {
      'AI': ['Unedited AI responses', '% answer with AI', 'AI response quality score', 'AI adoption rate'],
      'Content Library': ['Content usage rate', 'Content creation time', 'Content approval time', 'Content search efficiency'],
      'Projects': ['Project completion rate', 'Project delivery time', 'Project budget adherence', 'Stakeholder satisfaction'],
      'Trust Center': ['Trust score improvement', 'Compliance rate', 'Security incident reduction', 'Customer confidence score']
    };

    const mockContacts = [
      { id: 1, name: 'Jane Doe', title: 'VP, Sales', email: 'jane.d@example.com' },
      { id: 2, name: 'John Smith', title: 'Project Manager', email: 'john.s@example.com' },
      { id: 3, name: 'Samantha Ray', title: 'Director of Ops', email: 'samantha.r@example.com' },
      { id: 4, name: 'Mike Chen', title: 'Lead Engineer', email: 'mike.c@example.com' },
      // LOTR Easter eggs
      { id: 1001, name: 'Gandalf the Grey', title: 'Chief Wizard', email: 'gandalf@middleearth.me' },
      { id: 1002, name: 'Aragorn Elessar', title: 'Head of Field Ops', email: 'aragorn@gondor.gov' },
      { id: 1003, name: 'Legolas Greenleaf', title: 'Director of Archery', email: 'legolas@mirkwood.el' },
      { id: 1004, name: 'Gimli, Son of Gl√≥in', title: 'Chief Mining Officer', email: 'gimli@erebor.dw' },
      { id: 1005, name: 'Frodo Baggins', title: 'Special Projects Lead', email: 'frodo@shire.me' },
      { id: 1006, name: 'Samwise Gamgee', title: 'Chief of Staff', email: 'samwise@shire.me' },
      { id: 1007, name: 'Galadriel', title: 'Executive Advisor', email: 'galadriel@lothlorien.el' },
      { id: 1008, name: 'Elrond', title: 'Head of Strategy', email: 'elrond@rivendell.el' }
    ];

    const state = {
      missionGoals: [
        { id: Date.now(), title: 'Time Savings', description: 'Reduce time spent on manual tasks by 20% through automation and streamlined workflows.', customFields: [{id: 1, label: 'Collateral', value: 'https://example.com/deck'}] },
        { id: Date.now() + 1, title: 'Winning More Business', description: 'Increase the sales win rate by 10% by leveraging improved content and faster response times.', customFields: [] }
      ],
      stakeholders: [mockContacts[0], mockContacts[1]],
      objectives: [{
        id: Date.now(), name: 'Reduce time spent per response', targetDate: '2025-09-30', status: 'In Progress',
        kpiGoal: 'Reduce average response time from 45s to 30s.',
        challenges: 'Team members are still learning the new workflow.',
        nextSteps: 'Hold a workshop on advanced features.', s4Link: 'https://s4.example.com/ticket/12345',
        editing: false, expanded: false
      }, {
        id: Date.now() + 2, name: 'Content library clean up', targetDate: '2025-10-31', status: 'Not Started',
        kpiGoal: 'Archive 50% of obsolete content.',
        challenges: 'Lack of clear ownership for older content.',
        nextSteps: 'Work with Samantha Ray to identify content owners.', s4Link: 'https://s4.example.com/ticket/12346',
        editing: false, expanded: false
      }],
      pastObjectives: [{ id: Date.now()+100, name: 'Increase win rate', targetDate: '2025-06-30', status: 'Completed', kpiGoal: 'Raise win rate from 30% to 35% by Q2.', challenges: 'Competitive pricing pressure.', nextSteps: 'Monitor sustainment and share best practices.', s4Link: 'https://s4.example.com/ticket/12001', editing: false, expanded: false }],
      valueRealized: [{ id: Date.now(), type: 'Time Savings', description: 'Saved ~5 hours/week per agent in Q3.', date: '2025-07-30', link: 'https://datastudio.example.com/report/1' }],
      planHealth: 'green',
      missionSummary: 'To empower the sales team by centralizing our content, reducing response times, and providing data-driven insights that directly contribute to winning more business and increasing revenue.',
      kpis: [
        { id: Date.now()+401, typeKey: 'content_utilization', name: 'Content Utilization', unit: '%', value: 68, delta: 6 },
        { id: Date.now()+402, typeKey: 'obsolete_content_pct', name: 'Obsolete Content Percentage', unit: '%', value: 22, delta: -4 },
        { id: Date.now()+403, typeKey: 'avg_response_time', name: 'Average Response Time', unit: 'seconds', value: 37, delta: -5 }
      ],
      metrics: {
        periodType: 'Quarter',
        month: new Date().toISOString().slice(0,7),
        quarter: Math.floor((new Date().getMonth())/3)+1,
        year: new Date().getFullYear(),
        items: [
          { id: Date.now()+101, name: 'Win Rate', valuePercent: 37, deltaPercent: 5 },
          { id: Date.now()+102, name: 'Adoption', valuePercent: 62, deltaPercent: 8 }
        ]
      }
    };

    // ---------- Helpers ----------
    const $ = (q, root=document) => root.querySelector(q);
    const $$ = (q, root=document) => [...root.querySelectorAll(q)];
    const truncate = (t, n=100) => (t||'').length>n ? t.slice(0,n).trim()+ '‚Ä¶' : (t||'');
    const pillClass = (status) => ({'In Progress':'status-cyan','At Risk':'status-yellow','Completed':'status-green','Not Started':'status-gray'})[status]||'status-gray';
    const health = (o) => {
      if (o.status === 'Completed') return { dot:'bg-green-500', icon:'üü¢' };
      if (!o.targetDate) return { dot:'bg-green-500', icon:'üü¢' };
      const days = (new Date(o.targetDate) - new Date())/86400000;
      if (days < 0) return { dot:'bg-red-500', icon:'üî¥' };
      if (days <= 30) return { dot:'bg-red-500', icon:'üî¥' };
      if (days <= 90) return { dot:'bg-yellow-500', icon:'üü°' };
      return { dot:'bg-green-500', icon:'üü¢' };
    };
    const findObjectiveById = (id) => state.objectives.find(x=>x.id===id) || state.pastObjectives.find(x=>x.id===id) || null;

    // Auto-resize and responsive preview
    function autoResizeTextarea(textarea) {
      if (!textarea) return;
      textarea.style.height = 'auto';
      textarea.style.height = textarea.scrollHeight + 'px';
    }
    function applyAutoResize(root=document) {
      (($$('.text-area', root) || [])).forEach(autoResizeTextarea);
    }
    function getPreviewLimit() {
      const w = window.innerWidth || 1024;
      if (w < 640) return 120;
      if (w < 1024) return 160;
      return 220;
    }

    // ---------- Renderers ----------
    function renderMissionGoals(){
      const c = $('#mission-goals-container');
      c.innerHTML = state.missionGoals.map(g=>`
        <div id="mission-goal-${g.id}" class="card p-4" data-id="${g.id}">
          <div class="flex items-center justify-between gap-2">
            <input class="text-zone p-2 font-semibold" value="${g.title}" data-role="goal-title" />
            <button class="text-slate-400 hover:text-red-600" data-role="remove-goal">&times;</button>
          </div>
          <textarea class="text-zone text-area p-3 mt-2 text-sm" rows="3" placeholder="Goal description..." data-role="goal-desc">${g.description||''}</textarea>
          <div class="mt-3 space-y-2" data-role="custom-fields">
            ${(g.customFields||[]).map(f=>`
              <div class="flex items-center gap-2" data-field-id="${f.id}">
                <input class="text-zone p-2 text-xs font-semibold" value="${f.label}" placeholder="Field name" data-role="cf-label" />
                <input class="text-zone p-2 text-xs flex-1" value="${f.value||''}" placeholder="Value or https://link" data-role="cf-value" />
                <a href="${/^https?:\/\//.test(f.value)?f.value:'#'}" target="_blank" class="${/^https?:\/\//.test(f.value)?'linkish':'pointer-events-none opacity-40'} text-xs">Attach</a>
                <button class="text-slate-400 hover:text-red-600" title="Remove" data-role="remove-cf">üóëÔ∏è</button>
              </div>
            `).join('')}
          </div>
          <button class="text-cyan-700 font-semibold mt-2" data-role="add-cf">+ Add Custom Field</button>
        </div>
      `).join('');
      applyAutoResize(c);
      autoSave();
    }

    function valueItemHTML(item){
      return `
        <div id="value-${item.id}" class="card p-4" data-id="${item.id}">
          <div class="flex items-center justify-between">
            <select class="text-zone p-2 text-sm font-semibold value-type-select">
              ${valueOptions.map(opt=>`<option ${opt===item.type?'selected':''}>${opt}</option>`).join('')}
            </select>
            <button class="text-slate-400 hover:text-slate-600" data-role="remove-value">&times;</button>
          </div>
          <div class="mt-3">
            <label class="block text-xs font-medium mb-1">Description</label>
            <textarea class="text-zone text-area p-3 text-sm" rows="3" data-role="value-desc">${item.description||''}</textarea>
          </div>
          <div class="grid grid-cols-2 gap-3 mt-3">
            <div>
              <label class="block text-xs font-medium mb-1">Date Realized</label>
              <input type="date" value="${item.date||''}" class="text-zone p-2" data-role="value-date" />
            </div>
            <div>
              <label class="block text-xs font-medium mb-1">Reference Link</label>
              <input type="text" value="${item.link||''}" placeholder="https://" class="text-zone p-2" data-role="value-link" />
            </div>
          </div>
        </div>`;
    }

    function renderValue(){
      const c = $('#value-container');
      c.innerHTML = state.valueRealized.map(valueItemHTML).join('');
      $('#no-value-message').classList.toggle('hidden', state.valueRealized.length!==0);
      applyAutoResize(c);
      autoSave();
    }

    function objectiveCardHTML(o){
      const h = health(o);
      const statusCls = pillClass(o.status);
      if (o.editing) {
        // Inline edit mode per objective
        return `
          <div id="objective-${o.id}" class="card p-6" data-id="${o.id}">
            <div class="flex justify-between items-start gap-3">
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-2">
                  <span class="health-dot ${h.dot}"></span>
                  <input class="text-zone p-2 font-semibold" value="${o.name}" data-role="edit-name" />
                </div>
                <div class="flex flex-wrap items-center gap-2">
                  <select class="text-zone p-1 text-xs ${statusCls}" data-role="edit-status">
                    ${['Not Started','In Progress','At Risk','Completed'].map(s=>`<option ${o.status===s?'selected':''}>${s}</option>`).join('')}
                  </select>
                  <input type="date" class="text-zone p-1 text-sm w-auto" value="${o.targetDate||''}" data-role="edit-date" />
                </div>
              </div>
              <div class="flex items-center gap-2">
                <button class="btn btn-outline btn-sm" data-role="cancel-edit">Cancel</button>
                <button class="btn btn-primary btn-sm" data-role="save-edit">Save</button>
              </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
              <div>
                <label class="block text-sm font-medium mb-1">KPI Goal</label>
                <textarea class="text-zone text-area p-3" rows="3" data-role="edit-kpi">${o.kpiGoal||''}</textarea>
              </div>
              <div>
                <label class="block text-sm font-medium mb-1">Challenges</label>
                <textarea class="text-zone text-area p-3" rows="3" data-role="edit-challenges">${o.challenges||''}</textarea>
              </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
              <div>
                <label class="block text-sm font-medium mb-1">Next Steps</label>
                <textarea class="text-zone text-area p-3" rows="3" data-role="edit-steps">${o.nextSteps||''}</textarea>
              </div>
              <div>
                <label class="block text-sm font-medium mb-1">S4 / External Link</label>
                <input class="text-zone p-2" value="${o.s4Link||''}" placeholder="https://" data-role="edit-link" />
                ${o.s4Link?`<a class="linkish text-sm mt-1 inline-block" href="${o.s4Link}" target="_blank">Open</a>`:''}
              </div>
            </div>
          </div>`;
      }
      // View mode with always-on preview blocks
      return `
        <div id="objective-${o.id}" class="card p-6" data-id="${o.id}">
          <div class="flex justify-between items-start">
            <div>
              <h3 class="font-semibold text-lg flex items-center"><span class="health-dot ${h.dot}"></span>${o.name}</h3>
              <div class="flex items-center mt-2 gap-2">
                <span class="status-pill ${statusCls}">${o.status}</span>
                <input type="date" class="text-zone p-1 text-sm w-auto" value="${o.targetDate||''}" data-role="quick-date" />
              </div>
            </div>
            <div class="flex items-center gap-2">
              <button class="btn btn-ghost btn-sm" data-role="toggle-expand">${o.expanded?'Hide preview':'Show more'}</button>
              <button class="btn btn-ghost btn-sm" data-role="view-details">View Details</button>
              <button class="btn btn-outline btn-sm" data-role="edit">Edit</button>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
            <div class="preview-box">
              <div class="text-xs font-semibold text-slate-600 mb-1">KPI Goal</div>
              <div class="text-sm text-slate-700">${truncate(o.kpiGoal, o.expanded?1000:getPreviewLimit()) || '<span class=\'text-slate-400\'>Not set</span>'}</div>
            </div>
            <div class="preview-box">
              <div class="text-xs font-semibold text-slate-600 mb-1">Challenges</div>
              <div class="text-sm text-slate-700">${truncate(o.challenges, o.expanded?1000:getPreviewLimit()) || '<span class=\'text-slate-400\'>None</span>'}</div>
            </div>
          </div>
          ${o.expanded ? `
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
              <div class="preview-box">
                <div class="text-xs font-semibold text-slate-600 mb-1">Next Steps</div>
                <div class="text-sm text-slate-700">${o.nextSteps||'<span class=\'text-slate-400\'>Not specified</span>'}</div>
              </div>
              <div class="preview-box">
                <div class="text-xs font-semibold text-slate-600 mb-1">Links</div>
                ${o.s4Link ? `<a class="linkish text-sm" href="${o.s4Link}" target="_blank">Open S4</a>`: '<div class="text-sm text-slate-400">No links</div>'}
              </div>
            </div>` : ''}
        </div>`;
    }

    function renderObjectives(){
      const cur = $('#objectives-container');
      cur.innerHTML = state.objectives.map(objectiveCardHTML).join('') || '<p class="text-slate-500 text-center py-4">No active objectives.</p>';

      const past = $('#past-objectives-container');
      past.innerHTML = state.pastObjectives.map(objectiveCardHTML).join('');
      $('#no-past-objectives').classList.toggle('hidden', state.pastObjectives.length!==0);
      applyAutoResize(cur);
      applyAutoResize(past);
      autoSave();
    }

    function renderStakeholders(){
      const c = $('#stakeholders-container');
      c.innerHTML = state.stakeholders.map(s=>`
        <div id="stakeholder-${s.id}" class="flex items-center justify-between p-3 bg-slate-50 border" style="border-radius:2px;" data-id="${s.id}">
          <div>
            <p class="font-semibold">${s.name}</p>
            <p class="text-sm text-slate-500">${s.title}</p>
            <p class="text-xs text-slate-500">${s.email || ''}</p>
          </div>
          <button class="text-slate-400 hover:text-red-600" data-role="remove-stakeholder">&times;</button>
        </div>
      `).join('');

      const sel = $('#add-stakeholder-select');
      const unselected = mockContacts.filter(mc => !state.stakeholders.find(sc=>sc.id===mc.id));
      sel.innerHTML = '<option value="">+ Select a contact...</option>' + unselected.map(c=>`<option value="${c.id}">${c.name}</option>`).join('') + '<option value="new">Add New Stakeholder...</option>';
      autoSave();
    }

    function renderKPISection(){
      const root = document.getElementById('kpi-section');
      if (!root) return;
      const kpis = state.kpis || [];

      const kpiRows = kpis.map(k => {
        const type = KPI_TYPES.find(t=>t.key===k.typeKey) || { direction: 'up_is_good', unit: k.unit||'' };
        const isGood = type.direction === 'up_is_good' ? (k.delta||0) >= 0 : (k.delta||0) <= 0;
        const deltaSign = (k.delta||0) > 0 ? '+' : '';
        const unit = k.unit || type.unit || '';
        const deltaColor = isGood ? 'text-emerald-600' : 'text-rose-600';
        const chipBg = isGood ? 'bg-gradient-to-r from-emerald-600 to-emerald-500' : 'bg-gradient-to-r from-rose-600 to-rose-500';
        const linkedObj = k.objectiveId ? findObjectiveById(k.objectiveId) : null;
        const linkedHtml = linkedObj ? `<div class="text-xs text-slate-500">Linked: <button class="linkish" data-role="view-linked" data-oid="${linkedObj.id}">${linkedObj.name}</button></div>` : '';
        return `
          <div class="flex items-center justify-between border p-3 mb-2" data-id="${k.id}">
            <div class="min-w-0">
              <div class="font-semibold truncate">${k.name}</div>
              <div class="text-xs text-slate-500">Unit: ${unit}</div>
              ${linkedHtml}
            </div>
            <div class="flex items-center gap-4">
              <div class="text-right">
                <div class="text-xl font-bold">${k.value}<span class="text-sm ml-1">${unit}</span></div>
                <div class="text-xs ${deltaColor}"><span class="inline-block px-1 ${chipBg} text-white">${deltaSign}${k.delta}${unit ? ' ' + unit : ''}</span> vs prev</div>
              </div>
              <button class="text-slate-400 hover:text-red-600" data-role="remove-kpi">&times;</button>
            </div>
          </div>`;
      }).join('');

      const typeOptions = KPI_TYPES.map(t=>`<option value="${t.key}">${t.label}</option>`).join('');
      const objectiveOptions = [...(state.objectives||[]), ...(state.pastObjectives||[])]
        .map(o=>`<option value="${o.id}">${o.name}</option>`).join('');

      root.innerHTML = `
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-lg font-semibold">KPIs</h3>
          <button class="btn btn-success" id="kpi-add-btn">+ Add KPI</button>
        </div>
        <div class="space-y-2" id="kpi-list">${kpiRows || '<div class="text-slate-500 text-sm">No KPIs yet.</div>'}</div>
        <div class="mt-4 border p-3 space-y-3" id="kpi-creator">
          <div class="grid grid-cols-1 gap-3">
            <div>
              <label class="block text-sm font-medium mb-1">KPI Type</label>
              <select id="kpi-type" class="text-zone p-2 w-full">${typeOptions}</select>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Unit</label>
              <input id="kpi-unit" class="text-zone p-2 w-full bg-slate-50 text-slate-500" readonly />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Link Objective (optional)</label>
              <select id="kpi-obj" class="text-zone p-2 w-full"><option value="">‚Äî None ‚Äî</option>${objectiveOptions}</select>
            </div>
            <div class="grid grid-cols-3 gap-3">
              <div>
                <label class="block text-sm font-medium mb-1">Current Value</label>
                <input type="number" id="kpi-value" class="text-zone p-2 w-full" />
              </div>
              <div>
                <label class="block text-sm font-medium mb-1">Delta vs Prev</label>
                <input type="number" id="kpi-delta" class="text-zone p-2 w-full" />
              </div>
              <div class="flex items-end">
                <button id="kpi-create" class="btn btn-primary w-full">Create KPI</button>
              </div>
            </div>
          </div>
        </div>
      `;

      const typeSelect = document.getElementById('kpi-type');
      const unitInput = document.getElementById('kpi-unit');
      const applyUnit = () => {
        const t = KPI_TYPES.find(x=>x.key===typeSelect.value);
        unitInput.value = t ? t.unit : '';
      };
      typeSelect.addEventListener('change', applyUnit);
      applyUnit();

      document.getElementById('kpi-create').addEventListener('click', () => {
        const key = typeSelect.value;
        const t = KPI_TYPES.find(x=>x.key===key);
        if (!t) return;
        const v = Number(document.getElementById('kpi-value').value || 0);
        const d = Number(document.getElementById('kpi-delta').value || 0);
        const objSel = document.getElementById('kpi-obj');
        const objectiveId = objSel && objSel.value ? Number(objSel.value) : null;
        state.kpis = state.kpis || [];
        state.kpis.unshift({ id: Date.now()+Math.random(), typeKey: key, name: t.label, unit: t.unit, value: v, delta: d, objectiveId });
        renderKPISection();
        autoSave();
        showNotification('KPI created', 'success');
      });

      root.addEventListener('click', (e)=>{
        if (e.target && e.target.matches('[data-role="remove-kpi"]')){
          const id = Number(e.target.closest('[data-id]').dataset.id);
          state.kpis = (state.kpis||[]).filter(x=>x.id!==id);
          renderKPISection();
          autoSave();
        }
        if (e.target && e.target.matches('[data-role="view-linked"]')){
          const oid = Number(e.target.getAttribute('data-oid'));
          const obj = findObjectiveById(oid);
          if (obj) showObjectiveDetailsModal(obj);
        }
      });
    }

    function renderMetrics(){
      const wrap = $('#metrics-section');
      if (!wrap) return;
      const m = state.metrics;
      const active = (t) => m.periodType===t ? 'btn btn-primary btn-sm' : 'btn btn-outline btn-sm';
      const periodControls = (
        m.periodType === 'Month' ? `
          <div class="mt-3">
            <label class="block text-sm font-medium mb-1">Month</label>
            <input type="month" id="metrics-month" class="text-zone p-2 w-full" value="${m.month}">
          </div>` :
        m.periodType === 'Quarter' ? `
          <div class="mt-3 grid grid-cols-2 gap-2">
            <div>
              <label class="block text-sm font-medium mb-1">Quarter</label>
              <select id="metrics-quarter" class="text-zone p-2 w-full">
                ${[1,2,3,4].map(q=>`<option value="${q}" ${Number(m.quarter)===q?'selected':''}>Q${q}</option>`).join('')}
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Year</label>
              <input type="number" id="metrics-year" class="text-zone p-2 w-full" value="${m.year}">
            </div>
          </div>` : `
          <div class="mt-3">
            <label class="block text-sm font-medium mb-1">Year</label>
            <input type="number" id="metrics-year-only" class="text-zone p-2 w-full" value="${m.year}">
          </div>`
      );

      const items = (m.items||[]).map(it=>`
        <div class="flex items-center gap-2 p-2 border" style="border-radius:2px;" data-id="${it.id}">
          <input class="text-zone p-2 flex-1" placeholder="Metric name" value="${it.name||''}" data-role="metric-name" />
          <div class="flex items-center gap-1">
            <input type="number" class="text-zone p-2 w-20" value="${it.valuePercent||0}" min="0" max="999" step="1" data-role="metric-value" />
            <span class="text-slate-500">%</span>
          </div>
          <div class="flex items-center gap-1 text-emerald-700">
            <span class="text-slate-500">Œî</span>
            <input type="number" class="text-zone p-2 w-16" value="${it.deltaPercent||0}" step="1" data-role="metric-delta" />
            <span class="text-slate-500">%</span>
            <span class="text-xs text-slate-500">vs prev Q</span>
          </div>
          <button class="text-slate-400 hover:text-red-600" data-role="remove-metric" title="Remove">&times;</button>
        </div>
      `).join('');

      wrap.innerHTML = `
        <h3 class="text-lg font-semibold mb-3">Performance Metrics</h3>
        <div class="flex items-center gap-2">
          <button class="${active('Month')}" data-role="set-period-type" data-value="Month">Month</button>
          <button class="${active('Quarter')}" data-role="set-period-type" data-value="Quarter">Quarter</button>
          <button class="${active('Year')}" data-role="set-period-type" data-value="Year">Year</button>
        </div>
        ${periodControls}
        <div class="mt-4 space-y-2" id="metrics-items-list">
          ${items || '<div class="text-slate-500 text-sm">No metrics yet.</div>'}
        </div>
        <div class="mt-3">
          <button class="btn btn-success" data-role="add-metric">+ Add Metric</button>
        </div>
      `;
      autoSave();
    }

    function renderAll(){
      renderMissionGoals();
      renderValue();
      renderObjectives();
      renderStakeholders();
      renderMetrics();
      renderKPISection();
      syncTopControls();
    }

    function syncTopControls(){
      const ms = document.getElementById('mission-summary');
      if (ms && ms.value !== state.missionSummary) ms.value = state.missionSummary || '';
      const hs = document.getElementById('health-score');
      if (hs && hs.value !== state.planHealth) hs.value = state.planHealth || 'green';
    }

    // ---------- Event wiring ----------
    function setupEvents(){
            const app = $('#app');

       // Auto-resize on input
       document.addEventListener('input', (e)=>{ if (e.target && e.target.classList && e.target.classList.contains('text-area')) autoResizeTextarea(e.target); });

       // Global clicks
      app.addEventListener('click', (e)=>{
        const card = e.target.closest('[data-id]');

        if (e.target.id === 'add-mission-goal-btn'){
          showAddMissionGoalModal();
        }

        if (e.target.id === 'add-value-btn'){
          showAddValueRealizedModal();
        }

        if (e.target.id === 'add-objective-btn'){
          showAddObjectiveModal();
        }

        // Metrics actions
        if (e.target.matches('[data-role="set-period-type"]')){
          state.metrics.periodType = e.target.dataset.value;
          renderMetrics();
        }
        if (e.target.matches('[data-role="add-metric"]')){
          state.metrics.items.push({ id: Date.now()+Math.random(), name: 'New Metric', valuePercent: 0, deltaPercent: 0 });
          renderMetrics();
        }
        if (e.target && e.target.matches('[data-role="remove-metric"]')){
          const id = Number(e.target.closest('[data-id]').dataset.id);
          state.metrics.items = state.metrics.items.filter(m=>m.id!==id);
          renderMetrics();
        }

        // Value list actions
        if (e.target.matches('[data-role="remove-value"]')){
          const id = Number(e.target.closest('[data-id]').dataset.id);
          const i = state.valueRealized.findIndex(v=>v.id===id);
          if (i>-1){ state.valueRealized.splice(i,1); renderValue(); }
        }

        // Mission goal actions
        if (e.target.matches('[data-role="remove-goal"]')){
          const id = Number(card.dataset.id);
          const i = state.missionGoals.findIndex(g=>g.id===id);
          if (i>-1){ state.missionGoals.splice(i,1); renderMissionGoals(); }
        }
        if (e.target.matches('[data-role="add-cf"]')){
          const id = Number(card.dataset.id);
          const g = state.missionGoals.find(x=>x.id===id);
          if (!g.customFields) g.customFields = [];
          g.customFields.push({id:Date.now()+Math.random(), label:'New Field', value:''});
          renderMissionGoals();
        }
        if (e.target.matches('[data-role="remove-cf"]')){
          const id = Number(card.dataset.id);
          const fieldWrap = e.target.closest('[data-field-id]');
          const fid = Number(fieldWrap.dataset.fieldId);
          const g = state.missionGoals.find(x=>x.id===id);
          g.customFields = (g.customFields||[]).filter(f=>f.id!==fid);
          renderMissionGoals();
        }

        // Objective actions
        if (e.target.matches('[data-role="edit"]')){
          const id = Number(card.dataset.id);
          const o = state.objectives.find(x=>x.id===id) || state.pastObjectives.find(x=>x.id===id);
          if (o){ o.editing = true; renderObjectives(); }
        }
        if (e.target.matches('[data-role="cancel-edit"]')){
          const id = Number(card.dataset.id);
          const o = state.objectives.find(x=>x.id===id) || state.pastObjectives.find(x=>x.id===id);
          if (o){ o.editing = false; renderObjectives(); }
        }
        if (e.target.matches('[data-role="save-edit"]')){
          const id = Number(card.dataset.id);
          const wrap = card;
          const o = state.objectives.find(x=>x.id===id) || state.pastObjectives.find(x=>x.id===id);
          if (o){
            const oldStatus = o.status;
            o.name = $('[data-role="edit-name"]', wrap).value.trim() || o.name;
            o.status = $('[data-role="edit-status"]', wrap).value;
            o.targetDate = $('[data-role="edit-date"]', wrap).value;
            o.kpiGoal = $('[data-role="edit-kpi"]', wrap).value;
            o.challenges = $('[data-role="edit-challenges"]', wrap).value;
            o.nextSteps = $('[data-role="edit-steps"]', wrap).value;
            o.s4Link = $('[data-role="edit-link"]', wrap).value;
            o.editing = false;
            
            // Handle status change to Completed from current list only
            const currentIndex = state.objectives.findIndex(obj => obj.id === id);
            if (currentIndex > -1 && oldStatus !== 'Completed' && o.status === 'Completed') {
              const completedObj = state.objectives.splice(currentIndex, 1)[0];
              state.pastObjectives.unshift(completedObj);
              showNotification('Objective completed! Moved to Past Objectives.', 'success');
            }
            
            renderObjectives();
          }
        }
        if (e.target.matches('[data-role="toggle-expand"]')){
          const id = Number(card.dataset.id);
          const o = state.objectives.find(x=>x.id===id) || state.pastObjectives.find(x=>x.id===id);
          if (o){ o.expanded = !o.expanded; renderObjectives(); }
        }
        if (e.target.matches('[data-role="view-details"]')){
          const id = Number(card.dataset.id);
          const o = state.objectives.find(x=>x.id===id) || state.pastObjectives.find(x=>x.id===id);
          if (o){ showObjectiveDetailsModal(o); }
        }
        if (e.target.matches('[data-role="remove-stakeholder"]')){
          const id = Number(card.dataset.id);
          state.stakeholders = state.stakeholders.filter(s=>s.id!==id);
          renderStakeholders();
        }
      });

      // Global changes
      app.addEventListener('change', (e)=>{
        // quick date change on objective card
        if (e.target.matches('[data-role="quick-date"]')){
          const id = Number(e.target.closest('[data-id]').dataset.id);
          const o = state.objectives.find(x=>x.id===id);
          if (o){ 
            o.targetDate = e.target.value; 
            renderObjectives(); 
          }
        }
        
        // status change on objective card
        if (e.target.matches('[data-role="edit-status"]')){
          const id = Number(e.target.closest('[data-id]').dataset.id);
          const o = state.objectives.find(x=>x.id===id) || state.pastObjectives.find(x=>x.id===id);
          if (o && e.target.value === 'Completed'){
            const index = state.objectives.findIndex(obj => obj.id === id);
            if (index > -1) {
              const completedObj = state.objectives.splice(index, 1)[0];
              state.pastObjectives.unshift(completedObj);
              showNotification('Objective completed! Moved to Past Objectives.', 'success');
              renderObjectives();
            }
          }
        }

        // mission goal inline edits
        if (e.target.matches('[data-role="goal-title"]')){
          const id = Number(e.target.closest('[data-id]').dataset.id);
          const g = state.missionGoals.find(x=>x.id===id); if (g) g.title = e.target.value;
          autoSave();
        }
        if (e.target.matches('[data-role="goal-desc"]')){
          const id = Number(e.target.closest('[data-id]').dataset.id);
          const g = state.missionGoals.find(x=>x.id===id); if (g) g.description = e.target.value;
          autoSave();
        }
        if (e.target.matches('[data-role="cf-label"], [data-role="cf-value"]')){
          const id = Number(e.target.closest('[data-id]').dataset.id);
          const fid = Number(e.target.closest('[data-field-id]').dataset.fieldId);
          const g = state.missionGoals.find(x=>x.id===id);
          const f = (g.customFields||[]).find(y=>y.id===fid);
          if (f){
            if (e.target.dataset.role==='cf-label') f.label = e.target.value;
            if (e.target.dataset.role==='cf-value') f.value = e.target.value;
            autoSave();
          }
        }

        // Value edits
        if (e.target.closest('#value-container')){
          const wrap = e.target.closest('[data-id]');
          const id = wrap ? Number(wrap.dataset.id) : null;
          const it = state.valueRealized.find(v=>v.id===id);
          if (!it) return;
          if (e.target.dataset.role==='value-desc') it.description = e.target.value;
          if (e.target.dataset.role==='value-date') it.date = e.target.value;
          if (e.target.dataset.role==='value-link') it.link = e.target.value;
          if (e.target.classList.contains('value-type-select')) it.type = e.target.value;
          autoSave();
        }

        // Metrics edits
        if (e.target.id === 'metrics-month'){
          state.metrics.month = e.target.value;
          autoSave();
        }
        if (e.target.id === 'metrics-quarter'){
          state.metrics.quarter = Number(e.target.value);
          autoSave();
        }
        if (e.target.id === 'metrics-year'){
          state.metrics.year = Number(e.target.value);
          autoSave();
        }
        if (e.target.id === 'metrics-year-only'){
          state.metrics.year = Number(e.target.value);
          autoSave();
        }

        // Plan Details + Mission Summary
        if (e.target.id === 'health-score'){
          state.planHealth = e.target.value;
          autoSave();
        }
      });

      // Metric item live input updates
      app.addEventListener('input', (e)=>{
        if (e.target.closest('#metrics-items-list')){
          const row = e.target.closest('[data-id]');
          if (!row) return;
          const id = Number(row.dataset.id);
          const m = state.metrics.items.find(x=>x.id===id);
          if (!m) return;
          if (e.target.dataset.role === 'metric-name') m.name = e.target.value;
          if (e.target.dataset.role === 'metric-value') m.valuePercent = Number(e.target.value||0);
          if (e.target.dataset.role === 'metric-delta') m.deltaPercent = Number(e.target.value||0);
          autoSave();
        }
      });

      // Stakeholder add select
      $('#add-stakeholder-select').addEventListener('change', (e)=>{
        const id = e.target.value;
        if (id === 'new') {
          // Show modal for new stakeholder
          showNewStakeholderModal();
          e.target.value = '';
        } else if (id) {
          const pick = mockContacts.find(c=>c.id===Number(id));
          if (pick && !state.stakeholders.find(s=>s.id===pick.id)) state.stakeholders.push(pick);
          renderStakeholders();
          e.target.value = '';
        }
      });
      
      // Product filter change - show suggested KPIs
      $('#filter-products').addEventListener('change', (e) => {
        const selectedProduct = e.target.value;
        const container = $('#suggested-objectives-container');
        const list = $('#suggested-objectives-list');
        
        if (selectedProduct && productKPIs[selectedProduct]) {
          list.innerHTML = productKPIs[selectedProduct].map(kpi => 
            `<span class="chip bg-emerald-100 text-emerald-800 border-emerald-200">${kpi}</span>`
          ).join('');
          container.classList.remove('hidden');
        } else {
          container.classList.add('hidden');
        }
      });
      
      // Exports
      $('#export-pdf-btn').addEventListener('click', exportToPDF);
      $('#export-excel-btn').addEventListener('click', exportToExcel);

      // Reflow on resize
      window.addEventListener('resize', () => {
        applyAutoResize();
        renderObjectives();
      });
    }

    // ---------- PDF Export ----------
    async function exportToPDF() {
      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('l', 'mm', 'a4');
        
        // Show loading state
        const btn = $('#export-pdf-btn');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<svg class="animate-spin h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Generating...';
        btn.disabled = true;
        
        // Capture the main content
        const element = $('#app');
        const canvas = await html2canvas(element, {
          scale: 2,
          useCORS: true,
          allowTaint: true,
          backgroundColor: '#f1f5f9'
        });
        
        const imgData = canvas.toDataURL('image/png');
        const imgWidth = 297; // A4 landscape width in mm
        const pageHeight = 210; // A4 landscape height in mm
        const imgHeight = (canvas.height * imgWidth) / canvas.width;
        let heightLeft = imgHeight;
        let position = 0;
        
        // Add first page
        doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;
        
        // Add additional pages if content is longer than one page
        while (heightLeft >= 0) {
          position = heightLeft - imgHeight;
          doc.addPage();
          doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
          heightLeft -= pageHeight;
        }
        
        // Save the PDF
        doc.save('customer-success-plan.pdf');
        
        // Reset button
        btn.innerHTML = originalText;
        btn.disabled = false;
        
        // Show success message
        showNotification('PDF generated successfully!', 'success');
      } catch (error) {
        console.error('PDF generation failed:', error);
        showNotification('PDF generation failed. Please try again.', 'error');
        
        // Reset button
        const btn = $('#export-pdf-btn');
        btn.innerHTML = 'Export PDF';
        btn.disabled = false;
      }
    }

    // ---------- Excel Export ----------
    function exportToExcel(){
      try {
        const wb = XLSX.utils.book_new();
        
        const m = state.metrics;
        const periodLabel = (m.periodType==='Quarter') ? `Q${m.quarter} ${m.year}` : (m.periodType==='Month' ? m.month : `${m.year}`);
        const planOverview = [{ MissionSummary: state.missionSummary || '', Health: state.planHealth || 'green', PeriodType: m.periodType, Period: periodLabel }];

        const missionGoalsData = state.missionGoals.map(g=>({
          Title: g.title,
          Description: g.description,
          CustomFields: (g.customFields||[]).map(cf=>`${cf.label}: ${cf.value}`).join(' | ')
        }));
        const stakeholdersData = state.stakeholders.map(s=>({ Name: s.name, Title: s.title, Email: s.email||'' }));
        const objectivesData = [
          ...state.objectives.map(o=>({ Type:'Current', Name:o.name, Status:o.status, TargetDate:o.targetDate, KPIGoal:o.kpiGoal, Challenges:o.challenges, NextSteps:o.nextSteps, Link:o.s4Link })),
          ...state.pastObjectives.map(o=>({ Type:'Past', Name:o.name, Status:o.status, TargetDate:o.targetDate, KPIGoal:o.kpiGoal, Challenges:o.challenges, NextSteps:o.nextSteps, Link:o.s4Link }))
        ];
        const valueData = state.valueRealized.map(v=>({ Type:v.type, Description:v.description, Date:v.date, Link:v.link }));
        const metricsData = (m.items||[]).map(x=>({ PeriodType:m.periodType, Period: periodLabel, Metric:x.name, ValuePercent:x.valuePercent, DeltaVsPrevQ:x.deltaPercent }));
        
        const addSheet = (data, name) => {
          const ws = XLSX.utils.json_to_sheet(data.length?data:[{}]);
          XLSX.utils.book_append_sheet(wb, ws, name);
        };
        addSheet(planOverview, 'Plan Overview');
        addSheet(missionGoalsData, 'Mission Goals');
        addSheet(objectivesData, 'Objectives');
        addSheet(valueData, 'Value Realized');
        addSheet(stakeholdersData, 'Stakeholders');
        addSheet(metricsData, 'Metrics');
        
        XLSX.writeFile(wb, 'customer-success-plan.xlsx');
        showNotification('Excel exported successfully!', 'success');
      } catch (err) {
        console.error('Excel export failed', err);
        showNotification('Excel export failed. Please try again.', 'error');
      }
    }
    
    // View Objective Details Modal
    function showObjectiveDetailsModal(objective) {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-panel p-6 w-[700px] max-w-[90vw] max-h-[90vh] overflow-y-auto">
          <div class="flex justify-between items-start mb-4">
            <h3 class="text-lg font-semibold">Objective Details</h3>
            <button id="close-details-modal" class="text-slate-400 hover:text-slate-600">&times;</button>
          </div>
          
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium mb-1 text-slate-600">Objective Name</label>
              <p class="text-lg font-semibold">${objective.name}</p>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium mb-1 text-slate-600">Status</label>
                <span class="status-pill ${pillClass(objective.status)}">${objective.status}</span>
              </div>
              <div>
                <label class="block text-sm font-medium mb-1 text-slate-600">Target Date</label>
                <p>${objective.targetDate || 'Not set'}</p>
              </div>
            </div>
            
            <div>
              <label class="block text-sm font-medium mb-1 text-slate-600">KPI Goal</label>
                             <div class="bg-slate-50 border border-slate-200 p-3" style="border-radius:2px;">
                 <p>${objective.kpiGoal || 'Not specified'}</p>
               </div>
            </div>
            
            <div>
              <label class="block text-sm font-medium mb-1 text-slate-600">Challenges</label>
                             <div class="bg-slate-50 border border-slate-200 p-3" style="border-radius:2px;">
                 <p>${objective.challenges || 'None identified'}</p>
               </div>
            </div>
            
            <div>
              <label class="block text-sm font-medium mb-1 text-slate-600">Next Steps</label>
                             <div class="bg-slate-50 border border-slate-200 p-3" style="border-radius:2px;">
                 <p>${objective.nextSteps || 'Not specified'}</p>
               </div>
            </div>
            
            ${objective.s4Link ? `
              <div>
                <label class="block text-sm font-medium mb-1 text-slate-600">External Links</label>
                <a href="${objective.s4Link}" target="_blank" class="linkish">${objective.s4Link}</a>
              </div>
            ` : ''}
          </div>
          
          <div class="flex justify-end mt-6">
            <button id="close-details-modal-2" class="btn btn-outline">Close</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // Event handlers
      modal.querySelector('#close-details-modal').addEventListener('click', () => modal.remove());
      modal.querySelector('#close-details-modal-2').addEventListener('click', () => modal.remove());
    }
    
    // Add Objective Modal
    function showAddObjectiveModal() {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-panel p-6 w-[600px] max-w-[90vw] max-h-[90vh] overflow-y-auto">
          <h3 class="text-lg font-semibold mb-4">Add New Objective</h3>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium mb-1">Objective Name</label>
              <select id="new-objective-name" class="text-zone p-2 w-full">
                <option value="">Select an objective...</option>
                ${objectiveOptions.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                <option value="custom">Create a new objective...</option>
              </select>
            </div>
            <div id="custom-objective-input" class="hidden">
              <label class="block text-sm font-medium mb-1">Custom Objective Name</label>
              <input type="text" id="custom-objective-text" class="text-zone p-2 w-full" placeholder="Enter custom objective name">
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Target Date</label>
              <input type="date" id="new-objective-date" class="text-zone p-2 w-full">
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Objective Goal</label>
              <textarea id="new-objective-goal" class="text-zone text-area p-3 w-full" rows="4" placeholder="Describe the objective goal..."></textarea>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Challenges</label>
              <textarea id="new-objective-challenges" class="text-zone text-area p-3 w-full" rows="3" placeholder="Describe any challenges..."></textarea>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Next Steps</label>
              <textarea id="new-objective-steps" class="text-zone text-area p-3 w-full" rows="3" placeholder="Describe next steps..."></textarea>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">S4 / External Link</label>
              <input type="text" id="new-objective-link" class="text-zone p-2 w-full" placeholder="https://">
            </div>
          </div>
          <div class="flex justify-end gap-3 mt-6">
            <button id="cancel-new-objective" class="btn btn-ghost">Cancel</button>
            <button id="save-new-objective" class="btn btn-primary">Save Objective</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // Show/hide custom objective input
      const nameSelect = modal.querySelector('#new-objective-name');
      const customInput = modal.querySelector('#custom-objective-input');
      
      nameSelect.addEventListener('change', () => {
        if (nameSelect.value === 'custom') {
          customInput.classList.remove('hidden');
        } else {
          customInput.classList.add('hidden');
        }
      });
      applyAutoResize(modal);
      
      // Event handlers
      modal.querySelector('#cancel-new-objective').addEventListener('click', () => modal.remove());
      modal.querySelector('#save-new-objective').addEventListener('click', () => {
        const nameSelect = modal.querySelector('#new-objective-name');
        const customText = modal.querySelector('#custom-objective-text');
        const date = modal.querySelector('#new-objective-date').value;
        const goal = modal.querySelector('#new-objective-goal').value.trim();
        
        let objectiveName = nameSelect.value;
        if (objectiveName === 'custom') {
          objectiveName = customText.value.trim();
        }
        
        if (objectiveName && goal) {
          const newObjective = {
            id: Date.now(),
            name: objectiveName,
            targetDate: date,
            status: 'Not Started',
            kpiGoal: goal,
            challenges: modal.querySelector('#new-objective-challenges').value.trim(),
            nextSteps: modal.querySelector('#new-objective-steps').value.trim(),
            s4Link: modal.querySelector('#new-objective-link').value.trim(),
            editing: false,
            expanded: false
          };
          
          state.objectives.unshift(newObjective);
          renderObjectives();
          modal.remove();
          showNotification('New objective added successfully!', 'success');
        } else {
          showNotification('Please fill in the required fields.', 'error');
        }
      });
    }
    
    // Add Mission Goal Modal
    function showAddMissionGoalModal() {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-panel w-[600px] max-w-[90vw]">
          <div class="modal-header">
            <h3 class="text-lg font-semibold">Add Mission Goal</h3>
          </div>
          <div class="modal-body space-y-4">
            <div>
              <label class="block text-sm font-medium mb-1">Title</label>
              <input type="text" id="mg-title" class="text-zone p-2 w-full" placeholder="Goal title">
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Description</label>
              <textarea id="mg-desc" class="text-zone text-area p-3 w-full" rows="3" placeholder="Goal description..."></textarea>
            </div>
            <div>
              <label class="block text-sm font-medium mb-2">Custom Fields</label>
              <div id="mg-fields" class="space-y-2"></div>
              <button id="mg-add-field" class="btn btn-ghost mt-2">+ Add Custom Field</button>
            </div>
          </div>
          <div class="modal-footer">
            <button id="mg-cancel" class="btn btn-ghost">Cancel</button>
            <button id="mg-save" class="btn btn-success">Save Goal</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      applyAutoResize(modal);
      const fieldsContainer = modal.querySelector('#mg-fields');
      const addFieldRow = () => {
        const row = document.createElement('div');
        row.className = 'flex items-center gap-2';
        row.setAttribute('data-field-row','');
        row.innerHTML = `
          <input class="text-zone p-2 text-xs font-semibold" placeholder="Field name" data-role="label" />
          <input class="text-zone p-2 text-xs flex-1" placeholder="Value or https://link" data-role="value" />
          <button class="text-slate-400 hover:text-red-600" title="Remove">&times;</button>
        `;
        row.querySelector('button').addEventListener('click', ()=> row.remove());
        fieldsContainer.appendChild(row);
      };
      modal.querySelector('#mg-add-field').addEventListener('click', addFieldRow);
      modal.querySelector('#mg-cancel').addEventListener('click', () => modal.remove());
      modal.querySelector('#mg-save').addEventListener('click', () => {
        const title = modal.querySelector('#mg-title').value.trim() || 'New Goal';
        const desc = modal.querySelector('#mg-desc').value.trim();
        const customFields = [...modal.querySelectorAll('[data-field-row]')].map((row) => {
          const label = row.querySelector('[data-role="label"]').value.trim() || 'Field';
          const value = row.querySelector('[data-role="value"]').value.trim();
          return { id: Date.now()+Math.random(), label, value };
        });
        state.missionGoals.push({ id: Date.now(), title: title, description: desc, customFields });
        renderMissionGoals();
        modal.remove();
        showNotification('Mission goal added!', 'success');
      });
    }

    // Add Value Realized Modal
    function showAddValueRealizedModal() {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-panel w-[600px] max-w-[90vw]">
          <div class="modal-header">
            <h3 class="text-lg font-semibold">Add Value Realized</h3>
          </div>
          <div class="modal-body space-y-4">
            <div>
              <label class="block text-sm font-medium mb-1">Type</label>
              <select id="vr-type" class="text-zone p-2 w-full">
                ${valueOptions.map(opt=>`<option>${opt}</option>`).join('')}
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Description</label>
              <textarea id="vr-desc" class="text-zone text-area p-3 w-full" rows="3" placeholder="Describe the value realized..."></textarea>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
              <div>
                <label class="block text-sm font-medium mb-1">Date Realized</label>
                <input type="date" id="vr-date" class="text-zone p-2 w-full" />
              </div>
              <div>
                <label class="block text-sm font-medium mb-1">Reference Link</label>
                <input type="text" id="vr-link" class="text-zone p-2 w-full" placeholder="https://" />
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button id="vr-cancel" class="btn btn-ghost">Cancel</button>
            <button id="vr-save" class="btn btn-success">Save</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      applyAutoResize(modal);
      modal.querySelector('#vr-cancel').addEventListener('click', ()=> modal.remove());
      modal.querySelector('#vr-save').addEventListener('click', ()=>{
        const type = modal.querySelector('#vr-type').value;
        const description = modal.querySelector('#vr-desc').value.trim();
        const date = modal.querySelector('#vr-date').value;
        const link = modal.querySelector('#vr-link').value.trim();
        state.valueRealized.push({ id: Date.now(), type, description, date, link });
        renderValue();
        modal.remove();
        showNotification('Value realized item added!', 'success');
      });
    }

    // New Stakeholder Modal
    function showNewStakeholderModal() {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-panel p-6 w-96 max-w-md mx-4">
          <h3 class="text-lg font-semibold mb-4">Add New Stakeholder</h3>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium mb-1">Name</label>
              <input type="text" id="new-stakeholder-name" class="text-zone p-2 w-full" placeholder="Enter name">
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Title</label>
              <input type="text" id="new-stakeholder-title" class="text-zone p-2 w-full" placeholder="Enter title">
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Email</label>
              <input type="email" id="new-stakeholder-email" class="text-zone p-2 w-full" placeholder="name@example.com">
            </div>
          </div>
          <div class="flex justify-end gap-3 mt-6">
            <button id="cancel-new-stakeholder" class="btn btn-ghost">Cancel</button>
            <button id="save-new-stakeholder" class="btn btn-primary">Save</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // Event handlers
      modal.querySelector('#cancel-new-stakeholder').addEventListener('click', () => modal.remove());
      modal.querySelector('#save-new-stakeholder').addEventListener('click', () => {
        const name = modal.querySelector('#new-stakeholder-name').value.trim();
        const title = modal.querySelector('#new-stakeholder-title').value.trim();
        const email = modal.querySelector('#new-stakeholder-email').value.trim();
        
        if (name && title && email) {
          const newStakeholder = {
            id: Date.now() + Math.random(),
            name: name,
            title: title,
            email: email
          };
          state.stakeholders.push(newStakeholder);
          renderStakeholders();
          modal.remove();
          showNotification('New stakeholder added successfully!', 'success');
        }
      });
    }
    
    // Notification system
    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = `fixed top-4 right-4 p-4 shadow-lg z-50 ${
        type === 'success' ? 'bg-green-500 text-white' : 
        type === 'error' ? 'bg-red-500 text-white' : 
        'bg-blue-500 text-white'
      }`;
      notification.textContent = message;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.remove();
      }, 3000);
    }
    
    // ---------- Data Persistence ----------
    function saveToLocalStorage() {
      try {
        localStorage.setItem('customerSuccessPlan', JSON.stringify(state));
      } catch (error) {
        console.warn('Could not save to localStorage:', error);
      }
    }
    
         function loadFromLocalStorage() {
       try {
         const saved = localStorage.getItem('customerSuccessPlan');
         if (saved) {
           const parsed = JSON.parse(saved);
           Object.assign(state, parsed);
           // Ensure metrics shape exists after upgrades
           if (!state.metrics) {
             state.metrics = {
               periodType: 'Quarter',
               month: new Date().toISOString().slice(0,7),
               quarter: Math.floor((new Date().getMonth())/3)+1,
               year: new Date().getFullYear(),
               items: []
             };
           }
           if (!state.kpis) state.kpis = [];
           if (typeof state.planHealth === 'undefined') state.planHealth = 'green';
           if (typeof state.missionSummary === 'undefined') state.missionSummary = '';
         }
       } catch (error) {
         console.warn('Could not load from localStorage:', error);
       }
     }
    
    // Auto-save on any state change
    function autoSave() {
      saveToLocalStorage();
    }
    
    // ---------- Init ----------
    loadFromLocalStorage();
    // Demo: ensure seeded KPIs are linked to objectives for showcase if not already
    (function(){
      const ids = [...(state.objectives||[]).map(o=>o.id), ...(state.pastObjectives||[]).map(o=>o.id)];
      if ((state.kpis||[]).length && ids.length) {
        state.kpis = state.kpis.map((k, i) => k.objectiveId ? k : ({...k, objectiveId: ids[i % ids.length]}));
      }
    })();
    renderAll();
    setupEvents();
    applyAutoResize();
    syncTopControls();
    
    // Set up auto-save for all state changes
    const originalRenderAll = renderAll;
    renderAll = function() {
      originalRenderAll();
      autoSave();
      applyAutoResize();
    };
  </script>
<div data-netlify-deploy-id="689c270a4d10af0008374ef2" data-netlify-site-id="0c217ff5-db63-4bc3-8e7c-d7c1212e5343" data-vcs="github" style="position:fixed">
  
  <script async src="/.netlify/scripts/cdp"></script>
</div></body>
</html>
