<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Customer Success Plan - Responsive Platform</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root { 
      --ink: #0f172a; 
      --ink-2: #334155; 
      --ink-3: #64748b;
      --responsive-blue: #0066CC;
      --responsive-dark: #001F3F;
      --primary-gradient: linear-gradient(135deg, #0066CC 0%, #0052A3 100%);
      --success-gradient: linear-gradient(135deg, #10b981 0%, #059669 100%);
      --kpi-gradient: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
      --danger-gradient: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    }
    
    * { box-sizing: border-box; }
    
    body { 
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; 
      background: #f8fafc; 
      color: var(--ink); 
      line-height: 1.5;
    }

    /* Typography */
    h1 { font-size: 2.25rem; font-weight: 700; line-height: 1.2; letter-spacing: -0.025em; }
    h2 { font-size: 1.875rem; font-weight: 700; line-height: 1.3; letter-spacing: -0.025em; }
    h3 { font-size: 1.25rem; font-weight: 600; line-height: 1.4; }
    .text-xs { font-size: 0.75rem; }
    .text-sm { font-size: 0.875rem; }
    .text-base { font-size: 1rem; }
    .text-lg { font-size: 1.125rem; }
    .text-xl { font-size: 1.25rem; }
    .text-2xl { font-size: 1.5rem; }
    .text-3xl { font-size: 1.875rem; }

    /* Text zones */
    .text-zone { 
      width: 100%; 
      border-radius: 0; 
      border: 1px solid #e2e8f0; 
      background: #fff; 
      box-shadow: none; 
      transition: border-color .15s, box-shadow .15s; 
      outline: none; 
    }
    .text-zone:focus { 
      border-color: var(--responsive-blue); 
      box-shadow: 0 0 0 3px rgba(0,102,204,0.1); 
    }
    .text-zone:disabled {
      background: #f9fafb;
      color: #6b7280;
      cursor: not-allowed;
    }
    .text-area { 
      resize: none; 
      min-height: 3rem; 
      overflow: hidden; 
      line-height: 1.6; 
    }

    /* Cards */
    .card { 
      background: #fff; 
      border-radius: 0; 
      box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
      border: 1px solid #e5e7eb; 
    }

    /* Buttons */
    .btn { 
      display: inline-flex; 
      align-items: center; 
      gap: .5rem; 
      font-weight: 600; 
      border-radius: 0; 
      padding: .625rem 1.25rem; 
      border: 1px solid transparent; 
      transition: all .15s ease; 
      cursor: pointer;
      font-size: 0.875rem;
      white-space: nowrap;
    }
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .btn-sm { 
      padding: .375rem .875rem; 
      font-size: .875rem; 
    }
    .btn-primary { 
      background: var(--primary-gradient);
      color: #fff; 
      border: none;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .btn-primary:hover:not(:disabled) { 
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      transform: translateY(-1px);
    }
    .btn-success { 
      background: var(--success-gradient);
      color: #fff;
      border: none;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .btn-success:hover:not(:disabled) { 
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      transform: translateY(-1px);
    }
    .btn-kpi {
      background: var(--kpi-gradient);
      color: #fff;
      border: none;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .btn-kpi:hover:not(:disabled) {
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      transform: translateY(-1px);
    }
    .btn-outline { 
      background: #fff; 
      color: #374151; 
      border: 1px solid #d1d5db; 
    }
    .btn-outline:hover:not(:disabled) { 
      background: #f9fafb; 
      border-color: #9ca3af;
    }
    .btn-ghost { 
      background: transparent; 
      color: #6b7280; 
      border: none;
    }
    .btn-ghost:hover:not(:disabled) { 
      background: #f3f4f6; 
      color: #374151;
    }

    /* Read-only sections */
    .section-readonly {
      position: relative;
    }
    .section-readonly .edit-overlay {
      position: absolute;
      top: 0;
      right: 0;
      padding: 1rem;
    }
    .section-readonly.editing .edit-overlay {
      display: none;
    }
    .readonly-content {
      color: #374151;
      padding: 0.75rem;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      min-height: 3rem;
    }

    /* Status pills */
    .status-pill { 
      font-size: .75rem; 
      font-weight: 600; 
      padding: .25rem .75rem; 
      border-radius: 0; 
      display: inline-flex; 
      align-items: center; 
    }
    .status-green { background: #10b981; color: #fff; }
    .status-yellow { background: #f59e0b; color: #fff; }
    .status-red { background: #ef4444; color: #fff; }
    .status-gray { background: #6b7280; color: #fff; }
    .status-cyan { background: #06b6d4; color: #fff; }

    /* KPI display */
    .kpi-card {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      padding: 1rem;
      position: relative;
    }
    .kpi-value {
      font-size: 2rem;
      font-weight: 700;
      line-height: 1;
      color: #111827;
    }
    .kpi-unit {
      font-size: 1rem;
      font-weight: 400;
      color: #6b7280;
      margin-left: 0.25rem;
    }
    .kpi-delta {
      font-size: 0.875rem;
      font-weight: 600;
      padding: 0.25rem 0.5rem;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
    }
    .kpi-delta.positive {
      background: #d1fae5;
      color: #065f46;
    }
    .kpi-delta.negative {
      background: #fee2e2;
      color: #991b1b;
    }
    .kpi-arrow {
      width: 0.75rem;
      height: 0.75rem;
    }

    /* Period switcher */
    .period-switcher {
      display: inline-flex;
      background: #f3f4f6;
      border: 1px solid #e5e7eb;
      padding: 0.25rem;
    }
    .period-switcher button {
      padding: 0.375rem 0.75rem;
      font-size: 0.875rem;
      font-weight: 500;
      background: transparent;
      border: none;
      color: #6b7280;
      cursor: pointer;
      transition: all 0.15s;
    }
    .period-switcher button.active {
      background: #fff;
      color: var(--responsive-blue);
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }

    /* Modal */
    .modal-overlay { 
      position: fixed; 
      inset: 0; 
      background: rgba(0,0,0,0.5); 
      backdrop-filter: blur(4px); 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      z-index: 50; 
    }
    .modal-panel { 
      border-radius: 0; 
      box-shadow: 0 20px 40px rgba(0,0,0,0.15); 
      max-height: 90vh; 
      overflow-y: auto; 
      background: #ffffff; 
      position: relative;
    }
    .modal-header { 
      padding: 1.5rem; 
      border-bottom: 1px solid #e5e7eb; 
      background: #f9fafb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .modal-body { 
      padding: 1.5rem; 
    }
    .modal-footer { 
      padding: 1rem 1.5rem; 
      border-top: 1px solid #e5e7eb; 
      display: flex; 
      justify-content: flex-end; 
      gap: 1rem; 
      background: #f9fafb;
    }
    .modal-close {
      width: 2rem;
      height: 2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: none;
      font-size: 1.5rem;
      color: #6b7280;
      cursor: pointer;
      transition: color 0.15s;
    }
    .modal-close:hover {
      color: #374151;
    }

    /* Helpers */
    .health-dot { 
      width: 0.625rem; 
      height: 0.625rem; 
      border-radius: 9999px; 
      display: inline-block; 
      margin-right: 0.5rem; 
    }
    .linkish { 
      text-decoration: underline; 
      color: var(--responsive-blue); 
      cursor: pointer;
    }
    .linkish:hover { 
      color: #0052A3; 
    }

    /* Custom field inputs */
    .custom-field-input {
      min-width: 400px;
    }

    /* Loading spinner */
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .animate-spin {
      animation: spin 1s linear infinite;
    }
  </style>
</head>
<body>
  <div id="app" class="max-w-screen-xl mx-auto p-4 sm:p-6 lg:p-8">
    <header class="mb-10 p-8 bg-gradient-to-r from-blue-900 via-blue-800 to-blue-700 text-white flex justify-between items-center">
      <div>
        <h1 class="text-4xl font-bold">Customer Success Plan</h1>
        <p class="text-blue-100 mt-2">Responsive Platform Implementation â€¢ Last updated: <span id="last-updated-date"></span></p>
      </div>
      <div class="flex items-center gap-3">
        <button id="export-excel-btn" class="btn btn-outline">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M13 7h-2v4H9v2h2v4h2v-4h4v-2h-4V7zm-8 6h4v2H5v-2z"/></svg>
          Export Excel
        </button>
        <button id="export-pdf-btn" class="btn btn-primary flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V7.414A2 2 0 0015.414 6L12 2.586A2 2 0 0010.586 2H6zm5 6a1 1 0 10-2 0v3.586l-1.293-1.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V8z" clip-rule="evenodd" /></svg>
          Export PDF
        </button>
      </div>
    </header>

    <!-- Period Switcher (Global) -->
    <div class="mb-6 flex justify-center">
      <div class="period-switcher">
        <button data-period="Month">Month</button>
        <button data-period="Quarter" class="active">Quarter</button>
        <button data-period="Year">Year</button>
      </div>
      <label class="ml-4 flex items-center gap-2">
        <input type="checkbox" id="compare-period" class="rounded-0">
        <span class="text-sm text-gray-600">Compare vs previous period</span>
      </label>
    </div>

    <!-- Mission Summary -->
    <section class="card mb-6 p-6 section-readonly" id="mission-summary-section">
      <div class="edit-overlay">
        <button class="btn btn-ghost btn-sm" data-edit="mission-summary">Edit</button>
      </div>
      <h2 class="text-2xl font-bold mb-4">Mission Summary</h2>
      <div id="mission-summary-display" class="readonly-content"></div>
      <div id="mission-summary-edit" class="hidden">
        <textarea id="mission-summary-input" class="text-zone text-area p-3" rows="3"></textarea>
        <div class="mt-3 flex gap-2">
          <button class="btn btn-primary btn-sm" data-save="mission-summary">Save</button>
          <button class="btn btn-ghost btn-sm" data-cancel="mission-summary">Cancel</button>
        </div>
      </div>
    </section>

    <!-- Mission Goals -->
    <section class="card mb-10 p-6 section-readonly" id="mission-goals-section">
      <div class="edit-overlay">
        <button class="btn btn-ghost btn-sm" data-edit="mission-goals">Edit</button>
      </div>
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold">Mission Goals</h2>
      </div>
      <div id="mission-goals-display" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
      <div id="mission-goals-edit" class="hidden">
        <div id="mission-goals-container" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
        <div class="mt-4 flex gap-2">
          <button class="btn btn-success btn-sm" id="add-mission-goal-btn">+ Add Goal</button>
          <button class="btn btn-primary btn-sm" data-save="mission-goals">Save All</button>
          <button class="btn btn-ghost btn-sm" data-cancel="mission-goals">Cancel</button>
        </div>
      </div>
    </section>

    <main class="grid grid-cols-1 lg:grid-cols-4 gap-8">
      <!-- Left -->
      <div class="lg:col-span-3 space-y-8">
        <!-- Value Realized -->
        <section id="value-realized" class="card p-6 section-readonly">
          <div class="edit-overlay">
            <button class="btn btn-ghost btn-sm" data-edit="value-realized">Edit</button>
          </div>
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold">Value Realized</h2>
          </div>
          <div id="value-display" class="space-y-4"></div>
          <div id="value-edit" class="hidden">
            <div id="value-container" class="space-y-4"></div>
            <div class="mt-4 flex gap-2">
              <button class="btn btn-success btn-sm" id="add-value-btn">+ Add Value</button>
              <button class="btn btn-primary btn-sm" data-save="value-realized">Save All</button>
              <button class="btn btn-ghost btn-sm" data-cancel="value-realized">Cancel</button>
            </div>
          </div>
        </section>

        <!-- Current Objectives -->
        <section id="current-objectives" class="card p-6">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold">Current Objectives</h2>
            <button id="add-objective-btn" class="btn btn-primary">+ Add Objective</button>
          </div>
          <div id="objectives-container" class="space-y-6"></div>
        </section>

        <!-- Past Objectives -->
        <section id="past-objectives" class="card p-6">
          <h2 class="text-2xl font-bold mb-4">Past Objectives Achieved</h2>
          <div id="past-objectives-container" class="space-y-6"></div>
          <div id="no-past-objectives" class="hidden text-center py-10 px-4 text-slate-500">Completed objectives will appear here.</div>
        </section>
      </div>

      <!-- Right -->
      <div class="lg:col-span-1 space-y-8">
        <section class="card p-6">
          <h3 class="text-lg font-semibold mb-3">Plan Details</h3>
          <label class="block text-sm font-medium mb-1">Overall Health</label>
          <select id="health-score" class="text-zone p-2">
            <option value="green">ðŸŸ¢ On Track</option>
            <option value="yellow">ðŸŸ¡ Needs Attention</option>
            <option value="red">ðŸ”´ At Risk</option>
          </select>
        </section>

        <section class="card p-6">
          <h3 class="text-lg font-semibold mb-3">Key Stakeholders</h3>
          <div id="stakeholders-container" class="space-y-3 mb-3"></div>
          <select id="add-stakeholder-select" class="text-zone p-2">
            <option value="">+ Add a contact...</option>
            <option value="new">Add New Stakeholder...</option>
          </select>
        </section>

        <section class="card p-6">
          <h3 class="text-lg font-semibold mb-3">Responsive Platform Products</h3>
          <div class="space-y-2 text-sm">
            <div class="flex items-center gap-2">
              <span class="w-2 h-2 bg-green-500 rounded-full"></span>
              <span>Content Intelligence</span>
            </div>
            <div class="flex items-center gap-2">
              <span class="w-2 h-2 bg-green-500 rounded-full"></span>
              <span>Sales Coach AI</span>
            </div>
            <div class="flex items-center gap-2">
              <span class="w-2 h-2 bg-blue-500 rounded-full"></span>
              <span>Analytics Suite (Trial)</span>
            </div>
          </div>
        </section>
      </div>
    </main>
  </div>

  <script>
    // ---------- Data ----------
    const KPI_TYPES = [
      { key: 'content_utilization', label: 'Content Utilization', unit: '%', higherIsBetter: true },
      { key: 'obsolete_content', label: 'Obsolete Content', unit: '%', higherIsBetter: false },
      { key: 'avg_response_time', label: 'Avg Response Time', unit: 's', higherIsBetter: false },
      { key: 'content_accuracy', label: 'Content Accuracy', unit: '%', higherIsBetter: true },
      { key: 'adoption_rate', label: 'Adoption Rate', unit: '%', higherIsBetter: true },
      { key: 'time_to_content', label: 'Time to Find Content', unit: 's', higherIsBetter: false },
      { key: 'ai_confidence', label: 'AI Confidence Score', unit: '%', higherIsBetter: true },
      { key: 'engagement_score', label: 'Engagement Score', unit: 'pts', higherIsBetter: true }
    ];

    const mockContacts = [
      { id: 1, name: 'Sarah Chen', title: 'VP Sales', email: 'sarah.chen@techcorp.com' },
      { id: 2, name: 'Michael Rodriguez', title: 'Sales Director', email: 'michael.r@techcorp.com' },
      { id: 3, name: 'Jennifer Park', title: 'Head of Enablement', email: 'jennifer.p@techcorp.com' },
      { id: 4, name: 'David Thompson', title: 'CRO', email: 'david.t@techcorp.com' }
    ];

    // State with Responsive Platform-specific data
    const state = {
      currentPeriod: 'Quarter',
      comparePrevious: false,
      missionSummary: 'Transform TechCorp\'s sales organization with Responsive\'s AI-powered content intelligence platform, enabling 200+ sales reps to find the right content 75% faster, increase win rates by 15%, and drive $5M in additional revenue through improved sales effectiveness.',
      missionGoals: [
        { 
          id: 1, 
          title: 'Accelerate Content Discovery', 
          description: 'Deploy Responsive\'s AI-powered search across all sales teams, reducing average content discovery time from 12 minutes to 3 minutes per interaction.',
          customFields: [
            {id: 1, label: 'Success Metrics', value: 'https://analytics.responsive.io/techcorp/metrics'},
            {id: 2, label: 'Implementation Guide', value: 'https://docs.responsive.io/quick-start'}
          ] 
        },
        { 
          id: 2, 
          title: 'Increase Sales Velocity', 
          description: 'Leverage Responsive\'s Sales Coach AI to provide real-time guidance during customer calls, improving deal conversion rates by 20% and reducing sales cycle by 15%.',
          customFields: [
            {id: 3, label: 'ROI Dashboard', value: 'https://responsive.io/roi/techcorp'}
          ] 
        }
      ],
      stakeholders: [mockContacts[0], mockContacts[1], mockContacts[2]],
      objectives: [
        {
          id: 1,
          name: 'Launch Content Intelligence for Enterprise Team',
          targetDate: '2025-02-28',
          status: 'In Progress',
          description: 'Roll out Responsive\'s Content Intelligence to 50 enterprise sales reps, establishing baseline metrics and achieving 80% adoption within 30 days.',
          challenges: 'Integration with existing Salesforce instance requires custom API development. Some reps resistant to changing current workflow.',
          nextSteps: 'Complete Salesforce integration by Feb 15. Schedule hands-on training sessions week of Feb 20.',
          kpis: [
            { id: 101, typeKey: 'adoption_rate', currentValue: 45, previousValue: 0 },
            { id: 102, typeKey: 'time_to_content', currentValue: 8, previousValue: 12 }
          ]
        },
        {
          id: 2,
          name: 'Implement AI Content Recommendations',
          targetDate: '2025-03-31',
          status: 'Not Started',
          description: 'Configure and train Responsive\'s AI engine on TechCorp\'s content library to provide personalized recommendations based on deal stage and customer profile.',
          challenges: 'Need to clean up and tag 2,000+ pieces of existing content. Requires alignment with Product Marketing on taxonomy.',
          nextSteps: 'Begin content audit week of Feb 1. Define taxonomy structure with Product Marketing by Feb 10.',
          kpis: [
            { id: 201, typeKey: 'content_accuracy', currentValue: 72, previousValue: 65 },
            { id: 202, typeKey: 'ai_confidence', currentValue: 0, previousValue: 0 }
          ]
        }
      ],
      pastObjectives: [
        {
          id: 100,
          name: 'Complete Responsive Platform Onboarding',
          targetDate: '2024-12-31',
          status: 'Completed',
          description: 'Successfully onboarded all stakeholders to Responsive platform, completed initial training, and established success metrics.',
          challenges: 'Initial API rate limits caused sync delays. Resolved by upgrading to Enterprise tier.',
          nextSteps: 'Monitor usage metrics and gather feedback for Q1 optimization.',
          kpis: [
            { id: 1001, typeKey: 'adoption_rate', currentValue: 95, previousValue: 0 }
          ]
        }
      ],
      valueRealized: [
        { 
          id: 1, 
          type: 'Time Savings', 
          description: 'Sales reps save average 4.5 hours/week using Responsive\'s intelligent search, validated across 50 pilot users.',
          date: '2025-01-15', 
          link: 'https://responsive.io/analytics/time-saved' 
        },
        {
          id: 2,
          type: 'Win Rate Increase',
          description: 'Early adopters showing 8% improvement in win rate when using AI-recommended content vs control group.',
          date: '2025-01-20',
          link: 'https://responsive.io/analytics/win-rate'
        }
      ],
      planHealth: 'green'
    };

    // ---------- Helpers ----------
    const $ = (q, root = document) => root.querySelector(q);
    const $$ = (q, root = document) => [...root.querySelectorAll(q)];
    
    function calculateDelta(current, previous) {
      if (!previous || previous === 0) return 0;
      return ((current - previous) / Math.abs(previous) * 100).toFixed(1);
    }

    function getKPIType(typeKey) {
      return KPI_TYPES.find(t => t.key === typeKey) || { unit: '', higherIsBetter: true };
    }

    function autoResizeTextarea(textarea) {
      if (!textarea) return;
      textarea.style.height = 'auto';
      textarea.style.height = textarea.scrollHeight + 'px';
    }

    function applyAutoResize(root = document) {
      $$('.text-area', root).forEach(autoResizeTextarea);
    }

    // ---------- Period Management ----------
    function setupPeriodSwitcher() {
      const buttons = $$('.period-switcher button');
      const compareCheckbox = $('#compare-period');
      
      buttons.forEach(btn => {
        btn.addEventListener('click', () => {
          buttons.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          state.currentPeriod = btn.dataset.period;
          renderAll();
        });
      });
      
      compareCheckbox.addEventListener('change', (e) => {
        state.comparePrevious = e.target.checked;
        renderAll();
      });
    }

    // ---------- Section Locking/Editing ----------
    function setupSectionEditing() {
      // Edit buttons
      $$('[data-edit]').forEach(btn => {
        btn.addEventListener('click', () => {
          const section = btn.dataset.edit;
          enterEditMode(section);
        });
      });
      
      // Save buttons
      $$('[data-save]').forEach(btn => {
        btn.addEventListener('click', () => {
          const section = btn.dataset.save;
          saveSection(section);
        });
      });
      
      // Cancel buttons
      $$('[data-cancel]').forEach(btn => {
        btn.addEventListener('click', () => {
          const section = btn.dataset.cancel;
          cancelEdit(section);
        });
      });
    }

    function enterEditMode(section) {
      const sectionEl = $(`#${section}-section`);
      sectionEl.classList.add('editing');
      
      if (section === 'mission-summary') {
        $('#mission-summary-display').classList.add('hidden');
        $('#mission-summary-edit').classList.remove('hidden');
        $('#mission-summary-input').value = state.missionSummary;
        autoResizeTextarea($('#mission-summary-input'));
      } else if (section === 'mission-goals') {
        $('#mission-goals-display').classList.add('hidden');
        $('#mission-goals-edit').classList.remove('hidden');
        renderMissionGoalsEdit();
      } else if (section === 'value-realized') {
        $('#value-display').classList.add('hidden');
        $('#value-edit').classList.remove('hidden');
        renderValueEdit();
      }
    }

    function saveSection(section) {
      if (section === 'mission-summary') {
        state.missionSummary = $('#mission-summary-input').value;
      }
      // Goals and values save automatically on input
      
      exitEditMode(section);
      renderAll();
      saveToLocalStorage();
      showNotification('Changes saved successfully', 'success');
    }

    function cancelEdit(section) {
      exitEditMode(section);
      renderAll();
    }

    function exitEditMode(section) {
      const sectionEl = $(`#${section}-section`);
      sectionEl.classList.remove('editing');
      
      if (section === 'mission-summary') {
        $('#mission-summary-display').classList.remove('hidden');
        $('#mission-summary-edit').classList.add('hidden');
      } else if (section === 'mission-goals') {
        $('#mission-goals-display').classList.remove('hidden');
        $('#mission-goals-edit').classList.add('hidden');
      } else if (section === 'value-realized') {
        $('#value-display').classList.remove('hidden');
        $('#value-edit').classList.add('hidden');
      }
    }

    // ---------- Renderers ----------
    function renderMissionSummary() {
      $('#mission-summary-display').innerHTML = state.missionSummary || '<span class="text-gray-400">No mission summary defined</span>';
    }

    function renderMissionGoalsDisplay() {
      const container = $('#mission-goals-display');
      container.innerHTML = state.missionGoals.map(g => `
        <div class="card p-4">
          <h3 class="font-semibold text-lg mb-2">${g.title}</h3>
          <p class="text-sm text-gray-600 mb-3">${g.description}</p>
          ${g.customFields && g.customFields.length > 0 ? `
            <div class="space-y-1">
              ${g.customFields.map(f => `
                <div class="text-xs">
                  <span class="font-medium">${f.label}:</span>
                  ${f.value.startsWith('http') ? 
                    `<a href="${f.value}" target="_blank" class="linkish">${f.value}</a>` : 
                    `<span>${f.value}</span>`
                  }
                </div>
              `).join('')}
            </div>
          ` : ''}
        </div>
      `).join('');
    }

    function renderMissionGoalsEdit() {
      const container = $('#mission-goals-container');
      container.innerHTML = state.missionGoals.map(g => `
        <div class="card p-4" data-id="${g.id}">
          <div class="mb-3">
            <input class="text-zone p-2 font-semibold w-full" value="${g.title}" data-role="goal-title" />
          </div>
          <textarea class="text-zone text-area p-3 text-sm" rows="3" data-role="goal-desc">${g.description || ''}</textarea>
          <div class="mt-3 space-y-2" data-role="custom-fields">
            ${(g.customFields || []).map(f => `
              <div class="flex items-center gap-2" data-field-id="${f.id}">
                <input class="text-zone p-2 text-xs font-semibold" value="${f.label}" data-role="cf-label" />
                <input class="text-zone p-2 text-xs flex-1 custom-field-input" value="${f.value || ''}" data-role="cf-value" />
                <button class="text-red-500 hover:text-red-700" data-role="remove-cf">Ã—</button>
              </div>
            `).join('')}
          </div>
          <button class="text-blue-600 hover:text-blue-700 font-medium text-sm mt-2" data-role="add-cf">+ Add Field</button>
        </div>
      `).join('');
      applyAutoResize(container);
    }

    function renderValueDisplay() {
      const container = $('#value-display');
      container.innerHTML = state.valueRealized.map(v => `
        <div class="card p-4">
          <div class="flex justify-between items-start">
            <div>
              <h4 class="font-semibold text-emerald-700">${v.type}</h4>
              <p class="text-sm text-gray-600 mt-1">${v.description}</p>
              <div class="flex gap-4 mt-2 text-xs text-gray-500">
                <span>Realized: ${v.date}</span>
                ${v.link ? `<a href="${v.link}" target="_blank" class="linkish">View Details</a>` : ''}
              </div>
            </div>
          </div>
        </div>
      `).join('');
    }

    function renderValueEdit() {
      const container = $('#value-container');
      container.innerHTML = state.valueRealized.map(v => `
        <div class="card p-4" data-id="${v.id}">
          <div class="grid grid-cols-2 gap-3 mb-3">
            <select class="text-zone p-2 text-sm font-semibold" data-role="value-type">
              <option ${v.type === 'Time Savings' ? 'selected' : ''}>Time Savings</option>
              <option ${v.type === 'Win Rate Increase' ? 'selected' : ''}>Win Rate Increase</option>
              <option ${v.type === 'Cost Reduction' ? 'selected' : ''}>Cost Reduction</option>
              <option ${v.type === 'Revenue Growth' ? 'selected' : ''}>Revenue Growth</option>
            </select>
            <input type="date" value="${v.date || ''}" class="text-zone p-2" data-role="value-date" />
          </div>
          <textarea class="text-zone text-area p-3 text-sm mb-3" rows="2" data-role="value-desc">${v.description || ''}</textarea>
          <input type="text" value="${v.link || ''}" placeholder="https://..." class="text-zone p-2 w-full" data-role="value-link" />
        </div>
      `).join('');
      applyAutoResize(container);
    }

    function renderObjectives() {
      const container = $('#objectives-container');
      container.innerHTML = state.objectives.map(o => renderObjectiveCard(o)).join('') || 
        '<p class="text-gray-500 text-center py-8">No active objectives. Click "Add Objective" to create one.</p>';
      
      const pastContainer = $('#past-objectives-container');
      pastContainer.innerHTML = state.pastObjectives.map(o => renderObjectiveCard(o, true)).join('');
      $('#no-past-objectives').classList.toggle('hidden', state.pastObjectives.length > 0);
    }

    function renderObjectiveCard(obj, isPast = false) {
      const statusClass = {
        'In Progress': 'status-cyan',
        'Not Started': 'status-gray',
        'Completed': 'status-green',
        'At Risk': 'status-yellow'
      }[obj.status] || 'status-gray';
      
      return `
        <div class="card p-6" data-id="${obj.id}">
          <div class="flex justify-between items-start mb-4">
            <div>
              <h3 class="font-semibold text-lg">${obj.name}</h3>
              <div class="flex items-center gap-3 mt-2">
                <span class="status-pill ${statusClass}">${obj.status}</span>
                <span class="text-sm text-gray-500">Target: ${obj.targetDate || 'Not set'}</span>
              </div>
            </div>
            ${!isPast ? `
              <div class="flex gap-2">
                <button class="btn btn-ghost btn-sm" onclick="editObjective(${obj.id})">Edit</button>
                <button class="btn btn-kpi btn-sm" onclick="showAddKPIModal(${obj.id})">+ Add KPI</button>
              </div>
            ` : ''}
          </div>
          
          <p class="text-sm text-gray-600 mb-4">${obj.description}</p>
          
          ${obj.kpis && obj.kpis.length > 0 ? `
            <div class="space-y-3 mb-4">
              <h4 class="font-semibold text-sm">Key Performance Indicators</h4>
              ${obj.kpis.map(kpi => renderKPI(kpi, obj.id)).join('')}
            </div>
          ` : ''}
          
          <div class="grid grid-cols-2 gap-4 text-sm">
            <div>
              <span class="font-medium text-gray-600">Challenges:</span>
              <p class="text-gray-700 mt-1">${obj.challenges || 'None identified'}</p>
            </div>
            <div>
              <span class="font-medium text-gray-600">Next Steps:</span>
              <p class="text-gray-700 mt-1">${obj.nextSteps || 'To be determined'}</p>
            </div>
          </div>
        </div>
      `;
    }

    function renderKPI(kpi, objectiveId) {
      const type = getKPIType(kpi.typeKey);
      const delta = calculateDelta(kpi.currentValue, kpi.previousValue);
      const deltaNum = parseFloat(delta);
      const isPositive = type.higherIsBetter ? deltaNum >= 0 : deltaNum <= 0;
      const showDelta = state.comparePrevious && kpi.previousValue !== undefined;
      
      return `
        <div class="kpi-card" data-kpi-id="${kpi.id}">
          <div class="flex justify-between items-start">
            <div>
              <div class="text-sm font-medium text-gray-700">${type.label}</div>
              <div class="flex items-baseline gap-1 mt-1">
                <span class="kpi-value">${kpi.currentValue}</span>
                <span class="kpi-unit">${type.unit}</span>
                ${showDelta ? `
                  <span class="kpi-delta ${isPositive ? 'positive' : 'negative'}">
                    ${isPositive ? 
                      '<svg class="kpi-arrow" fill="currentColor" viewBox="0 0 20 20"><path d="M5.293 7.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L11 5.414V17a1 1 0 11-2 0V5.414L6.707 7.707a1 1 0 01-1.414 0z"/></svg>' :
                      '<svg class="kpi-arrow" fill="currentColor" viewBox="0 0 20 20"><path d="M14.707 12.293a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 111.414-1.414L9 14.586V3a1 1 0 012 0v11.586l2.293-2.293a1 1 0 011.414 0z"/></svg>'
                    }
                    ${Math.abs(deltaNum)}%
                  </span>
                ` : ''}
              </div>
            </div>
            <button class="text-gray-400 hover:text-gray-600" onclick="editKPI(${objectiveId}, ${kpi.id})">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
              </svg>
            </button>
          </div>
        </div>
      `;
    }

    function renderStakeholders() {
      const container = $('#stakeholders-container');
      container.innerHTML = state.stakeholders.map(s => `
        <div class="flex items-center justify-between p-3 bg-gray-50 border">
          <div>
            <p class="font-semibold text-sm">${s.name}</p>
            <p class="text-xs text-gray-500">${s.title}</p>
            <p class="text-xs text-gray-400">${s.email}</p>
          </div>
          <button class="text-gray-400 hover:text-red-600" onclick="removeStakeholder(${s.id})">Ã—</button>
        </div>
      `).join('');
      
      // Update select options
      const select = $('#add-stakeholder-select');
      const unselected = mockContacts.filter(mc => !state.stakeholders.find(sc => sc.id === mc.id));
      select.innerHTML = '<option value="">+ Add a contact...</option>' + 
        unselected.map(c => `<option value="${c.id}">${c.name} - ${c.title}</option>`).join('') + 
        '<option value="new">Add New Stakeholder...</option>';
    }

    // ---------- Modals ----------
    function showAddObjectiveModal() {
      const modal = createModal('Add New Objective', `
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium mb-1">Objective Name</label>
            <input type="text" id="obj-name" class="text-zone p-2 w-full" placeholder="e.g., Deploy Sales Coach AI">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Description</label>
            <textarea id="obj-desc" class="text-zone text-area p-3 w-full" rows="3" placeholder="Describe the objective and success criteria..."></textarea>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-1">Target Date</label>
              <input type="date" id="obj-date" class="text-zone p-2 w-full">
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Status</label>
              <select id="obj-status" class="text-zone p-2 w-full">
                <option>Not Started</option>
                <option>In Progress</option>
                <option>At Risk</option>
              </select>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Challenges</label>
            <textarea id="obj-challenges" class="text-zone text-area p-3 w-full" rows="2" placeholder="Any known challenges or risks..."></textarea>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Next Steps</label>
            <textarea id="obj-steps" class="text-zone text-area p-3 w-full" rows="2" placeholder="Immediate next actions..."></textarea>
          </div>
        </div>
      `, [
        { label: 'Cancel', class: 'btn-ghost', action: () => closeModal() },
        { label: 'Create Objective', class: 'btn-primary', action: () => {
          const obj = {
            id: Date.now(),
            name: $('#obj-name').value,
            description: $('#obj-desc').value,
            targetDate: $('#obj-date').value,
            status: $('#obj-status').value,
            challenges: $('#obj-challenges').value,
            nextSteps: $('#obj-steps').value,
            kpis: []
          };
          
          if (!obj.name) {
            showNotification('Please enter an objective name', 'error');
            return;
          }
          
          state.objectives.unshift(obj);
          renderAll();
          saveToLocalStorage();
          closeModal();
          showNotification('Objective created successfully', 'success');
        }}
      ]);
      
      applyAutoResize(modal);
    }

    function showAddKPIModal(objectiveId) {
      const modal = createModal('Add KPI', `
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium mb-1">KPI Type</label>
            <select id="kpi-type" class="text-zone p-2 w-full">
              <option value="">Select a KPI type...</option>
              ${KPI_TYPES.map(t => `<option value="${t.key}">${t.label}</option>`).join('')}
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Unit</label>
            <input id="kpi-unit" class="text-zone p-2 w-full bg-gray-100" readonly placeholder="Auto-filled based on type">
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-1">Current Value</label>
              <input type="number" id="kpi-current" class="text-zone p-2 w-full" placeholder="0">
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Previous Value</label>
              <input type="number" id="kpi-previous" class="text-zone p-2 w-full" placeholder="0">
            </div>
          </div>
          <div id="kpi-preview" class="hidden p-3 bg-gray-50 border">
            <div class="text-sm text-gray-600">Preview:</div>
            <div class="font-semibold mt-1">
              <span id="preview-value">0</span>
              <span id="preview-unit"></span>
              <span id="preview-delta" class="ml-2 text-sm"></span>
            </div>
          </div>
        </div>
      `, [
        { label: 'Cancel', class: 'btn-ghost', action: () => closeModal() },
        { label: 'Add KPI', class: 'btn-primary', action: () => {
          const typeKey = $('#kpi-type').value;
          const current = parseFloat($('#kpi-current').value) || 0;
          const previous = parseFloat($('#kpi-previous').value) || 0;
          
          if (!typeKey) {
            showNotification('Please select a KPI type', 'error');
            return;
          }
          
          const obj = state.objectives.find(o => o.id === objectiveId);
          if (!obj) return;
          
          if (!obj.kpis) obj.kpis = [];
          obj.kpis.push({
            id: Date.now(),
            typeKey,
            currentValue: current,
            previousValue: previous
          });
          
          renderAll();
          saveToLocalStorage();
          closeModal();
          showNotification('KPI added successfully', 'success');
        }}
      ]);
      
      // Set up type change handler
      $('#kpi-type').addEventListener('change', (e) => {
        const type = getKPIType(e.target.value);
        $('#kpi-unit').value = type.unit;
        updateKPIPreview();
      });
      
      $('#kpi-current').addEventListener('input', updateKPIPreview);
      $('#kpi-previous').addEventListener('input', updateKPIPreview);
      
      function updateKPIPreview() {
        const typeKey = $('#kpi-type').value;
        if (!typeKey) return;
        
        const type = getKPIType(typeKey);
        const current = parseFloat($('#kpi-current').value) || 0;
        const previous = parseFloat($('#kpi-previous').value) || 0;
        const delta = calculateDelta(current, previous);
        const deltaNum = parseFloat(delta);
        const isPositive = type.higherIsBetter ? deltaNum >= 0 : deltaNum <= 0;
        
        $('#kpi-preview').classList.remove('hidden');
        $('#preview-value').textContent = current;
        $('#preview-unit').textContent = type.unit;
        
        if (previous !== 0) {
          $('#preview-delta').innerHTML = `
            <span class="${isPositive ? 'text-green-600' : 'text-red-600'}">
              ${deltaNum > 0 ? '+' : ''}${delta}%
            </span>
          `;
        } else {
          $('#preview-delta').textContent = '';
        }
      }
    }

    function editKPI(objectiveId, kpiId) {
      const obj = state.objectives.find(o => o.id === objectiveId);
      if (!obj) return;
      
      const kpi = obj.kpis.find(k => k.id === kpiId);
      if (!kpi) return;
      
      const type = getKPIType(kpi.typeKey);
      
      const modal = createModal('Edit KPI', `
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium mb-1">KPI Type</label>
            <input class="text-zone p-2 w-full bg-gray-100" value="${type.label}" readonly>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-1">Current Value</label>
              <input type="number" id="edit-kpi-current" class="text-zone p-2 w-full" value="${kpi.currentValue}">
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Previous Value</label>
              <input type="number" id="edit-kpi-previous" class="text-zone p-2 w-full" value="${kpi.previousValue}">
            </div>
          </div>
          <div class="text-sm text-gray-500">
            Note: Delta will be automatically recalculated when you save.
          </div>
        </div>
      `, [
        { label: 'Delete', class: 'btn-danger', action: () => {
          if (confirm('Are you sure you want to delete this KPI?')) {
            obj.kpis = obj.kpis.filter(k => k.id !== kpiId);
            renderAll();
            saveToLocalStorage();
            closeModal();
            showNotification('KPI deleted', 'success');
          }
        }},
        { label: 'Cancel', class: 'btn-ghost', action: () => closeModal() },
        { label: 'Save Changes', class: 'btn-primary', action: () => {
          kpi.currentValue = parseFloat($('#edit-kpi-current').value) || 0;
          kpi.previousValue = parseFloat($('#edit-kpi-previous').value) || 0;
          
          renderAll();
          saveToLocalStorage();
          closeModal();
          showNotification('KPI updated successfully', 'success');
        }}
      ]);
    }

    function createModal(title, content, buttons = []) {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-panel w-[600px] max-w-[90vw]">
          <div class="modal-header">
            <h3 class="text-lg font-semibold">${title}</h3>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
          </div>
          <div class="modal-body">
            ${content}
          </div>
          <div class="modal-footer">
            ${buttons.map(btn => `
              <button class="btn ${btn.class}">${btn.label}</button>
            `).join('')}
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // Attach button handlers
      const footerButtons = modal.querySelectorAll('.modal-footer button');
      buttons.forEach((btn, i) => {
        footerButtons[i].addEventListener('click', btn.action);
      });
      
      return modal;
    }

    window.closeModal = function() {
      const modal = $('.modal-overlay');
      if (modal) modal.remove();
    };

    window.editObjective = function(id) {
      const obj = state.objectives.find(o => o.id === id);
      if (!obj) return;
      
      const modal = createModal('Edit Objective', `
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium mb-1">Objective Name</label>
            <input type="text" id="edit-obj-name" class="text-zone p-2 w-full" value="${obj.name}">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Description</label>
            <textarea id="edit-obj-desc" class="text-zone text-area p-3 w-full" rows="3">${obj.description || ''}</textarea>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-1">Target Date</label>
              <input type="date" id="edit-obj-date" class="text-zone p-2 w-full" value="${obj.targetDate || ''}">
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Status</label>
              <select id="edit-obj-status" class="text-zone p-2 w-full">
                <option ${obj.status === 'Not Started' ? 'selected' : ''}>Not Started</option>
                <option ${obj.status === 'In Progress' ? 'selected' : ''}>In Progress</option>
                <option ${obj.status === 'At Risk' ? 'selected' : ''}>At Risk</option>
                <option ${obj.status === 'Completed' ? 'selected' : ''}>Completed</option>
              </select>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Challenges</label>
            <textarea id="edit-obj-challenges" class="text-zone text-area p-3 w-full" rows="2">${obj.challenges || ''}</textarea>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Next Steps</label>
            <textarea id="edit-obj-steps" class="text-zone text-area p-3 w-full" rows="2">${obj.nextSteps || ''}</textarea>
          </div>
        </div>
      `, [
        { label: 'Cancel', class: 'btn-ghost', action: () => closeModal() },
        { label: 'Save Changes', class: 'btn-primary', action: () => {
          const oldStatus = obj.status;
          obj.name = $('#edit-obj-name').value;
          obj.description = $('#edit-obj-desc').value;
          obj.targetDate = $('#edit-obj-date').value;
          obj.status = $('#edit-obj-status').value;
          obj.challenges = $('#edit-obj-challenges').value;
          obj.nextSteps = $('#edit-obj-steps').value;
          
          // Move to past if completed
          if (oldStatus !== 'Completed' && obj.status === 'Completed') {
            state.objectives = state.objectives.filter(o => o.id !== id);
            state.pastObjectives.unshift(obj);
            showNotification('Objective completed and moved to past objectives', 'success');
          }
          
          renderAll();
          saveToLocalStorage();
          closeModal();
        }}
      ]);
      
      applyAutoResize(modal);
    };

    window.removeStakeholder = function(id) {
      state.stakeholders = state.stakeholders.filter(s => s.id !== id);
      renderAll();
      saveToLocalStorage();
    };

    // ---------- Notifications ----------
    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = `fixed top-4 right-4 p-4 shadow-lg z-50 font-medium ${
        type === 'success' ? 'bg-gradient-to-r from-emerald-500 to-emerald-600 text-white' : 
        type === 'error' ? 'bg-gradient-to-r from-red-500 to-red-600 text-white' : 
        'bg-gradient-to-r from-blue-500 to-blue-600 text-white'
      }`;
      notification.textContent = message;
      notification.style.minWidth = '250px';
      
      document.body.appendChild(notification);
      
      // Animation
      notification.style.opacity = '0';
      notification.style.transform = 'translateX(100%)';
      notification.style.transition = 'all 0.3s ease';
      
      setTimeout(() => {
        notification.style.opacity = '1';
        notification.style.transform = 'translateX(0)';
      }, 10);
      
      setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }

    // ---------- Event Handlers ----------
    function setupEventHandlers() {
      // Add objective button
      $('#add-objective-btn').addEventListener('click', showAddObjectiveModal);
      
      // Mission goals editing
      $('#mission-goals-container').addEventListener('click', (e) => {
        if (e.target.dataset.role === 'add-cf') {
          const card = e.target.closest('[data-id]');
          const goalId = parseInt(card.dataset.id);
          const goal = state.missionGoals.find(g => g.id === goalId);
          if (!goal.customFields) goal.customFields = [];
          goal.customFields.push({
            id: Date.now(),
            label: 'New Field',
            value: ''
          });
          renderMissionGoalsEdit();
        } else if (e.target.dataset.role === 'remove-cf') {
          const card = e.target.closest('[data-id]');
          const fieldEl = e.target.closest('[data-field-id]');
          const goalId = parseInt(card.dataset.id);
          const fieldId = parseInt(fieldEl.dataset.fieldId);
          const goal = state.missionGoals.find(g => g.id === goalId);
          goal.customFields = goal.customFields.filter(f => f.id !== fieldId);
          renderMissionGoalsEdit();
        }
      });
      
      // Mission goals inputs
      $('#mission-goals-container').addEventListener('input', (e) => {
        const card = e.target.closest('[data-id]');
        if (!card) return;
        
        const goalId = parseInt(card.dataset.id);
        const goal = state.missionGoals.find(g => g.id === goalId);
        
        if (e.target.dataset.role === 'goal-title') {
          goal.title = e.target.value;
        } else if (e.target.dataset.role === 'goal-desc') {
          goal.description = e.target.value;
        } else if (e.target.dataset.role === 'cf-label' || e.target.dataset.role === 'cf-value') {
          const fieldEl = e.target.closest('[data-field-id]');
          const fieldId = parseInt(fieldEl.dataset.fieldId);
          const field = goal.customFields.find(f => f.id === fieldId);
          if (e.target.dataset.role === 'cf-label') {
            field.label = e.target.value;
          } else {
            field.value = e.target.value;
          }
        }
      });
      
      // Add mission goal
      $('#add-mission-goal-btn').addEventListener('click', () => {
        state.missionGoals.push({
          id: Date.now(),
          title: 'New Goal',
          description: '',
          customFields: []
        });
        renderMissionGoalsEdit();
      });
      
      // Value realized editing
      $('#value-container').addEventListener('input', (e) => {
        const card = e.target.closest('[data-id]');
        if (!card) return;
        
        const valueId = parseInt(card.dataset.id);
        const value = state.valueRealized.find(v => v.id === valueId);
        
        if (e.target.dataset.role === 'value-type') {
          value.type = e.target.value;
        } else if (e.target.dataset.role === 'value-desc') {
          value.description = e.target.value;
        } else if (e.target.dataset.role === 'value-date') {
          value.date = e.target.value;
        } else if (e.target.dataset.role === 'value-link') {
          value.link = e.target.value;
        }
      });
      
      // Add value button
      $('#add-value-btn').addEventListener('click', () => {
        state.valueRealized.push({
          id: Date.now(),
          type: 'Time Savings',
          description: '',
          date: new Date().toISOString().split('T')[0],
          link: ''
        });
        renderValueEdit();
      });
      
      // Stakeholder select
      $('#add-stakeholder-select').addEventListener('change', (e) => {
        const value = e.target.value;
        if (value === 'new') {
          // Show new stakeholder modal
          const modal = createModal('Add New Stakeholder', `
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium mb-1">Name</label>
                <input type="text" id="new-name" class="text-zone p-2 w-full" placeholder="Full name">
              </div>
              <div>
                <label class="block text-sm font-medium mb-1">Title</label>
                <input type="text" id="new-title" class="text-zone p-2 w-full" placeholder="Job title">
              </div>
              <div>
                <label class="block text-sm font-medium mb-1">Email</label>
                <input type="email" id="new-email" class="text-zone p-2 w-full" placeholder="email@company.com">
              </div>
            </div>
          `, [
            { label: 'Cancel', class: 'btn-ghost', action: () => closeModal() },
            { label: 'Add Stakeholder', class: 'btn-primary', action: () => {
              const stakeholder = {
                id: Date.now(),
                name: $('#new-name').value,
                title: $('#new-title').value,
                email: $('#new-email').value
              };
              
              if (!stakeholder.name || !stakeholder.email) {
                showNotification('Name and email are required', 'error');
                return;
              }
              
              state.stakeholders.push(stakeholder);
              renderAll();
              saveToLocalStorage();
              closeModal();
              showNotification('Stakeholder added', 'success');
            }}
          ]);
        } else if (value) {
          const contact = mockContacts.find(c => c.id === parseInt(value));
          if (contact) {
            state.stakeholders.push(contact);
            renderAll();
            saveToLocalStorage();
          }
        }
        e.target.value = '';
      });
      
      // Health score
      $('#health-score').addEventListener('change', (e) => {
        state.planHealth = e.target.value;
        saveToLocalStorage();
      });
      
      // Export buttons
      $('#export-pdf-btn').addEventListener('click', exportToPDF);
      $('#export-excel-btn').addEventListener('click', exportToExcel);
    }

    // ---------- Export Functions ----------
    async function exportToPDF() {
      const btn = $('#export-pdf-btn');
      btn.disabled = true;
      btn.innerHTML = '<span class="animate-spin">âŸ³</span> Generating...';
      
      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');
        
        // Add content
        doc.setFontSize(20);
        doc.text('Customer Success Plan - Responsive Platform', 20, 20);
        
        doc.setFontSize(12);
        doc.text(`Generated: ${new Date().toLocaleDateString()}`, 20, 30);
        
        // Add sections
        let y = 50;
        
        // Mission Summary
        doc.setFontSize(14);
        doc.text('Mission Summary', 20, y);
        y += 10;
        doc.setFontSize(10);
        const summaryLines = doc.splitTextToSize(state.missionSummary || 'Not defined', 170);
        doc.text(summaryLines, 20, y);
        y += summaryLines.length * 5 + 10;
        
        // Save
        doc.save('customer-success-plan-responsive.pdf');
        showNotification('PDF exported successfully', 'success');
      } catch (error) {
        console.error('PDF export failed:', error);
        showNotification('PDF export failed', 'error');
      }
      
      btn.disabled = false;
      btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V7.414A2 2 0 0015.414 6L12 2.586A2 2 0 0010.586 2H6zm5 6a1 1 0 10-2 0v3.586l-1.293-1.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V8z" clip-rule="evenodd" /></svg>Export PDF';
    }

    function exportToExcel() {
      try {
        const wb = XLSX.utils.book_new();
        
        // Plan Overview
        const overview = [{
          'Mission Summary': state.missionSummary,
          'Health Status': state.planHealth,
          'Current Period': state.currentPeriod
        }];
        
        // Objectives with KPIs
        const objectives = [];
        state.objectives.forEach(obj => {
          objectives.push({
            'Objective': obj.name,
            'Status': obj.status,
            'Target Date': obj.targetDate,
            'Type': 'Current'
          });
          
          if (obj.kpis) {
            obj.kpis.forEach(kpi => {
              const type = getKPIType(kpi.typeKey);
              objectives.push({
                'Objective': `  â†’ ${type.label}`,
                'Status': `${kpi.currentValue} ${type.unit}`,
                'Target Date': `Delta: ${calculateDelta(kpi.currentValue, kpi.previousValue)}%`,
                'Type': 'KPI'
              });
            });
          }
        });
        
        // Add sheets
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(overview), 'Overview');
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(objectives), 'Objectives & KPIs');
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(state.missionGoals), 'Mission Goals');
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(state.valueRealized), 'Value Realized');
        
        XLSX.writeFile(wb, 'customer-success-plan-responsive.xlsx');
        showNotification('Excel exported successfully', 'success');
      } catch (error) {
        console.error('Excel export failed:', error);
        showNotification('Excel export failed', 'error');
      }
    }

    // ---------- Storage ----------
    function saveToLocalStorage() {
      try {
        localStorage.setItem('responsiveCustomerSuccess', JSON.stringify(state));
      } catch (error) {
        console.warn('Could not save to localStorage:', error);
      }
    }

    function loadFromLocalStorage() {
      try {
        const saved = localStorage.getItem('responsiveCustomerSuccess');
        if (saved) {
          Object.assign(state, JSON.parse(saved));
        }
      } catch (error) {
        console.warn('Could not load from localStorage:', error);
      }
    }

    // ---------- Render All ----------
    function renderAll() {
      renderMissionSummary();
      renderMissionGoalsDisplay();
      renderValueDisplay();
      renderObjectives();
      renderStakeholders();
    }

    // ---------- Initialize ----------
    function init() {
      // Set date
      const dateEl = $('#last-updated-date');
      if (dateEl) {
        dateEl.textContent = new Date().toLocaleDateString('en-US', { 
          year: 'numeric', 
          month: 'long', 
          day: 'numeric' 
        });
      }
      
      loadFromLocalStorage();
      renderAll();
      setupPeriodSwitcher();
      setupSectionEditing();
      setupEventHandlers();
    }

    // Start the app
    init();
  </script>
</body>
</html>
