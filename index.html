<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Customer Success Plan - Receptive Platform</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root { 
      /* Original colors preserved for compatibility */
      --ink: #0f172a; 
      --ink-2: #334155; 
      --ink-3: #64748b;
      --responsive-teal: #14b8a6;
      --responsive-teal-dark: #0d9488;
      --responsive-teal-light: #5eead4;
      
      /* Enhanced gradients with smoother transitions */
      --primary-gradient: linear-gradient(135deg, #2dd4bf 0%, #0d9488 100%);
      --success-gradient: linear-gradient(135deg, #34d399 0%, #10b981 100%);
      --danger-gradient: linear-gradient(135deg, #f87171 0%, #ef4444 100%);
      --warning-gradient: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
      --info-gradient: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
      
      /* Accent colors for variety */
      --accent-purple: #8b5cf6;
      --accent-blue: #3b82f6;
      --accent-indigo: #6366f1;
      --accent-pink: #ec4899;
      --accent-orange: #f97316;
      
      /* Enhanced neutrals */
      --light-bg: #fafafa;
      --card-bg: #ffffff;
      --border-color: #e5e7eb;
      --text-primary: #111827;
      --text-secondary: #6b7280;
      --text-tertiary: #9ca3af;
      
      /* New shadow system */
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      
      /* Animation timing */
      --transition-fast: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
      --transition-base: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      --transition-slow: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    * { 
      box-sizing: border-box; 
      margin: 0;
      padding: 0;
    }
    
    body { 
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
      background: var(--light-bg); 
      color: var(--text-primary); 
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      scroll-behavior: smooth;
      transition: background-color var(--transition-base);
    }

    /* Typography System */
    h1 { 
      font-size: 28px; 
      font-weight: 800; 
      line-height: 1.1; 
      letter-spacing: -0.02em;
      color: var(--text-primary);
    }
    @media (min-width: 768px) {
      h1 {
        font-size: 32px;
      }
    }
    @media (min-width: 1024px) {
      h1 {
        font-size: 36px;
      }
    }
    h2 { 
      font-size: 1.875rem; 
      font-weight: 700; 
      line-height: 1.3; 
      letter-spacing: -0.025em;
      color: var(--text-primary);
    }
    h3 { 
      font-size: 1.25rem; 
      font-weight: 600; 
      line-height: 1.4;
      color: var(--text-primary);
    }
    h4 {
      font-size: 1.125rem;
      font-weight: 600;
      line-height: 1.4;
      color: var(--text-primary);
    }
    
    p {
      margin-bottom: 0.5rem;
    }
    
    /* Text utilities */
    .text-xs { font-size: 0.75rem; line-height: 1rem; }
    .text-sm { font-size: 0.875rem; line-height: 1.25rem; }
    .text-base { font-size: 1rem; line-height: 1.5rem; }
    .text-lg { font-size: 1.125rem; line-height: 1.75rem; }
    .text-xl { font-size: 1.25rem; line-height: 1.75rem; }
    .text-2xl { font-size: 1.5rem; line-height: 2rem; }
    .text-3xl { font-size: 1.875rem; line-height: 2.25rem; }
    
    /* Font weight utilities */
    .font-normal { font-weight: 400; }
    .font-medium { font-weight: 500; }
    .font-semibold { font-weight: 600; }
    .font-bold { font-weight: 700; }
    .font-extrabold { font-weight: 800; }
    .font-light { font-weight: 300; }
    
    /* Text style utilities */
    .italic { font-style: italic; }
    .drop-shadow-lg { 
      text-shadow: 0 10px 15px rgba(0, 0, 0, 0.3), 0 4px 6px rgba(0, 0, 0, 0.2);
    }

    /* Enhanced Form Controls */
    .text-zone { 
      width: 100%; 
      border-radius: 8px; 
      border: 1.5px solid var(--border-color); 
      background: var(--card-bg); 
      box-shadow: var(--shadow-sm); 
      transition: var(--transition-fast); 
      outline: none; 
      font-size: 0.875rem;
      line-height: 1.25rem;
      color: var(--text-primary);
      padding: 0.625rem 0.875rem;
    }
    .text-zone:hover:not(:disabled) {
      border-color: #d1d5db;
      box-shadow: var(--shadow);
    }
    .text-zone:focus { 
      border-color: var(--responsive-teal); 
      box-shadow: 0 0 0 4px rgba(20, 184, 166, 0.15), var(--shadow-md); 
      transform: translateY(-1px);
    }
    .text-zone:disabled {
      background: #f9fafb;
      color: var(--text-tertiary);
      cursor: not-allowed;
      opacity: 0.7;
      box-shadow: none;
    }
    .text-area { 
      resize: none; 
      min-height: 4rem; 
      overflow: hidden; 
      line-height: 1.6; 
    }
    
    select.text-zone {
      cursor: pointer;
      /* Remove default browser arrow */
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      /* Add custom arrow */
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
      background-position: right 0.5rem center;
      background-repeat: no-repeat;
      background-size: 1.5em 1.5em;
      padding-right: 2.5rem;
    }
    
    /* For Internet Explorer */
    select.text-zone::-ms-expand {
      display: none;
    }

    /* Enhanced Cards */
    .card { 
      background: var(--card-bg); 
      border-radius: 12px; 
      box-shadow: var(--shadow); 
      border: 1px solid var(--border-color); 
      transition: var(--transition-base);
      position: relative;
      overflow: hidden;
    }
    .card:hover {
      box-shadow: var(--shadow-lg);
      transform: translateY(-4px);
      border-color: var(--responsive-teal-light);
    }
    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--primary-gradient);
      transform: scaleX(0);
      transition: transform var(--transition-base);
      transform-origin: left;
    }
    .card:hover::before {
      transform: scaleX(1);
    }

    /* Enhanced Buttons */
    .btn { 
      display: inline-flex; 
      align-items: center; 
      justify-content: center;
      gap: .5rem; 
      font-weight: 600; 
      border-radius: 8px; 
      padding: .625rem 1.25rem; 
      border: 1px solid transparent; 
      transition: var(--transition-fast); 
      cursor: pointer;
      font-size: 0.875rem;
      white-space: nowrap;
      text-decoration: none;
      position: relative;
      overflow: hidden;
      transform-style: preserve-3d;
      box-shadow: var(--shadow-sm);
    }
    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      transform: translateX(-100%);
      transition: transform 0.6s;
    }
    .btn:hover::before {
      transform: translateX(100%);
    }
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
      box-shadow: none !important;
    }
    .btn:focus {
      outline: 2px solid var(--responsive-teal);
      outline-offset: 2px;
    }
    .btn:active:not(:disabled) {
      transform: translateY(1px);
      box-shadow: var(--shadow-sm);
    }
    .btn-sm { 
      padding: .375rem .875rem; 
      font-size: .875rem; 
    }
    .btn-primary { 
      background: var(--primary-gradient);
      color: #fff; 
      border: none;
      box-shadow: 0 4px 14px rgba(20, 184, 166, 0.25);
    }
    .btn-primary:hover:not(:disabled) { 
      box-shadow: 0 6px 20px rgba(20, 184, 166, 0.35);
      transform: translateY(-2px);
    }
    .btn-success { 
      background: var(--success-gradient);
      color: #fff;
      border: none;
      box-shadow: 0 4px 14px rgba(34, 197, 94, 0.25);
    }
    .btn-success:hover:not(:disabled) { 
      box-shadow: 0 6px 20px rgba(34, 197, 94, 0.35);
      transform: translateY(-2px);
    }
    .btn-danger {
      background: var(--danger-gradient);
      color: #fff;
      border: none;
      box-shadow: 0 4px 14px rgba(239, 68, 68, 0.25);
    }
    .btn-danger:hover:not(:disabled) {
      box-shadow: 0 6px 20px rgba(239, 68, 68, 0.35);
      transform: translateY(-2px);
    }
    .btn-outline { 
      background: var(--card-bg); 
      color: var(--text-primary); 
      border: 1px solid var(--border-color); 
    }
    .btn-outline:hover:not(:disabled) { 
      background: #f9fafb; 
      border-color: var(--text-secondary);
    }
    .btn-ghost { 
      background: transparent; 
      color: var(--text-secondary); 
      border: none;
    }
    .btn-ghost:hover:not(:disabled) { 
      background: #f3f4f6; 
      color: var(--text-primary);
    }
    
    /* Header button styles */
    .btn-header {
      background: rgba(255, 255, 255, 0.1);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    .btn-header:hover:not(:disabled) {
      background: rgba(255, 255, 255, 0.2);
      border-color: rgba(255, 255, 255, 0.4);
      transform: translateY(-1px);
    }

    /* Read-only sections */
    .section-readonly {
      position: relative;
    }
    .section-readonly .edit-overlay {
      position: absolute;
      top: 1rem;
      right: 1rem;
      z-index: 10;
    }
    .section-readonly.editing .edit-overlay {
      display: none;
    }
    .readonly-content {
      color: var(--text-primary);
      padding: 1rem;
      background: #f9fafb;
      border: 1px solid var(--border-color);
      min-height: 3rem;
      border-radius: 0;
    }

    /* Enhanced Status Pills */
    .status-pill { 
      font-size: .75rem; 
      font-weight: 600; 
      padding: .375rem .875rem; 
      border-radius: 9999px; 
      display: inline-flex; 
      align-items: center; 
      gap: 0.375rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      box-shadow: var(--shadow-sm);
      transition: var(--transition-fast);
    }
    .status-pill:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }
    .status-green { 
      background: linear-gradient(135deg, #86efac 0%, #22c55e 100%); 
      color: #fff; 
    }
    .status-yellow { 
      background: linear-gradient(135deg, #fde047 0%, #eab308 100%); 
      color: #fff; 
    }
    .status-red { 
      background: linear-gradient(135deg, #fca5a5 0%, #ef4444 100%); 
      color: #fff; 
    }
    .status-gray { background: #6b7280; color: #fff; }
    .status-cyan { background: #06b6d4; color: #fff; }

    /* KPI display */
    .kpi-card {
      background: #f9fafb;
      border: 1px solid var(--border-color);
      padding: 1rem;
      position: relative;
      transition: all 0.15s ease;
    }
    .kpi-card:hover {
      background: #f3f4f6;
      border-color: var(--responsive-teal);
    }
    .kpi-value {
      font-size: 2.5rem;
      font-weight: 700;
      line-height: 1;
      color: var(--text-primary);
    }
    .kpi-unit {
      font-size: 1.125rem;
      font-weight: 400;
      color: var(--text-secondary);
      margin-left: 0.25rem;
    }
    .kpi-delta {
      font-size: 1rem;
      font-weight: 600;
      padding: 0.375rem 0.75rem;
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
      border-radius: 0;
    }
    .kpi-delta.positive {
      background: #d1fae5;
      color: #065f46;
    }
    .kpi-delta.negative {
      background: #fee2e2;
      color: #991b1b;
    }
    .kpi-arrow {
      width: 1rem;
      height: 1rem;
    }

    /* Period switcher */
    .period-switcher {
      display: inline-flex;
      background: #f3f4f6;
      border: 1px solid var(--border-color);
      padding: 0.125rem;
    }
    .period-switcher button {
      padding: 0.25rem 0.625rem;
      font-size: 0.75rem;
      font-weight: 500;
      background: transparent;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.15s;
    }
    .period-switcher button.active {
      background: var(--card-bg);
      color: var(--responsive-teal);
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    
    .period-switcher.small {
      padding: 0.0625rem;
    }
    .period-switcher.small button {
      padding: 0.125rem 0.5rem;
      font-size: 0.625rem;
    }

    /* Modal */
    .modal-overlay { 
      position: fixed; 
      inset: 0; 
      background: rgba(0,0,0,0.5); 
      backdrop-filter: blur(4px); 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      z-index: 50; 
      animation: fadeIn 0.15s ease;
    }
    .modal-panel { 
      border-radius: 0; 
      box-shadow: 0 20px 40px rgba(0,0,0,0.15); 
      max-height: 90vh; 
      overflow-y: auto; 
      background: var(--card-bg); 
      position: relative;
      animation: slideIn 0.2s ease;
    }
    .modal-header { 
      padding: 1.5rem; 
      border-bottom: 1px solid var(--border-color); 
      background: #f9fafb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .modal-body { 
      padding: 1.5rem; 
    }
    .modal-footer { 
      padding: 1rem 1.5rem; 
      border-top: 1px solid var(--border-color); 
      display: flex; 
      justify-content: flex-end; 
      gap: 1rem; 
      background: #f9fafb;
    }
    .modal-close {
      width: 2rem;
      height: 2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: none;
      font-size: 1.5rem;
      color: var(--text-secondary);
      cursor: pointer;
      transition: color 0.15s;
      border-radius: 0;
    }
    .modal-close:hover {
      color: var(--text-primary);
      background: #f3f4f6;
    }

    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes slideIn {
      from { 
        opacity: 0;
        transform: translateY(-10px);
      }
      to { 
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Helpers */
    .linkish { 
      text-decoration: underline; 
      color: var(--responsive-teal); 
      cursor: pointer;
      transition: color 0.15s;
    }
    .linkish:hover { 
      color: var(--responsive-teal-dark); 
    }

    /* Product selection */
    .product-checkbox {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem;
      transition: background 0.15s;
    }
    .product-checkbox:hover {
      background: #f9fafb;
    }
    .product-checkbox input[type="checkbox"] {
      width: 1.25rem;
      height: 1.25rem;
      cursor: pointer;
      accent-color: var(--responsive-teal);
    }

    /* Custom field inputs */
    .custom-field-input {
      min-width: 400px;
    }

    /* Loading states */
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .animate-spin {
      animation: spin 1s linear infinite;
      display: inline-block;
    }
    .loading {
      opacity: 0.6;
      pointer-events: none;
    }
    
    /* Edit mode styles */
    .edit-mode-banner {
      background: #f3f4f6;
      border: 1px solid var(--border-color);
      padding: 0.75rem 1rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1rem;
    }
    
    .checkbox-wrapper {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .checkbox-wrapper input[type="checkbox"] {
      width: 1.25rem;
      height: 1.25rem;
      cursor: pointer;
      accent-color: var(--responsive-teal);
    }
    
    .checkbox-wrapper label {
      cursor: pointer;
      user-select: none;
    }
    
    .item-checkbox {
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
      padding: 0.5rem;
      margin: -0.5rem;
      cursor: pointer;
      transition: background 0.15s;
    }
    
    .item-checkbox:hover {
      background: rgba(20, 184, 166, 0.05);
    }
    
    .item-checkbox input[type="checkbox"] {
      margin-top: 0.125rem;
      flex-shrink: 0;
    }
    
    .item-checkbox-content {
      flex: 1;
      min-width: 0;
    }
    
    /* Toast notification styles */
    .toast {
      position: fixed;
      bottom: 2rem;
      left: 50%;
      transform: translateX(-50%);
      background: var(--text-primary);
      color: white;
      padding: 1rem 1.5rem;
      border-radius: 0;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      gap: 1rem;
      z-index: 60;
      animation: slideUp 0.3s ease;
    }
    
    .toast-undo {
      background: transparent;
      color: var(--responsive-teal-light);
      border: 1px solid var(--responsive-teal-light);
      padding: 0.25rem 0.75rem;
      cursor: pointer;
      transition: all 0.15s;
      font-weight: 600;
      font-size: 0.875rem;
    }
    
    .toast-undo:hover {
      background: var(--responsive-teal-light);
      color: var(--text-primary);
    }
    
    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateX(-50%) translateY(1rem);
      }
      to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
    }
    
    /* Edit button in section headers */
    .section-header-edit {
      margin-left: auto;
    }
    
    /* Utility classes */
    .shadow-sm { box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
    .shadow { box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .shadow-md { box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .shadow-lg { box-shadow: 0 10px 15px rgba(0,0,0,0.1); }
    .shadow-xl { box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
    
    /* Opacity utilities */
    .text-teal-50\/90 { color: rgb(240 253 250 / 0.9); }
    
    /* Responsive utilities */
    @media (max-width: 768px) {
      .modal-panel {
        margin: 1rem;
        max-width: calc(100vw - 2rem);
      }
      .custom-field-input {
        min-width: 100%;
      }
    }
    
    .watermark {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(249, 250, 251, 0.95) 100%);
      backdrop-filter: blur(10px);
      color: var(--text-primary);
      font-size: 14px;
      font-weight: 600;
      padding: 12px 20px;
      border-radius: 50px;
      box-shadow: 0 4px 24px rgba(0, 0, 0, 0.1), 0 2px 8px rgba(0, 0, 0, 0.06);
      z-index: 50;
      user-select: none;
      display: flex;
      align-items: center;
      gap: 10px;
      border: 1px solid rgba(229, 231, 235, 0.6);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: default;
      opacity: 0.9;
    }
    
    .watermark:hover {
      opacity: 1;
      transform: translateY(-2px);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12), 0 4px 12px rgba(0, 0, 0, 0.08);
      background: linear-gradient(135deg, rgba(255, 255, 255, 1) 0%, rgba(249, 250, 251, 1) 100%);
    }
    
    .watermark::before {
      content: '✨';
      font-size: 16px;
      animation: sparkle 3s ease-in-out infinite;
    }
    
    @keyframes sparkle {
      0%, 100% { opacity: 0.6; transform: scale(1) rotate(0deg); }
      50% { opacity: 1; transform: scale(1.2) rotate(180deg); }
    }
  </style>
</head>
<body>
  <div class="watermark">
    <span style="background: linear-gradient(135deg, var(--responsive-teal) 0%, var(--responsive-teal-dark) 100%); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; font-weight: 700;">Created by</span>
    <span style="font-weight: 700;">Atiq Azel Khan</span>
  </div>
  <div id="app" class="max-w-screen-xl mx-auto p-4 sm:p-6 lg:p-8">
    <!-- Enhanced Header with Modern Watermark -->
    <header class="mb-10 p-6 md:p-8 lg:p-10 bg-gradient-to-r from-teal-950 via-teal-800 to-emerald-600 text-white shadow-xl relative overflow-hidden">
      <!-- Animated Background Pattern -->
      <div class="absolute inset-0 opacity-10">
        <div class="absolute inset-0" style="background-image: repeating-linear-gradient(45deg, transparent, transparent 35px, rgba(255,255,255,.05) 35px, rgba(255,255,255,.05) 70px); animation: slide 20s linear infinite;"></div>
      </div>
      

      
      <!-- Corner Accent -->
      <div class="absolute top-0 right-0 w-32 h-32 md:w-48 md:h-48">
        <div class="absolute inset-0 bg-gradient-to-br from-white/10 to-transparent transform rotate-45 translate-x-16 -translate-y-16"></div>
      </div>
      
      <div class="flex flex-col lg:flex-row justify-between items-center gap-6 relative z-20">
        <div class="flex-1 text-center lg:text-left">
          <h1 id="main-title" class="font-extrabold text-white drop-shadow-lg flex flex-wrap items-baseline gap-3 justify-center lg:justify-start" style="font-size: 32px;">
            <span id="customer-name-display" class="cursor-pointer hover:opacity-80 border-b-2 border-transparent hover:border-white/50 transition-all" title="Click to edit customer name">[Customer Name]</span>
            <span>Success Plan</span>
          </h1>
          <p class="text-white/80 mt-2 text-lg">Strategic objectives and performance tracking</p>
        </div>
        <div class="flex flex-col md:flex-row items-start md:items-center gap-4">
          <p class="text-teal-50/90 text-sm font-light whitespace-nowrap">Last updated: <span id="last-updated-date"></span></p>
          <div class="grid grid-cols-2 gap-2 max-w-md">
            <button id="export-pdf-btn" class="btn btn-primary flex items-center justify-center text-sm transform transition-all duration-200 hover:shadow-lg" style="transform: translateY(0px);" onmouseover="this.style.transform='translateY(-4px)'" onmouseout="this.style.transform='translateY(0px)'" aria-label="Export to PDF">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V7.414A2 2 0 0015.414 6L12 2.586A2 2 0 0010.586 2H6zm5 6a1 1 0 10-2 0v3.586l-1.293-1.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V8z" clip-rule="evenodd" /></svg>
              PDF Report
            </button>
            <button id="export-excel-btn" class="btn bg-emerald-700 hover:bg-emerald-800 text-white flex items-center justify-center text-sm transform transition-all duration-200 hover:shadow-lg" style="transform: translateY(0px);" onmouseover="this.style.transform='translateY(-4px)'" onmouseout="this.style.transform='translateY(0px)'" aria-label="Export to Excel">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zm4 18H6V4h7v5h5v11z"/><path d="M8.5 12.5l1.5 3 1.5-3m-3 0h3m-4.5-1h6v5h-6z"/></svg>
              Excel
            </button>
            <button id="export-data-btn" class="btn bg-blue-600 hover:bg-blue-700 text-white flex items-center justify-center text-sm transform transition-all duration-200 hover:shadow-lg" style="transform: translateY(0px);" onmouseover="this.style.transform='translateY(-4px)'" onmouseout="this.style.transform='translateY(0px)'" aria-label="Export Data">
              <svg class="h-5 w-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
              </svg>
              Backup
            </button>
            <button id="import-data-btn" class="btn bg-green-600 hover:bg-green-700 text-white flex items-center justify-center text-sm transform transition-all duration-200 hover:shadow-lg" style="transform: translateY(0px);" onmouseover="this.style.transform='translateY(-4px)'" onmouseout="this.style.transform='translateY(0px)'" aria-label="Import Data">
              <svg class="h-5 w-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
              </svg>
              Restore
            </button>
          </div>
        </div>
      </div>
    </header>



    <!-- Mission Summary -->
    <section class="card mb-6 p-6 section-readonly" id="mission-summary-section">
      <div class="edit-overlay">
        <button class="btn btn-ghost btn-sm" data-edit="mission-summary">Edit</button>
      </div>
      <h2 class="text-2xl font-bold mb-4">Executive Summary</h2>
      <div id="mission-summary-display" class="readonly-content"></div>
      <div id="mission-summary-edit" class="hidden">
        <textarea id="mission-summary-input" class="text-zone text-area p-3" rows="3"></textarea>
        <div class="mt-3 flex gap-2">
          <button class="btn btn-primary btn-sm" data-save="mission-summary">Save</button>
          <button class="btn btn-ghost btn-sm" data-cancel="mission-summary">Cancel</button>
        </div>
      </div>
    </section>

    <!-- Mission Goals -->
    <section class="card mb-10 p-6 section-readonly" id="mission-goals-section">
      <div class="edit-overlay">
        <button class="btn btn-ghost btn-sm" data-edit="mission-goals">Edit</button>
      </div>
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold">Mission Goals</h2>
      </div>
      <div id="mission-goals-display" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
      <div id="mission-goals-edit" class="hidden">
        <div id="mission-goals-container" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
        <div class="mt-4 flex gap-2">
          <button class="btn btn-success btn-sm" id="add-mission-goal-btn">+ Add Goal</button>
          <button class="btn btn-primary btn-sm" data-save="mission-goals">Save All</button>
          <button class="btn btn-ghost btn-sm" data-cancel="mission-goals">Cancel</button>
        </div>
      </div>
    </section>

    <main class="grid grid-cols-1 lg:grid-cols-4 gap-8">
      <!-- Left Column -->
      <div class="lg:col-span-3 space-y-8">
        <!-- Value Realized -->
        <section id="value-realized-section" class="card p-6">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold">Value Realized</h2>
            <div class="flex items-center gap-2">
              <button id="edit-value-realized-btn" class="btn btn-ghost" onclick="toggleEditMode('valueRealized')">Edit</button>
              <button class="btn btn-success btn-sm" id="add-value-btn" onclick="showAddValueModal()">+ Add Value</button>
            </div>
          </div>
          <div id="value-realized-edit-banner" class="edit-mode-banner hidden">
            <div class="checkbox-wrapper">
              <input type="checkbox" id="value-realized-select-all" onchange="toggleSelectAll('valueRealized')">
              <label for="value-realized-select-all" class="text-sm font-medium">Select all</label>
            </div>
            <button id="value-realized-delete-btn" class="btn btn-danger btn-sm" disabled onclick="deleteSelectedItems('valueRealized')">Delete selected</button>
            <button class="linkish text-sm" onclick="cancelEditMode('valueRealized')">Cancel</button>
          </div>
          <div id="value-display" class="space-y-4"></div>
        </section>

        <!-- Current Objectives -->
        <section id="current-objectives" class="card p-6">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold">Current Objectives</h2>
            <div class="flex items-center gap-2">
              <button id="edit-objectives-btn" class="btn btn-ghost" onclick="toggleEditMode('objectives')">Edit</button>
              <button id="add-objective-btn" class="btn btn-primary">+ Add Objective</button>
            </div>
          </div>
          <div id="objectives-edit-banner" class="edit-mode-banner hidden">
            <div class="checkbox-wrapper">
              <input type="checkbox" id="objectives-select-all" onchange="toggleSelectAll('objectives')">
              <label for="objectives-select-all" class="text-sm font-medium">Select all</label>
            </div>
            <button id="objectives-delete-btn" class="btn btn-danger btn-sm" disabled onclick="deleteSelectedItems('objectives')">Delete selected</button>
            <button class="linkish text-sm" onclick="cancelEditMode('objectives')">Cancel</button>
          </div>
          <div id="objectives-container" class="space-y-6"></div>
          <div id="no-objectives" class="hidden text-center py-10 px-4 text-gray-500">
            No active objectives. Click "Add Objective" to create one.
          </div>
        </section>

        <!-- Past Objectives -->
        <section id="past-objectives" class="card p-6">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold">Past Objectives Achieved</h2>
            <div class="flex items-center gap-2">
              <button id="edit-past-objectives-btn" class="btn btn-ghost" onclick="toggleEditMode('pastObjectives')">Edit</button>
              <button id="add-past-objective-btn" class="btn btn-success btn-sm">+ Add Past Objective</button>
            </div>
          </div>
          <div id="past-objectives-edit-banner" class="edit-mode-banner hidden">
            <div class="checkbox-wrapper">
              <input type="checkbox" id="past-objectives-select-all" onchange="toggleSelectAll('pastObjectives')">
              <label for="past-objectives-select-all" class="text-sm font-medium">Select all</label>
            </div>
            <button id="past-objectives-delete-btn" class="btn btn-danger btn-sm" disabled onclick="deleteSelectedItems('pastObjectives')">Delete selected</button>
            <button class="linkish text-sm" onclick="cancelEditMode('pastObjectives')">Cancel</button>
          </div>
          <div id="past-objectives-container" class="space-y-6"></div>
          <div id="no-past-objectives" class="hidden text-center py-10 px-4 text-gray-500">
            Completed objectives will appear here.
          </div>
        </section>
      </div>

      <!-- Right Column -->
      <div class="lg:col-span-1 space-y-8">
        <!-- Overall Health -->
        <section class="card p-6">
          <h3 class="text-lg font-semibold mb-3">Overall Health</h3>
          <select id="health-score" class="text-zone p-2">
            <option value="green">🟢 On Track</option>
            <option value="yellow">🟡 Needs Attention</option>
            <option value="red">🔴 At Risk</option>
          </select>
        </section>

        <!-- Key Stakeholders -->
        <section class="card p-6">
          <h3 class="text-lg font-semibold mb-3">Key Stakeholders</h3>
          <div id="stakeholders-container" class="space-y-3 mb-3"></div>
          <select id="add-stakeholder-select" class="text-zone p-2">
            <option value="">+ Add a contact...</option>
            <option value="new">Add New Stakeholder...</option>
          </select>
        </section>

        <!-- Receptive Platform Products -->
        <section class="card p-6 section-readonly" id="products-section">
          <div class="edit-overlay">
            <button class="btn btn-ghost btn-sm" data-edit="products">Edit</button>
          </div>
          <h3 class="text-lg font-semibold mb-3">Receptive Platform Products</h3>
          <div id="products-display" class="space-y-2"></div>
          <div id="products-edit" class="hidden">
            <div class="space-y-2">
              <div class="product-checkbox">
                <input type="checkbox" id="product-content-library" value="Content Library">
                <label for="product-content-library" class="text-sm font-medium cursor-pointer">Content Library</label>
              </div>
              <div class="product-checkbox">
                <input type="checkbox" id="product-ai" value="AI">
                <label for="product-ai" class="text-sm font-medium cursor-pointer">AI</label>
              </div>
              <div class="product-checkbox">
                <input type="checkbox" id="product-projects" value="Projects">
                <label for="product-projects" class="text-sm font-medium cursor-pointer">Projects</label>
              </div>
              <div class="product-checkbox">
                <input type="checkbox" id="product-trust-center" value="Trust Center">
                <label for="product-trust-center" class="text-sm font-medium cursor-pointer">Trust Center</label>
              </div>
            </div>
            <div class="mt-4 flex gap-2">
              <button class="btn btn-primary btn-sm" data-save="products">Save</button>
              <button class="btn btn-ghost btn-sm" data-cancel="products">Cancel</button>
            </div>
          </div>
        </section>
      </div>
    </main>
  </div>

  <script>
    // Immediate debug check
    console.log('=== Script starting to execute ===');
    document.addEventListener('DOMContentLoaded', function() {
      console.log('=== DOMContentLoaded fired ===');
    });
    
    // ---------- Data Models ----------
    const PRODUCT_KPIS = {
      'Content Library': [
        { key: 'content_utilization', label: 'Content Utilization', unit: '%', higherIsBetter: true },
        { key: 'tagging_percentage', label: 'Tagging Percentage', unit: '%', higherIsBetter: true },
        { key: 'records_with_reviews', label: '% of Records with Reviews enabled', unit: '%', higherIsBetter: true },
        { key: 'content_ownership', label: '% of content with ownership', unit: '%', higherIsBetter: true },
        { key: 'obsolete_records', label: '% of obsolete records', unit: '%', higherIsBetter: false },
        { key: 'duplicated_records', label: '% of duplicated records', unit: '%', higherIsBetter: false }
      ],
      'AI': [
        { key: 'unedited_ai_responses', label: 'Unedited AI responses', unit: '%', higherIsBetter: false },
        { key: 'answer_with_ai', label: '% answer with AI', unit: '%', higherIsBetter: true },
        { key: 'ai_chatbot_usage', label: 'AI chatbot usage', unit: 'sessions', higherIsBetter: true }
      ],
      'Projects': [
        { key: 'answer_library_usage', label: '% Answer library usage', unit: '%', higherIsBetter: true },
        { key: 'manual_answers', label: '% of manual answers', unit: '%', higherIsBetter: false },
        { key: 'answers_edited', label: '% of Answers edited from Answer Library', unit: '%', higherIsBetter: false },
        { key: 'time_per_response', label: 'Time spent per response', unit: 's', higherIsBetter: false }
      ],
      'Trust Center': [
        { key: 'profile_views', label: '% of profile views', unit: '%', higherIsBetter: true }
      ]
    };

    const mockContacts = [
      { id: 1, name: 'Sarah Chen', title: 'VP Sales', email: 'sarah.chen@[customer-domain].com' },
      { id: 2, name: 'Michael Rodriguez', title: 'Sales Director', email: 'michael.r@[customer-domain].com' },
      { id: 3, name: 'Jennifer Park', title: 'Head of Enablement', email: 'jennifer.p@[customer-domain].com' },
      { id: 4, name: 'David Thompson', title: 'CRO', email: 'david.t@[customer-domain].com' },
      { id: 5, name: 'Emily Watson', title: 'Sales Operations Manager', email: 'emily.w@[customer-domain].com' },
      { id: 6, name: 'Robert Johnson', title: 'Enterprise Account Executive', email: 'robert.j@[customer-domain].com' }
    ];

    // Application State
    const state = {
      customerName: '[Customer Name]',
      products: ['Content Library', 'AI', 'Projects'],
      missionSummary: 'Partner with [Customer Name] to revolutionize their global sales operations through Receptive\'s AI-powered revenue enablement platform. Our mission is to empower 500+ sales professionals across 12 regions to deliver personalized, data-driven customer experiences that accelerate deal velocity by 45% and increase average contract values by 30% within the next 12 months.',
      missionGoals: [
        { 
          id: 1, 
          title: 'Content Excellence Initiative', 
          description: 'Achieve 95% content accuracy and reduce obsolete content to less than 5% through AI-powered content management and automated review workflows.',
          customFields: [
            {id: 1, label: 'Success Dashboard', value: 'https://analytics.example.com/dashboard'},
            {id: 2, label: 'Content Audit Report', value: 'https://docs.example.com/content-audit'}
          ] 
        },
        { 
          id: 2, 
          title: 'AI Adoption Program', 
          description: 'Drive 80% adoption of AI-powered responses across all sales teams, reducing average response time from 45 minutes to under 5 minutes.',
          customFields: [
            {id: 3, label: 'AI Training Portal', value: 'https://training.example.com/ai-certification'},
            {id: 4, label: 'ROI Calculator', value: 'https://roi.example.com/calculator'}
          ] 
        }
      ],
      stakeholders: [mockContacts[0], mockContacts[1], mockContacts[2]],
      // Edit mode states
      editModes: {
        objectives: false,
        valueRealized: false,
        pastObjectives: false
      },
      selectedItems: {
        objectives: new Set(),
        valueRealized: new Set(),
        pastObjectives: new Set()
      },
      undoStates: {
        objectives: null,
        valueRealized: null,
        pastObjectives: null
      },
      objectives: [
        {
          id: 1,
          name: 'Implement Content Governance Framework',
          targetDate: '2025-03-15',
          status: 'In Progress',
          description: 'Establish automated content lifecycle management with ownership assignment, review cycles, and obsolescence tracking for 5,000+ sales assets.',
          challenges: 'Legacy content lacks metadata. Need to train content owners on new tagging taxonomy.',
          nextSteps: 'Complete content audit by Feb 15. Deploy automated tagging tool by March 1.',
          kpis: [
            { 
              id: 101, 
              typeKey: 'content_ownership', 
              currentValue: 62, 
              previousValue: 15,
              period: 'Quarter',
              comparePrevious: true
            },
            { 
              id: 102, 
              typeKey: 'obsolete_records', 
              currentValue: 18, 
              previousValue: 32,
              period: 'Quarter',
              comparePrevious: true
            },
            { 
              id: 103, 
              typeKey: 'tagging_percentage', 
              currentValue: 71, 
              previousValue: 23,
              period: 'Month',
              comparePrevious: true
            }
          ]
        },
        {
          id: 2,
          name: 'Scale AI-Powered Responses',
          targetDate: '2025-04-30',
          status: 'Not Started',
          description: 'Roll out AI response capabilities to all 200+ sales reps with personalized training and success tracking.',
          challenges: 'Varying technical proficiency across teams. Need to customize AI models for different product lines.',
          nextSteps: 'Define success metrics. Create team-specific training paths. Set up AI performance dashboards.',
          kpis: [
            { 
              id: 201, 
              typeKey: 'answer_with_ai', 
              currentValue: 34, 
              previousValue: 8,
              period: 'Quarter',
              comparePrevious: true
            },
            { 
              id: 202, 
              typeKey: 'time_per_response', 
              currentValue: 12, 
              previousValue: 45,
              period: 'Month',
              comparePrevious: true
            }
          ]
        }
      ],
      pastObjectives: [
        {
          id: 100,
          name: 'Platform Onboarding & Initial Setup',
          targetDate: '2024-12-31',
          status: 'Completed',
          description: 'Successfully onboarded [Customer Name] to Receptive platform with SSO integration, initial content migration, and pilot team training.',
          challenges: 'Initial API rate limits required optimization. SSO integration needed custom SAML configuration.',
          nextSteps: 'Monitor system performance. Gather user feedback for Phase 2 rollout.',
          kpis: [
            { 
              id: 1001, 
              typeKey: 'content_utilization', 
              currentValue: 78, 
              previousValue: 0,
              period: 'Quarter',
              comparePrevious: true
            }
          ]
        }
      ],
      valueRealized: [
        { 
          id: 1, 
          type: 'Time Savings', 
          description: 'Sales team saves average 8 hours/week per rep through instant content discovery and AI-powered responses. With 500 reps, this equals 4,000 hours weekly or $8.3M in annual productivity gains.',
          date: '2025-01-15', 
          link: 'https://metrics.example.com/time-savings' 
        },
        {
          id: 2,
          type: 'Response Time Reduction',
          description: 'Average time per customer response decreased from 45 minutes to 7 minutes using AI assistance. Reps now handle 6x more inquiries daily with higher quality responses.',
          date: '2025-01-22',
          link: 'https://metrics.example.com/response-time'
        },
        {
          id: 3,
          type: 'Database Utilization',
          description: 'Content database utilization increased from 23% to 89% after implementing AI-powered search and recommendations. Previously hidden valuable content now actively drives deals.',
          date: '2025-01-28',
          link: 'https://analytics.example.com/content-usage'
        },
        {
          id: 4,
          type: 'Deal Velocity Impact',
          description: 'Sales cycles reduced by 35 days on average when using AI-recommended content sequences. Deals with high content engagement close 42% faster than traditional approach.',
          date: '2025-02-05',
          link: 'https://analytics.example.com/deal-velocity'
        }
      ],
      valueRealizedBackup: [], // For cancel functionality
      planHealth: 'green'
    };

    // ---------- Utility Functions ----------
    const $ = (q, root = document) => root.querySelector(q);
    const $$ = (q, root = document) => [...root.querySelectorAll(q)];
    
    function calculateDelta(current, previous) {
      if (!previous || previous === 0) return 0;
      return ((current - previous) / Math.abs(previous) * 100).toFixed(1);
    }

    function getAvailableKPITypes() {
      const types = [];
      state.products.forEach(product => {
        if (PRODUCT_KPIS[product]) {
          types.push(...PRODUCT_KPIS[product]);
        }
      });
      return types;
    }

    function getKPIType(typeKey) {
      const allTypes = getAvailableKPITypes();
      return allTypes.find(t => t.key === typeKey) || { label: 'Unknown KPI', unit: '', higherIsBetter: true };
    }

    function autoResizeTextarea(textarea) {
      if (!textarea) return;
      textarea.style.height = 'auto';
      textarea.style.height = (textarea.scrollHeight + 2) + 'px';
    }

    function applyAutoResize(root = document) {
      $$('.text-area', root).forEach(autoResizeTextarea);
    }

    // ---------- Section Locking/Editing ----------
    function setupSectionEditing() {
      document.addEventListener('click', (e) => {
        if (e.target.matches('[data-edit]')) {
          const section = e.target.dataset.edit;
          enterEditMode(section);
        } else if (e.target.matches('[data-save]')) {
          const section = e.target.dataset.save;
          saveSection(section);
        } else if (e.target.matches('[data-cancel]')) {
          const section = e.target.dataset.cancel;
          cancelEdit(section);
        }
      });
    }

    function enterEditMode(section) {
      const sectionEl = $(`#${section}-section`);
      if (sectionEl) sectionEl.classList.add('editing');
      
      if (section === 'mission-summary') {
        $('#mission-summary-display').classList.add('hidden');
        $('#mission-summary-edit').classList.remove('hidden');
        $('#mission-summary-input').value = state.missionSummary;
        autoResizeTextarea($('#mission-summary-input'));
      } else if (section === 'mission-goals') {
        $('#mission-goals-display').classList.add('hidden');
        $('#mission-goals-edit').classList.remove('hidden');
        renderMissionGoalsEdit();
      } else if (section === 'products') {
        $('#products-display').classList.add('hidden');
        $('#products-edit').classList.remove('hidden');
        // Set checkbox states
        state.products.forEach(product => {
          const checkbox = $(`#product-${product.toLowerCase().replace(' ', '-')}`);
          if (checkbox) checkbox.checked = true;
        });
      }
    }

    function saveSection(section) {
      if (section === 'mission-summary') {
        state.missionSummary = $('#mission-summary-input').value;
      } else if (section === 'products') {
        const newProducts = [];
        $$('#products-edit input[type="checkbox"]:checked').forEach(cb => {
          newProducts.push(cb.value);
        });
        state.products = newProducts;
      }
      
      exitEditMode(section);
      renderAll();
      saveToLocalStorage();
      showNotification('Changes saved successfully', 'success');
    }

    function cancelEdit(section) {
      exitEditMode(section);
      renderAll();
    }

    function exitEditMode(section) {
      const sectionEl = $(`#${section}-section`);
      if (sectionEl) sectionEl.classList.remove('editing');
      
      if (section === 'mission-summary') {
        $('#mission-summary-display').classList.remove('hidden');
        $('#mission-summary-edit').classList.add('hidden');
      } else if (section === 'mission-goals') {
        $('#mission-goals-display').classList.remove('hidden');
        $('#mission-goals-edit').classList.add('hidden');
      } else if (section === 'products') {
        $('#products-display').classList.remove('hidden');
        $('#products-edit').classList.add('hidden');
      }
    }

    // ---------- Rendering Functions ----------
    function renderMissionSummary() {
      const display = $('#mission-summary-display');
      if (display) {
        display.innerHTML = state.missionSummary || '<span class="text-gray-500 italic">No executive summary defined</span>';
      }
    }

    function renderMissionGoalsDisplay() {
      const container = $('#mission-goals-display');
      if (!container) return;
      
      container.innerHTML = state.missionGoals.map(g => `
        <div class="card p-4">
          <h3 class="font-semibold text-lg mb-2">${g.title}</h3>
          <p class="text-sm text-gray-600 mb-3">${g.description}</p>
          ${g.customFields && g.customFields.length > 0 ? `
            <div class="space-y-1">
              ${g.customFields.map(f => `
                <div class="text-xs">
                  <span class="font-medium text-gray-700">${f.label}:</span>
                  ${f.value.startsWith('http') ? 
                    `<a href="${f.value}" target="_blank" class="linkish ml-1">${f.value}</a>` : 
                    `<span class="ml-1">${f.value}</span>`
                  }
                </div>
              `).join('')}
            </div>
          ` : ''}
        </div>
      `).join('') || '<p class="text-gray-500">No mission goals defined.</p>';
    }

    function renderMissionGoalsEdit() {
      const container = $('#mission-goals-container');
      if (!container) return;
      
      container.innerHTML = state.missionGoals.map(g => `
        <div class="card p-4" data-id="${g.id}">
          <button class="float-right text-red-500 hover:text-red-700" data-role="remove-goal">×</button>
          <div class="mb-3">
            <input class="text-zone p-2 font-semibold w-full" value="${g.title}" data-role="goal-title" />
          </div>
          <textarea class="text-zone text-area p-3 text-sm" rows="3" data-role="goal-desc">${g.description || ''}</textarea>
          <div class="mt-3 space-y-2" data-role="custom-fields">
            ${(g.customFields || []).map(f => `
              <div class="flex items-center gap-2" data-field-id="${f.id}">
                <input class="text-zone p-2 text-xs font-semibold" value="${f.label}" data-role="cf-label" />
                <input class="text-zone p-2 text-xs flex-1 custom-field-input" value="${f.value || ''}" data-role="cf-value" />
                <button class="text-red-500 hover:text-red-700 text-xl" data-role="remove-cf">×</button>
              </div>
            `).join('')}
          </div>
          <button class="text-teal-600 hover:text-teal-700 font-medium text-sm mt-2" data-role="add-cf">+ Add Field</button>
        </div>
      `).join('');
      applyAutoResize(container);
    }

    function renderValueDisplay() {
      const container = $('#value-display');
      if (!container) return;
      
      const isEditMode = state.editModes.valueRealized;
      
      if (state.valueRealized.length === 0) {
        container.innerHTML = '<p class="text-gray-500">No value realized items yet.</p>';
        return;
      }
      
      container.innerHTML = state.valueRealized.map(v => {
        const isSelected = state.selectedItems.valueRealized.has(v.id);
        
        if (isEditMode) {
          return `
            <div class="card p-4">
              <label class="item-checkbox" for="value-checkbox-${v.id}">
                <input type="checkbox" id="value-checkbox-${v.id}" 
                  ${isSelected ? 'checked' : ''} 
                  onchange="toggleItemSelection('valueRealized', ${v.id})"
                  aria-label="Select ${v.type}: ${v.description}">
                <div class="item-checkbox-content">
                  <h4 class="font-semibold text-emerald-700">${v.type}</h4>
                  <p class="text-sm text-gray-700 mt-1">${v.description}</p>
                  <div class="flex gap-4 mt-2 text-xs text-gray-500">
                    <span>Realized: ${v.date || 'Not specified'}</span>
                    ${v.link ? `<a href="${v.link}" target="_blank" class="linkish" onclick="event.stopPropagation()">View Details</a>` : ''}
                  </div>
                </div>
              </label>
            </div>
          `;
        } else {
          return `
            <div class="card p-4">
              <div class="flex justify-between items-start">
                <div class="flex-1">
                  <h4 class="font-semibold text-emerald-700">${v.type}</h4>
                  <p class="text-sm text-gray-700 mt-1">${v.description}</p>
                  <div class="flex gap-4 mt-2 text-xs text-gray-500">
                    <span>Realized: ${v.date || 'Not specified'}</span>
                    ${v.link ? `<a href="${v.link}" target="_blank" class="linkish">View Details</a>` : ''}
                  </div>
                </div>
              </div>
            </div>
          `;
        }
      }).join('');
    }



    function renderObjectives() {
      const container = $('#objectives-container');
      const noObjectivesMsg = $('#no-objectives');
      
      if (!container) return;
      
      if (state.objectives.length === 0) {
        container.innerHTML = '';
        noObjectivesMsg?.classList.remove('hidden');
      } else {
        noObjectivesMsg?.classList.add('hidden');
        container.innerHTML = state.objectives.map(o => renderObjectiveCard(o)).join('');
      }
      
      const pastContainer = $('#past-objectives-container');
      if (pastContainer) {
        pastContainer.innerHTML = state.pastObjectives.map(o => renderObjectiveCard(o, true)).join('');
      }
      $('#no-past-objectives')?.classList.toggle('hidden', state.pastObjectives.length > 0);
    }

    function renderObjectiveCard(obj, isPast = false) {
      const statusClass = {
        'In Progress': 'status-cyan',
        'Not Started': 'status-gray',
        'Completed': 'status-green',
        'At Risk': 'status-yellow'
      }[obj.status] || 'status-gray';
      
      const sectionKey = isPast ? 'pastObjectives' : 'objectives';
      const isEditMode = state.editModes[sectionKey];
      const isSelected = state.selectedItems[sectionKey].has(obj.id);
      
      if (isEditMode) {
        return `
          <div class="card p-6" data-id="${obj.id}">
            <label class="item-checkbox" for="${sectionKey}-checkbox-${obj.id}">
              <input type="checkbox" id="${sectionKey}-checkbox-${obj.id}" 
                ${isSelected ? 'checked' : ''} 
                onchange="toggleItemSelection('${sectionKey}', ${obj.id})"
                aria-label="Select objective: ${obj.name}">
              <div class="item-checkbox-content w-full">
                <div class="flex justify-between items-start mb-4">
                  <div>
                    <h3 class="font-semibold text-lg">${obj.name}</h3>
                    <div class="flex items-center gap-3 mt-2">
                      <span class="status-pill ${statusClass}">${obj.status}</span>
                      <span class="text-sm text-gray-500">Target: ${obj.targetDate || 'Not set'}</span>
                    </div>
                  </div>
                </div>
                
                <p class="text-sm text-gray-600 mb-4">${obj.description}</p>
                
                ${obj.kpis && obj.kpis.length > 0 ? `
                  <div class="space-y-3 mb-4">
                    <h4 class="font-semibold text-sm text-gray-700">Key Performance Indicators</h4>
                    ${obj.kpis.map(kpi => renderKPI(kpi, obj.id)).join('')}
                  </div>
                ` : ''}
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                  <div>
                    <span class="font-medium text-gray-600">Challenges:</span>
                    <p class="text-gray-700 mt-1">${obj.challenges || 'None identified'}</p>
                  </div>
                  <div>
                    <span class="font-medium text-gray-600">Next Steps:</span>
                    <p class="text-gray-700 mt-1">${obj.nextSteps || 'To be determined'}</p>
                  </div>
                </div>
              </div>
            </label>
          </div>
        `;
      } else {
        return `
          <div class="card p-6" data-id="${obj.id}">
            <div class="flex justify-between items-start mb-4">
              <div>
                <h3 class="font-semibold text-lg">${obj.name}</h3>
                <div class="flex items-center gap-3 mt-2">
                  <span class="status-pill ${statusClass}">${obj.status}</span>
                  <span class="text-sm text-gray-500">Target: ${obj.targetDate || 'Not set'}</span>
                </div>
              </div>
              <div class="flex gap-2">
                <button class="btn btn-ghost btn-sm" onclick="editObjective(${obj.id}, ${isPast})">Edit</button>
                ${!isPast ? `
                  <button class="btn btn-primary btn-sm" onclick="showAddKPIModal(${obj.id})">+ Add KPI</button>
                ` : ''}
              </div>
            </div>
            
            <p class="text-sm text-gray-600 mb-4">${obj.description}</p>
            
            ${obj.kpis && obj.kpis.length > 0 ? `
              <div class="space-y-3 mb-4">
                <h4 class="font-semibold text-sm text-gray-700">Key Performance Indicators</h4>
                ${obj.kpis.map(kpi => renderKPI(kpi, obj.id)).join('')}
              </div>
            ` : ''}
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
              <div>
                <span class="font-medium text-gray-600">Challenges:</span>
                <p class="text-gray-700 mt-1">${obj.challenges || 'None identified'}</p>
              </div>
              <div>
                <span class="font-medium text-gray-600">Next Steps:</span>
                <p class="text-gray-700 mt-1">${obj.nextSteps || 'To be determined'}</p>
              </div>
            </div>
          </div>
        `;
      }
    }

    function renderKPI(kpi, objectiveId) {
      const type = getKPIType(kpi.typeKey);
      const delta = calculateDelta(kpi.currentValue, kpi.previousValue);
      const deltaNum = parseFloat(delta);
      const isPositive = type.higherIsBetter ? deltaNum >= 0 : deltaNum <= 0;
      const showDelta = kpi.comparePrevious && kpi.previousValue !== undefined;
      
      const periodLabel = {
        'Month': 'MoM',
        'Quarter': 'QoQ',
        'Year': 'YoY'
      }[kpi.period] || 'QoQ';
      
      return `
        <div class="kpi-card" data-kpi-id="${kpi.id}">
          <div class="flex justify-between items-start mb-2">
            <div class="flex-1">
              <div class="text-sm font-medium text-gray-700">${type.label}</div>
            </div>
            <div class="flex items-center gap-2">
              <div class="period-switcher small">
                <button class="${kpi.period === 'Month' ? 'active' : ''}" onclick="updateKPIPeriod(${objectiveId}, ${kpi.id}, 'Month')">M</button>
                <button class="${kpi.period === 'Quarter' ? 'active' : ''}" onclick="updateKPIPeriod(${objectiveId}, ${kpi.id}, 'Quarter')">Q</button>
                <button class="${kpi.period === 'Year' ? 'active' : ''}" onclick="updateKPIPeriod(${objectiveId}, ${kpi.id}, 'Year')">Y</button>
              </div>
              <button class="text-gray-400 hover:text-gray-600" onclick="editKPI(${objectiveId}, ${kpi.id})">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
                </svg>
              </button>
            </div>
          </div>
          <div class="flex items-baseline gap-2">
            <span class="kpi-value">${kpi.currentValue}</span>
            <span class="kpi-unit">${type.unit}</span>
            ${showDelta ? `
              <span class="kpi-delta ${isPositive ? 'positive' : 'negative'}">
                ${isPositive ? 
                  '<svg class="kpi-arrow" fill="currentColor" viewBox="0 0 20 20"><path d="M5.293 7.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L11 5.414V17a1 1 0 11-2 0V5.414L6.707 7.707a1 1 0 01-1.414 0z"/></svg>' :
                  '<svg class="kpi-arrow" fill="currentColor" viewBox="0 0 20 20"><path d="M14.707 12.293a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 111.414-1.414L9 14.586V3a1 1 0 012 0v11.586l2.293-2.293a1 1 0 011.414 0z"/></svg>'
                }
                ${Math.abs(deltaNum)}% ${periodLabel}
              </span>
            ` : ''}
          </div>
          ${kpi.comparePrevious ? '' : `
            <button class="text-xs text-teal-600 hover:text-teal-700 mt-1" onclick="toggleKPIComparison(${objectiveId}, ${kpi.id})">
              Show comparison
            </button>
          `}
        </div>
      `;
    }

    function renderStakeholders() {
      const container = $('#stakeholders-container');
      if (!container) return;
      
      container.innerHTML = state.stakeholders.map(s => `
        <div class="flex items-center justify-between p-3 bg-gray-50 border border-gray-200 hover:bg-gray-100 transition-colors">
          <div>
            <p class="font-semibold text-sm">${s.name}</p>
            <p class="text-xs text-gray-600">${s.title}</p>
            <p class="text-xs text-gray-500">${s.email}</p>
          </div>
          <button class="text-gray-400 hover:text-red-600 text-xl" onclick="removeStakeholder(${s.id})">×</button>
        </div>
      `).join('');
      
      // Update select options
      const select = $('#add-stakeholder-select');
      if (select) {
        const unselected = mockContacts.filter(mc => !state.stakeholders.find(sc => sc.id === mc.id));
        select.innerHTML = '<option value="">+ Add a contact...</option>' + 
          unselected.map(c => `<option value="${c.id}">${c.name} - ${c.title}</option>`).join('') + 
          '<option value="new">Add New Stakeholder...</option>';
      }
    }

    function renderProducts() {
      const display = $('#products-display');
      if (!display) return;
      
      if (state.products.length === 0) {
        display.innerHTML = '<p class="text-gray-500 text-sm">No products selected</p>';
      } else {
        display.innerHTML = state.products.map(product => `
          <div class="flex items-center gap-2">
            <span class="w-2 h-2 bg-teal-500 rounded-full"></span>
            <span class="text-sm">${product}</span>
          </div>
        `).join('');
      }
    }
    
    function renderHealthScore() {
      const healthSelect = $('#health-score');
      if (healthSelect) {
        healthSelect.value = state.planHealth || 'green';
      }
    }

    // ---------- Modals ----------
    window.showAddObjectiveModal = function(isPast = false) {
      const modal = createModal(isPast ? 'Add Past Objective' : 'Add New Objective', `
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium mb-1">Objective Name</label>
            <input type="text" id="obj-name" class="text-zone p-2 w-full" placeholder="e.g., Improve content quality metrics">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Description</label>
            <textarea id="obj-desc" class="text-zone text-area p-3 w-full" rows="3" placeholder="Describe the objective and success criteria..."></textarea>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-1">Target Date</label>
              <input type="date" id="obj-date" class="text-zone p-2 w-full">
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Status</label>
              <select id="obj-status" class="text-zone p-2 w-full">
                ${isPast ? 
                  '<option selected>Completed</option>' : 
                  `<option>Not Started</option>
                   <option>In Progress</option>
                   <option>At Risk</option>`
                }
              </select>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Challenges</label>
            <textarea id="obj-challenges" class="text-zone text-area p-3 w-full" rows="2" placeholder="Any known challenges or risks..."></textarea>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Next Steps</label>
            <textarea id="obj-steps" class="text-zone text-area p-3 w-full" rows="2" placeholder="Immediate next actions..."></textarea>
          </div>
        </div>
      `, [
        { label: 'Cancel', class: 'btn-ghost', action: () => closeModal() },
        { label: 'Create Objective', class: 'btn-primary', action: () => {
          const obj = {
            id: Date.now(),
            name: $('#obj-name').value.trim(),
            description: $('#obj-desc').value.trim(),
            targetDate: $('#obj-date').value,
            status: $('#obj-status').value,
            challenges: $('#obj-challenges').value.trim(),
            nextSteps: $('#obj-steps').value.trim(),
            kpis: []
          };
          
          if (!obj.name) {
            showNotification('Please enter an objective name', 'error');
            return;
          }
          
          if (isPast) {
            state.pastObjectives.unshift(obj);
            showNotification('Past objective added successfully', 'success');
          } else {
            state.objectives.unshift(obj);
            showNotification('Objective created successfully', 'success');
          }
          renderAll();
          saveToLocalStorage();
          closeModal();
        }}
      ]);
      
      applyAutoResize(modal);
    }

    window.showAddValueModal = function() {
      const modal = createModal('Add Value Realized', `
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium mb-1">Value Type</label>
            <select id="value-type" class="text-zone p-2 w-full">
              <option>Time Savings</option>
              <option>Win Rate Increase</option>
              <option>Cost Reduction</option>
              <option>Revenue Growth</option>
              <option>Productivity Gain</option>
              <option>Risk Mitigation</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Description</label>
            <textarea id="value-desc" class="text-zone text-area p-3 w-full" rows="3" placeholder="Describe the value realized and its impact..."></textarea>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Date Realized</label>
            <input type="date" id="value-date" class="text-zone p-2 w-full" value="${new Date().toISOString().split('T')[0]}">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Reference Link (optional)</label>
            <input type="url" id="value-link" class="text-zone p-2 w-full" placeholder="https://...">
          </div>
        </div>
      `, [
        { label: 'Cancel', class: 'btn-ghost', action: () => closeModal() },
        { label: 'Add Value', class: 'btn-primary', action: () => {
          const value = {
            id: Date.now(),
            type: $('#value-type').value,
            description: $('#value-desc').value.trim(),
            date: $('#value-date').value,
            link: $('#value-link').value.trim()
          };
          
          if (!value.description) {
            showNotification('Please enter a description', 'error');
            return;
          }
          
          state.valueRealized.unshift(value);
          renderAll();
          saveToLocalStorage();
          closeModal();
          showNotification('Value realized item added', 'success');
        }}
      ]);
      
      applyAutoResize(modal);
    };

    window.showAddKPIModal = function(objectiveId) {
      const availableTypes = getAvailableKPITypes();
      
      if (availableTypes.length === 0) {
        showNotification('Please select products first to see available KPIs', 'error');
        return;
      }
      
      const modal = createModal('Add KPI', `
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium mb-1">KPI Type</label>
            <select id="kpi-type" class="text-zone p-2 w-full">
              <option value="">Select a KPI type...</option>
              ${availableTypes.map(t => `<option value="${t.key}">${t.label}</option>`).join('')}
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Unit</label>
            <input id="kpi-unit" class="text-zone p-2 w-full bg-gray-100" readonly placeholder="Auto-filled based on type">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Time Period</label>
            <select id="kpi-period" class="text-zone p-2 w-full">
              <option value="Month">Month</option>
              <option value="Quarter" selected>Quarter</option>
              <option value="Year">Year</option>
            </select>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-1">Current Value</label>
              <input type="number" id="kpi-current" class="text-zone p-2 w-full" placeholder="0" step="0.1">
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Previous Value</label>
              <input type="number" id="kpi-previous" class="text-zone p-2 w-full" placeholder="0" step="0.1">
            </div>
          </div>
          <div class="flex items-center gap-2">
            <input type="checkbox" id="kpi-compare" checked>
            <label for="kpi-compare" class="text-sm cursor-pointer">Show comparison vs previous period</label>
          </div>
          <div id="kpi-preview" class="hidden p-3 bg-gray-50 border">
            <div class="text-sm text-gray-600">Preview:</div>
            <div class="font-semibold mt-1">
              <span id="preview-value">0</span>
              <span id="preview-unit"></span>
              <span id="preview-delta" class="ml-2 text-sm"></span>
            </div>
          </div>
        </div>
      `, [
        { label: 'Cancel', class: 'btn-ghost', action: () => closeModal() },
        { label: 'Add KPI', class: 'btn-primary', action: () => {
          const typeKey = $('#kpi-type').value;
          const current = parseFloat($('#kpi-current').value) || 0;
          const previous = parseFloat($('#kpi-previous').value) || 0;
          const period = $('#kpi-period').value;
          const comparePrevious = $('#kpi-compare').checked;
          
          if (!typeKey) {
            showNotification('Please select a KPI type', 'error');
            return;
          }
          
          const obj = state.objectives.find(o => o.id === objectiveId);
          if (!obj) return;
          
          if (!obj.kpis) obj.kpis = [];
          obj.kpis.push({
            id: Date.now(),
            typeKey,
            currentValue: current,
            previousValue: previous,
            period,
            comparePrevious
          });
          
          renderAll();
          saveToLocalStorage();
          closeModal();
          showNotification('KPI added successfully', 'success');
        }}
      ]);
      
      // Set up type change handler
      $('#kpi-type').addEventListener('change', (e) => {
        const type = getKPIType(e.target.value);
        $('#kpi-unit').value = type.unit;
        updateKPIPreview();
      });
      
      $('#kpi-current').addEventListener('input', updateKPIPreview);
      $('#kpi-previous').addEventListener('input', updateKPIPreview);
      $('#kpi-period').addEventListener('change', updateKPIPreview);
      $('#kpi-compare').addEventListener('change', updateKPIPreview);
      
      function updateKPIPreview() {
        const typeKey = $('#kpi-type').value;
        if (!typeKey) return;
        
        const type = getKPIType(typeKey);
        const current = parseFloat($('#kpi-current').value) || 0;
        const previous = parseFloat($('#kpi-previous').value) || 0;
        const period = $('#kpi-period').value;
        const comparePrevious = $('#kpi-compare').checked;
        const delta = calculateDelta(current, previous);
        const deltaNum = parseFloat(delta);
        const isPositive = type.higherIsBetter ? deltaNum >= 0 : deltaNum <= 0;
        
        const periodLabel = {
          'Month': 'MoM',
          'Quarter': 'QoQ',
          'Year': 'YoY'
        }[period] || 'QoQ';
        
        $('#kpi-preview').classList.remove('hidden');
        $('#preview-value').textContent = current;
        $('#preview-unit').textContent = type.unit;
        
        if (comparePrevious && previous !== 0) {
          $('#preview-delta').innerHTML = `
            <span class="${isPositive ? 'text-green-600' : 'text-red-600'}">
              ${deltaNum > 0 ? '+' : ''}${delta}% ${periodLabel}
            </span>
          `;
        } else {
          $('#preview-delta').textContent = '';
        }
      }
    }

    window.editKPI = function(objectiveId, kpiId) {
      const obj = state.objectives.find(o => o.id === objectiveId);
      if (!obj) return;
      
      const kpi = obj.kpis.find(k => k.id === kpiId);
      if (!kpi) return;
      
      const type = getKPIType(kpi.typeKey);
      
      const modal = createModal('Edit KPI', `
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium mb-1">KPI Type</label>
            <input class="text-zone p-2 w-full bg-gray-100" value="${type.label}" readonly>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Time Period</label>
            <select id="edit-kpi-period" class="text-zone p-2 w-full">
              <option value="Month" ${kpi.period === 'Month' ? 'selected' : ''}>Month</option>
              <option value="Quarter" ${kpi.period === 'Quarter' ? 'selected' : ''}>Quarter</option>
              <option value="Year" ${kpi.period === 'Year' ? 'selected' : ''}>Year</option>
            </select>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-1">Current Value</label>
              <input type="number" id="edit-kpi-current" class="text-zone p-2 w-full" value="${kpi.currentValue}" step="0.1">
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Previous Value</label>
              <input type="number" id="edit-kpi-previous" class="text-zone p-2 w-full" value="${kpi.previousValue}" step="0.1">
            </div>
          </div>
          <div class="flex items-center gap-2">
            <input type="checkbox" id="edit-kpi-compare" ${kpi.comparePrevious ? 'checked' : ''}>
            <label for="edit-kpi-compare" class="text-sm cursor-pointer">Show comparison vs previous period</label>
          </div>
          <div class="text-sm text-gray-500 mt-2">
            Note: Delta will be automatically recalculated when you save.
          </div>
        </div>
      `, [
        { label: 'Delete', class: 'btn-danger btn-sm', action: () => {
          if (confirm('Are you sure you want to delete this KPI?')) {
            obj.kpis = obj.kpis.filter(k => k.id !== kpiId);
            renderAll();
            saveToLocalStorage();
            closeModal();
            showNotification('KPI deleted', 'success');
          }
        }},
        { label: 'Cancel', class: 'btn-ghost', action: () => closeModal() },
        { label: 'Save Changes', class: 'btn-primary', action: () => {
          kpi.currentValue = parseFloat($('#edit-kpi-current').value) || 0;
          kpi.previousValue = parseFloat($('#edit-kpi-previous').value) || 0;
          kpi.period = $('#edit-kpi-period').value;
          kpi.comparePrevious = $('#edit-kpi-compare').checked;
          
          renderAll();
          saveToLocalStorage();
          closeModal();
          showNotification('KPI updated successfully', 'success');
        }}
      ]);
    }

    function createModal(title, content, buttons = []) {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.setAttribute('role', 'dialog');
      modal.setAttribute('aria-modal', 'true');
      modal.setAttribute('aria-labelledby', 'modal-title');
      
      modal.innerHTML = `
        <div class="modal-panel w-[600px] max-w-[90vw]" role="document">
          <div class="modal-header">
            <h3 class="text-lg font-semibold" id="modal-title">${title}</h3>
            <button class="modal-close" onclick="closeModal()" aria-label="Close modal">×</button>
          </div>
          <div class="modal-body">
            ${content}
          </div>
          <div class="modal-footer">
            ${buttons.map(btn => `
              <button class="btn ${btn.class || ''}">${btn.label}</button>
            `).join('')}
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // Attach button handlers
      const footerButtons = modal.querySelectorAll('.modal-footer button');
      buttons.forEach((btn, i) => {
        if (footerButtons[i]) {
          footerButtons[i].addEventListener('click', btn.action);
        }
      });
      
      // Close on overlay click
      modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
      });
      
      // Focus management
      const focusableElements = modal.querySelectorAll(
        'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
      );
      const firstFocusable = focusableElements[0];
      const lastFocusable = focusableElements[focusableElements.length - 1];
      
      // Save the current focused element
      const previouslyFocused = document.activeElement;
      
      // Focus the first focusable element
      setTimeout(() => {
        if (firstFocusable) firstFocusable.focus();
      }, 100);
      
      // Trap focus within modal
      modal.addEventListener('keydown', (e) => {
        if (e.key === 'Tab') {
          if (e.shiftKey) {
            if (document.activeElement === firstFocusable) {
              e.preventDefault();
              lastFocusable.focus();
            }
          } else {
            if (document.activeElement === lastFocusable) {
              e.preventDefault();
              firstFocusable.focus();
            }
          }
        }
      });
      
      // Store reference to restore focus
      modal._previouslyFocused = previouslyFocused;
      
      return modal;
    }

    window.closeModal = function() {
      const modal = $('.modal-overlay');
      if (modal) {
        // Restore focus to previously focused element
        if (modal._previouslyFocused) {
          modal._previouslyFocused.focus();
        }
        modal.remove();
      }
    };

    window.editObjective = function(id, isPast = false) {
      const obj = isPast ? 
        state.pastObjectives.find(o => o.id === id) : 
        state.objectives.find(o => o.id === id);
      if (!obj) return;
      
      const modal = createModal('Edit Objective', `
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium mb-1">Objective Name</label>
            <input type="text" id="edit-obj-name" class="text-zone p-2 w-full" value="${obj.name}">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Description</label>
            <textarea id="edit-obj-desc" class="text-zone text-area p-3 w-full" rows="3">${obj.description || ''}</textarea>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-1">Target Date</label>
              <input type="date" id="edit-obj-date" class="text-zone p-2 w-full" value="${obj.targetDate || ''}">
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Status</label>
              <select id="edit-obj-status" class="text-zone p-2 w-full">
                <option ${obj.status === 'Not Started' ? 'selected' : ''}>Not Started</option>
                <option ${obj.status === 'In Progress' ? 'selected' : ''}>In Progress</option>
                <option ${obj.status === 'At Risk' ? 'selected' : ''}>At Risk</option>
                <option ${obj.status === 'Completed' ? 'selected' : ''}>Completed</option>
              </select>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Challenges</label>
            <textarea id="edit-obj-challenges" class="text-zone text-area p-3 w-full" rows="2">${obj.challenges || ''}</textarea>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Next Steps</label>
            <textarea id="edit-obj-steps" class="text-zone text-area p-3 w-full" rows="2">${obj.nextSteps || ''}</textarea>
          </div>
        </div>
      `, [
        { label: 'Cancel', class: 'btn-ghost', action: () => closeModal() },
        { label: 'Save Changes', class: 'btn-primary', action: () => {
          const oldStatus = obj.status;
          obj.name = $('#edit-obj-name').value.trim();
          obj.description = $('#edit-obj-desc').value.trim();
          obj.targetDate = $('#edit-obj-date').value;
          obj.status = $('#edit-obj-status').value;
          obj.challenges = $('#edit-obj-challenges').value.trim();
          obj.nextSteps = $('#edit-obj-steps').value.trim();
          
          // Handle status changes and moving between lists
          if (!isPast && oldStatus !== 'Completed' && obj.status === 'Completed') {
            // Move from current to past
            state.objectives = state.objectives.filter(o => o.id !== id);
            state.pastObjectives.unshift(obj);
            showNotification('Objective completed and moved to past objectives', 'success');
          } else if (isPast && obj.status !== 'Completed') {
            // Move from past back to current
            state.pastObjectives = state.pastObjectives.filter(o => o.id !== id);
            state.objectives.push(obj);
            showNotification('Objective moved back to current objectives', 'success');
          }
          
          renderAll();
          saveToLocalStorage();
          closeModal();
        }}
      ]);
      
      applyAutoResize(modal);
    };

    window.removeStakeholder = function(id) {
      state.stakeholders = state.stakeholders.filter(s => s.id !== id);
      renderAll();
      saveToLocalStorage();
    };

    // ---------- Edit Mode Functions ----------
    window.toggleEditMode = function(section) {
      // Convert section names to match HTML IDs
      const sectionIdMap = {
        'objectives': 'objectives',
        'valueRealized': 'value-realized',
        'pastObjectives': 'past-objectives'
      };
      const sectionId = sectionIdMap[section] || section.toLowerCase();
      
      const editBtn = $(`#edit-${sectionId}-btn`);
      const banner = $(`#${sectionId}-edit-banner`);
      
      if (!editBtn || !banner) return;
      
      const isEditMode = !state.editModes[section];
      state.editModes[section] = isEditMode;
      
      if (isEditMode) {
        editBtn.textContent = 'Done';
        editBtn.classList.remove('btn-ghost');
        editBtn.classList.add('btn-primary');
        banner.classList.remove('hidden');
      } else {
        editBtn.textContent = 'Edit';
        editBtn.classList.remove('btn-primary');
        editBtn.classList.add('btn-ghost');
        banner.classList.add('hidden');
        // Clear selections when exiting edit mode
        state.selectedItems[section].clear();
        updateDeleteButtonState(section);
      }
      
      renderAll();
    };
    
    window.cancelEditMode = function(section) {
      state.editModes[section] = false;
      state.selectedItems[section].clear();
      
      // Convert section names to match HTML IDs
      const sectionIdMap = {
        'objectives': 'objectives',
        'valueRealized': 'value-realized',
        'pastObjectives': 'past-objectives'
      };
      const sectionId = sectionIdMap[section] || section.toLowerCase();
      
      const editBtn = $(`#edit-${sectionId}-btn`);
      editBtn.textContent = 'Edit';
      editBtn.classList.remove('btn-primary');
      editBtn.classList.add('btn-ghost');
      
      $(`#${sectionId}-edit-banner`).classList.add('hidden');
      updateDeleteButtonState(section);
      renderAll();
    };
    
    window.toggleItemSelection = function(section, itemId) {
      if (state.selectedItems[section].has(itemId)) {
        state.selectedItems[section].delete(itemId);
      } else {
        state.selectedItems[section].add(itemId);
      }
      
      updateSelectAllCheckbox(section);
      updateDeleteButtonState(section);
    };
    
    window.toggleSelectAll = function(section) {
      const checkbox = $(`#${section.toLowerCase()}-select-all`);
      const items = section === 'objectives' ? state.objectives :
                   section === 'valueRealized' ? state.valueRealized :
                   state.pastObjectives;
      
      if (checkbox.checked) {
        items.forEach(item => state.selectedItems[section].add(item.id));
      } else {
        state.selectedItems[section].clear();
      }
      
      updateDeleteButtonState(section);
      renderAll();
    };
    
    function updateSelectAllCheckbox(section) {
      // Convert section names to match HTML IDs
      const sectionIdMap = {
        'objectives': 'objectives',
        'valueRealized': 'value-realized',
        'pastObjectives': 'past-objectives'
      };
      const sectionId = sectionIdMap[section] || section.toLowerCase();
      
      const checkbox = $(`#${sectionId}-select-all`);
      if (!checkbox) return;
      
      const items = section === 'objectives' ? state.objectives :
                   section === 'valueRealized' ? state.valueRealized :
                   state.pastObjectives;
      
      const allSelected = items.length > 0 && 
                         items.every(item => state.selectedItems[section].has(item.id));
      
      checkbox.checked = allSelected;
      checkbox.indeterminate = !allSelected && state.selectedItems[section].size > 0;
    }
    
    function updateDeleteButtonState(section) {
      // Convert section names to match HTML IDs
      const sectionIdMap = {
        'objectives': 'objectives',
        'valueRealized': 'value-realized',
        'pastObjectives': 'past-objectives'
      };
      const sectionId = sectionIdMap[section] || section.toLowerCase();
      
      const deleteBtn = $(`#${sectionId}-delete-btn`);
      if (deleteBtn) {
        deleteBtn.disabled = state.selectedItems[section].size === 0;
      }
    }
    
    window.deleteSelectedItems = function(section) {
      const selectedCount = state.selectedItems[section].size;
      if (selectedCount === 0) return;
      
      const itemType = section === 'objectives' ? 'objectives' :
                      section === 'valueRealized' ? 'value realized items' :
                      'past objectives';
      
      const modal = createModal('Remove selected items?', `
        <div class="space-y-4">
          <p class="text-gray-700">You are about to remove ${selectedCount} ${itemType}.</p>
          <p class="text-sm text-gray-600">This action can't be undone.</p>
        </div>
      `, [
        { label: 'Cancel', class: 'btn-ghost', action: () => closeModal() },
        { label: 'Remove', class: 'btn-danger', action: () => {
          performDeletion(section);
          closeModal();
        }}
      ]);
    };
    
    function performDeletion(section) {
      const selectedIds = Array.from(state.selectedItems[section]);
      
      // Save current state for undo
      if (section === 'objectives') {
        state.undoStates[section] = [...state.objectives];
        state.objectives = state.objectives.filter(o => !selectedIds.includes(o.id));
      } else if (section === 'valueRealized') {
        state.undoStates[section] = [...state.valueRealized];
        state.valueRealized = state.valueRealized.filter(v => !selectedIds.includes(v.id));
      } else if (section === 'pastObjectives') {
        state.undoStates[section] = [...state.pastObjectives];
        state.pastObjectives = state.pastObjectives.filter(o => !selectedIds.includes(o.id));
      }
      
      // Clear selections
      state.selectedItems[section].clear();
      
      // Exit edit mode
      cancelEditMode(section);
      
      // Update UI
      renderAll();
      saveToLocalStorage();
      
      // Show toast with undo
      showToastWithUndo('Items removed', () => undoDeletion(section));
    }
    
    function undoDeletion(section) {
      if (state.undoStates[section]) {
        if (section === 'objectives') {
          state.objectives = state.undoStates[section];
        } else if (section === 'valueRealized') {
          state.valueRealized = state.undoStates[section];
        } else if (section === 'pastObjectives') {
          state.pastObjectives = state.undoStates[section];
        }
        
        state.undoStates[section] = null;
        renderAll();
        saveToLocalStorage();
        showNotification('Deletion undone', 'success');
      }
    }
    
    function showToastWithUndo(message, undoCallback) {
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.setAttribute('role', 'status');
      toast.setAttribute('aria-live', 'polite');
      toast.innerHTML = `
        <span>${message}</span>
        <button class="toast-undo" aria-label="Undo deletion">Undo</button>
      `;
      
      document.body.appendChild(toast);
      
      const undoBtn = toast.querySelector('.toast-undo');
      undoBtn.addEventListener('click', () => {
        undoCallback();
        toast.remove();
      });
      
      // Auto-remove after 10 seconds
      setTimeout(() => {
        toast.style.animation = 'fadeOut 0.3s ease';
        setTimeout(() => toast.remove(), 300);
      }, 10000);
    }
    
    window.removePastObjective = function(id) {
      if (confirm('Are you sure you want to permanently remove this past objective?')) {
        state.pastObjectives = state.pastObjectives.filter(o => o.id !== id);
        renderAll();
        saveToLocalStorage();
        showNotification('Past objective removed', 'success');
      }
    };

    window.updateKPIPeriod = function(objectiveId, kpiId, period) {
      const obj = state.objectives.find(o => o.id === objectiveId);
      if (!obj) return;
      
      const kpi = obj.kpis.find(k => k.id === kpiId);
      if (!kpi) return;
      
      kpi.period = period;
      renderAll();
      saveToLocalStorage();
    };

    window.toggleKPIComparison = function(objectiveId, kpiId) {
      const obj = state.objectives.find(o => o.id === objectiveId);
      if (!obj) return;
      
      const kpi = obj.kpis.find(k => k.id === kpiId);
      if (!kpi) return;
      
      kpi.comparePrevious = true;
      renderAll();
      saveToLocalStorage();
    };

    // ---------- Notifications ----------
    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = `fixed top-4 right-4 p-4 shadow-lg z-50 font-medium min-w-[300px] ${
        type === 'success' ? 'bg-gradient-to-r from-emerald-500 to-emerald-600 text-white' : 
        type === 'error' ? 'bg-gradient-to-r from-red-500 to-red-600 text-white' : 
        'bg-gradient-to-r from-teal-500 to-teal-600 text-white'
      }`;
      notification.textContent = message;
      notification.style.animation = 'slideIn 0.3s ease';
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.animation = 'fadeOut 0.3s ease';
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }

    // ---------- Event Handlers ----------
    function setupEventHandlers() {
      // Customer name editing
      $('#customer-name-display')?.addEventListener('click', () => {
        const modal = createModal('Edit Customer Name', `
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium mb-1">Customer Name</label>
              <input type="text" id="edit-customer-name" class="text-zone p-3 w-full text-lg" value="${state.customerName}" placeholder="Enter customer name">
            </div>
          </div>
        `, [
          { label: 'Cancel', class: 'btn-ghost', action: () => closeModal() },
          { label: 'Save', class: 'btn-primary', action: () => {
            const newName = $('#edit-customer-name').value.trim();
            if (newName) {
              state.customerName = newName;
              $('#customer-name-display').textContent = newName;
              saveToLocalStorage();
              closeModal();
              showNotification('Customer name updated', 'success');
            } else {
              showNotification('Please enter a customer name', 'error');
            }
          }}
        ]);
        
        // Focus the input and handle Enter key
        setTimeout(() => {
          const input = $('#edit-customer-name');
          input?.focus();
          input?.select();
          
          // Handle Enter key
          input?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
              const saveBtn = modal.querySelector('.btn-primary');
              saveBtn?.click();
            }
          });
        }, 100);
      });
      
      // Add objective button
      $('#add-objective-btn')?.addEventListener('click', showAddObjectiveModal);
      
      // Add past objective button
      $('#add-past-objective-btn')?.addEventListener('click', () => {
        showAddObjectiveModal(true);
      });
      
      // Mission goals editing
      document.addEventListener('click', (e) => {
        const target = e.target;
        
        // Mission goals handlers
        if (target.dataset.role === 'add-cf') {
          const card = target.closest('[data-id]');
          const goalId = parseInt(card.dataset.id);
          const goal = state.missionGoals.find(g => g.id === goalId);
          if (!goal.customFields) goal.customFields = [];
          goal.customFields.push({
            id: Date.now(),
            label: 'New Field',
            value: ''
          });
          renderMissionGoalsEdit();
        } else if (target.dataset.role === 'remove-cf') {
          const card = target.closest('[data-id]');
          const fieldEl = target.closest('[data-field-id]');
          const goalId = parseInt(card.dataset.id);
          const fieldId = parseInt(fieldEl.dataset.fieldId);
          const goal = state.missionGoals.find(g => g.id === goalId);
                      goal.customFields = goal.customFields.filter(f => f.id !== fieldId);
          renderMissionGoalsEdit();
        } else if (target.dataset.role === 'remove-goal') {
          const card = target.closest('[data-id]');
          const goalId = parseInt(card.dataset.id);
          state.missionGoals = state.missionGoals.filter(g => g.id !== goalId);
          renderMissionGoalsEdit();
        }
      });
      
      // Mission goals inputs
      document.addEventListener('input', (e) => {
        const target = e.target;
        
        // Mission goals
        if (target.closest('#mission-goals-container')) {
          const card = target.closest('[data-id]');
          if (!card) return;
          
          const goalId = parseInt(card.dataset.id);
          const goal = state.missionGoals.find(g => g.id === goalId);
          
          if (target.dataset.role === 'goal-title') {
            goal.title = target.value;
          } else if (target.dataset.role === 'goal-desc') {
            goal.description = target.value;
            autoResizeTextarea(target);
          } else if (target.dataset.role === 'cf-label' || target.dataset.role === 'cf-value') {
            const fieldEl = target.closest('[data-field-id]');
            const fieldId = parseInt(fieldEl.dataset.fieldId);
            const field = goal.customFields.find(f => f.id === fieldId);
            if (target.dataset.role === 'cf-label') {
              field.label = target.value;
            } else {
              field.value = target.value;
            }
          }
        }
      });
      
      // Add buttons
      $('#add-mission-goal-btn')?.addEventListener('click', () => {
        state.missionGoals.push({
          id: Date.now(),
          title: 'New Goal',
          description: '',
          customFields: []
        });
        renderMissionGoalsEdit();
      });
      
      // Add value button is now handled by showAddValueModal
      
      // Stakeholder select
      $('#add-stakeholder-select')?.addEventListener('change', (e) => {
        const value = e.target.value;
        if (value === 'new') {
          // Show new stakeholder modal
          const modal = createModal('Add New Stakeholder', `
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium mb-1">Name</label>
                <input type="text" id="new-name" class="text-zone p-2 w-full" placeholder="Full name">
              </div>
              <div>
                <label class="block text-sm font-medium mb-1">Title</label>
                <input type="text" id="new-title" class="text-zone p-2 w-full" placeholder="Job title">
              </div>
              <div>
                <label class="block text-sm font-medium mb-1">Email</label>
                <input type="email" id="new-email" class="text-zone p-2 w-full" placeholder="email@company.com">
              </div>
            </div>
          `, [
            { label: 'Cancel', class: 'btn-ghost', action: () => closeModal() },
            { label: 'Add Stakeholder', class: 'btn-primary', action: () => {
              const stakeholder = {
                id: Date.now(),
                name: $('#new-name').value.trim(),
                title: $('#new-title').value.trim(),
                email: $('#new-email').value.trim()
              };
              
              if (!stakeholder.name || !stakeholder.email) {
                showNotification('Name and email are required', 'error');
                return;
              }
              
              if (!stakeholder.email.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)) {
                showNotification('Please enter a valid email address', 'error');
                return;
              }
              
              state.stakeholders.push(stakeholder);
              renderAll();
              saveToLocalStorage();
              closeModal();
              showNotification('Stakeholder added', 'success');
            }}
          ]);
        } else if (value) {
          const contact = mockContacts.find(c => c.id === parseInt(value));
          if (contact) {
            state.stakeholders.push(contact);
            renderAll();
            saveToLocalStorage();
          }
        }
        e.target.value = '';
      });
      
      // Health score
      $('#health-score')?.addEventListener('change', (e) => {
        state.planHealth = e.target.value;
        saveToLocalStorage();
      });
      
      // Export buttons
      $('#export-pdf-btn')?.addEventListener('click', exportToPDF);
      $('#export-excel-btn')?.addEventListener('click', exportToExcel);
      
      // Add data backup/restore functionality
      addDataBackupButtons();
    }

    // ---------- Export Functions (Modernized PDF Generator) ----------
    async function exportToPDF() {
      showPDFExportModal();
    }

    // Preset definitions for consistent, perfectly-aligned layouts
    function getPDFPresets() {
      return {
        Executive: {
          includeSummary: true,
          includeGoals: true,
          includeObjectives: true,
          includeValue: true,
          includePast: false,
          includeStakeholders: true,
          headerStyle: 'bar',
          kpiColumns: 3,
          orientation: 'p',
          pageSize: 'a4',
          showPageNumbers: true,
          showFooterNote: true
        },
        Detailed: {
          includeSummary: true,
          includeGoals: true,
          includeObjectives: true,
          includeValue: true,
          includePast: true,
          includeStakeholders: true,
          headerStyle: 'bar',
          kpiColumns: 3,
          orientation: 'p',
          pageSize: 'a4',
          showPageNumbers: true,
          showFooterNote: true
        },
        Compact: {
          includeSummary: true,
          includeGoals: false,
          includeObjectives: true,
          includeValue: false,
          includePast: false,
          includeStakeholders: false,
          headerStyle: 'minimal',
          kpiColumns: 2,
          orientation: 'p',
          pageSize: 'a4',
          showPageNumbers: true,
          showFooterNote: false
        }
      };
    }

    function buildOptionsFromPreset(presetName) {
      const presets = getPDFPresets();
      const base = presets[presetName] || presets.Executive;
      return { ...base };
    }

    window.showPDFExportModal = function() {
      const modal = createModal('Export Report', `
        <div class="space-y-6">
          <div>
            <div class="text-sm text-gray-600 mb-2">Choose a preset or use Custom to configure sections</div>
            <div class="grid grid-cols-4 gap-2">
              <button id="preset-Executive" class="btn btn-ghost border">Executive</button>
              <button id="preset-Detailed" class="btn btn-ghost border">Detailed</button>
              <button id="preset-Compact" class="btn btn-ghost border">Compact</button>
              <button id="preset-Custom" class="btn btn-primary">Custom</button>
            </div>
          </div>

          <div id="custom-config" class="space-y-4">
            <p class="text-gray-600">Select the sections to include in your report:</p>
            <div class="grid grid-cols-2 gap-3">
              <label class="flex items-center gap-3 p-3 border rounded hover:bg-gray-50 cursor-pointer">
                <input type="checkbox" id="export-summary" checked class="w-5 h-5 text-teal-600">
                <div>
                  <div class="font-medium">Executive Summary</div>
                  <div class="text-sm text-gray-500">Mission statement and account health</div>
                </div>
              </label>
              <label class="flex items-center gap-3 p-3 border rounded hover:bg-gray-50 cursor-pointer">
                <input type="checkbox" id="export-goals" checked class="w-5 h-5 text-teal-600">
                <div>
                  <div class="font-medium">Mission Goals</div>
                  <div class="text-sm text-gray-500">Strategic objectives and key initiatives</div>
                </div>
              </label>
              <label class="flex items-center gap-3 p-3 border rounded hover:bg-gray-50 cursor-pointer">
                <input type="checkbox" id="export-objectives" checked class="w-5 h-5 text-teal-600">
                <div>
                  <div class="font-medium">Current Objectives</div>
                  <div class="text-sm text-gray-500">Active objectives with KPIs and metrics</div>
                </div>
              </label>
              <label class="flex items-center gap-3 p-3 border rounded hover:bg-gray-50 cursor-pointer">
                <input type="checkbox" id="export-value" checked class="w-5 h-5 text-teal-600">
                <div>
                  <div class="font-medium">Value Realized</div>
                  <div class="text-sm text-gray-500">Business impact and ROI achieved</div>
                </div>
              </label>
              <label class="flex items-center gap-3 p-3 border rounded hover:bg-gray-50 cursor-pointer">
                <input type="checkbox" id="export-past" checked class="w-5 h-5 text-teal-600">
                <div>
                  <div class="font-medium">Past Objectives</div>
                  <div class="text-sm text-gray-500">Completed milestones and achievements</div>
                </div>
              </label>
              <label class="flex items-center gap-3 p-3 border rounded hover:bg-gray-50 cursor-pointer">
                <input type="checkbox" id="export-stakeholders" checked class="w-5 h-5 text-teal-600">
                <div>
                  <div class="font-medium">Key Stakeholders</div>
                  <div class="text-sm text-gray-500">Primary contacts and their roles</div>
                </div>
              </label>
            </div>

            <div class="grid grid-cols-3 gap-3">
              <label class="flex items-center justify-between p-3 border rounded">
                <span class="text-sm text-gray-600">KPI columns</span>
                <select id="kpi-columns" class="text-zone p-1 text-sm">
                  <option value="2">2</option>
                  <option value="3" selected>3</option>
                  <option value="4">4</option>
                </select>
              </label>
              <label class="flex items-center justify-between p-3 border rounded">
                <span class="text-sm text-gray-600">Header</span>
                <select id="header-style" class="text-zone p-1 text-sm">
                  <option value="minimal">Minimal</option>
                  <option value="bar" selected>Accent Bar</option>
                </select>
              </label>
              <label class="flex items-center justify-between p-3 border rounded">
                <span class="text-sm text-gray-600">Orientation</span>
                <select id="page-orientation" class="text-zone p-1 text-sm">
                  <option value="p" selected>Portrait</option>
                  <option value="l">Landscape</option>
                </select>
              </label>
            </div>
            <div class="flex items-center gap-6">
              <label class="flex items-center gap-2">
                <input id="opt-page-numbers" type="checkbox" checked>
                <span class="text-sm text-gray-600">Show page numbers</span>
              </label>
              <label class="flex items-center gap-2">
                <input id="opt-footer-note" type="checkbox" checked>
                <span class="text-sm text-gray-600">Show footer note</span>
              </label>
            </div>
          </div>
        </div>
      `, [
        { label: 'Cancel', class: 'btn-ghost', action: () => closeModal() },
        { label: 'Export PDF', class: 'btn-primary', action: () => {
          const isCustom = document.querySelector('#preset-Custom')?.classList.contains('btn-primary');
          let options;
          if (!isCustom) {
            const active = Array.from(['Executive','Detailed','Compact']).find(name => document.querySelector(`#preset-${name}`)?.classList.contains('btn-primary')) || 'Executive';
            options = buildOptionsFromPreset(active);
          } else {
            options = {
              includeSummary: $('#export-summary').checked,
              includeGoals: $('#export-goals').checked,
              includeObjectives: $('#export-objectives').checked,
              includeValue: $('#export-value').checked,
              includePast: $('#export-past').checked,
              includeStakeholders: $('#export-stakeholders').checked,
              kpiColumns: parseInt($('#kpi-columns').value, 10),
              headerStyle: $('#header-style').value,
              orientation: $('#page-orientation').value,
              pageSize: 'a4',
              showPageNumbers: $('#opt-page-numbers').checked,
              showFooterNote: $('#opt-footer-note').checked
            };
          }
          closeModal();
          generateModernPDF(options);
        }}
      ]);

      // Preset interaction
      const presetButtons = ['Executive','Detailed','Compact','Custom'];
      function activatePreset(name) {
        presetButtons.forEach(n => {
          const el = document.querySelector(`#preset-${n}`);
          if (!el) return;
          el.classList.toggle('btn-primary', n === name);
          el.classList.toggle('btn-ghost', n !== name);
        });
        const isCustom = name === 'Custom';
        document.querySelector('#custom-config').style.display = isCustom ? 'block' : 'none';
        if (!isCustom) {
          const p = buildOptionsFromPreset(name);
          $('#export-summary').checked = p.includeSummary;
          $('#export-goals').checked = p.includeGoals;
          $('#export-objectives').checked = p.includeObjectives;
          $('#export-value').checked = p.includeValue;
          $('#export-past').checked = p.includePast;
          $('#export-stakeholders').checked = p.includeStakeholders;
          $('#kpi-columns').value = String(p.kpiColumns);
          $('#header-style').value = p.headerStyle;
          $('#page-orientation').value = p.orientation;
          $('#opt-page-numbers').checked = p.showPageNumbers;
          $('#opt-footer-note').checked = p.showFooterNote;
        }
      }
      presetButtons.forEach(n => document.querySelector(`#preset-${n}`)?.addEventListener('click', () => activatePreset(n)));
      activatePreset('Custom');
    };

    // New, alignment-precise generator
    async function generateModernPDF(options) {
      const btn = $('#export-pdf-btn');
      btn.disabled = true;
      btn.innerHTML = '<span class="animate-spin">⟳</span> Generating...';

      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF(options.orientation || 'p', 'mm', options.pageSize || 'a4');

        // Layout constants
        const page = { width: doc.internal.pageSize.getWidth(), height: doc.internal.pageSize.getHeight() };
        const margin = { left: 15, right: 15, top: 18, bottom: 18 };
        const content = { x: margin.left, y: margin.top, w: page.width - margin.left - margin.right };
        const spacing = { xs: 3, sm: 6, md: 10, lg: 14 };

        // Theme
        const colors = {
          primary: [32, 41, 57],
          accent: [14, 165, 233],
          success: [34, 197, 94],
          warning: [245, 158, 11],
          danger: [239, 68, 68],
          text: [31, 41, 55],
          textLight: [100, 116, 139],
          border: [226, 232, 240],
          background: [248, 250, 252],
          white: [255, 255, 255]
        };

        // Helpers
        function ensurePage(spaceNeeded) {
          if (content.y + spaceNeeded <= page.height - margin.bottom) return;
          doc.addPage();
          content.y = margin.top;
          drawHeader();
          content.y += spacing.md;
        }

        function textBlock(text, x, y, w, fontSize, color, fontStyle = 'normal', leading = 1.4) {
          doc.setTextColor(...color);
          doc.setFontSize(fontSize);
          doc.setFont(undefined, fontStyle);
          const lines = doc.splitTextToSize(text, w);
          doc.text(lines, x, y);
          const height = lines.length * (fontSize * leading) * 0.3528; // px to mm approx factor for font metrics
          return height;
        }

        function centeredTextInRect(text, x, y, w, h, fontSize, color, fontStyle = 'bold') {
          doc.setFontSize(fontSize);
          doc.setFont(undefined, fontStyle);
          const cx = x + (w / 2);
          const cy = y + (h / 2);
          doc.setTextColor(...color);
          doc.text(text, cx, cy, { align: 'center', baseline: 'middle' });
        }

        function drawNumberCircle(numText, cx, cy, r, fill, textColor) {
          doc.setFillColor(...fill);
          doc.circle(cx, cy, r, 'F');
          const fontSize = r * 1.6; // scale font to circle
          doc.setFont(undefined, 'bold');
          doc.setFontSize(fontSize);
          doc.setTextColor(...textColor);
          doc.text(String(numText), cx, cy, { align: 'center', baseline: 'middle' });
        }

        function drawStatusPill(text, x, y, fill, textColor) {
          doc.setFontSize(9);
          doc.setFont(undefined, 'bold');
          const dims = doc.getTextDimensions(text);
          const padX = 3.8, padY = 2.6;
          const w = dims.w + padX * 2;
          const h = dims.h + padY * 2;
          doc.setFillColor(...fill);
          doc.roundedRect(x, y, w, h, 3, 3, 'F');
          centeredTextInRect(text, x, y, w, h, 9, textColor, 'bold');
          return { w, h };
        }

        function drawHeader() {
          if ((options.headerStyle || 'bar') === 'bar') {
            doc.setFillColor(...colors.primary);
            doc.rect(0, 0, page.width, 18, 'F');
            doc.setTextColor(...colors.white);
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text('Receptive', margin.left, 12, { baseline: 'middle' });
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text('Customer Success Report', margin.left + 35, 12, { baseline: 'middle' });
            doc.setFontSize(9);
            doc.text(new Date().toLocaleDateString(), page.width - margin.right, 12, { align: 'right', baseline: 'middle' });
          } else {
            doc.setTextColor(...colors.text);
            doc.setFontSize(13);
            doc.setFont(undefined, 'bold');
            doc.text('Receptive • Customer Success Report', margin.left, 12, { baseline: 'middle' });
          }
        }

        function sectionHeading(title, minBodyHeight = 18) {
          const barH = 7;
          const spaceNeeded = barH + spacing.sm + (minBodyHeight || 0);
          ensurePage(spaceNeeded);
          // Subtle accent bar
          doc.setFillColor(...colors.accent);
          doc.rect(0, content.y, page.width, barH, 'F');
          doc.setTextColor(...colors.white);
          doc.setFontSize(11);
          doc.setFont(undefined, 'bold');
          doc.text(title.toUpperCase(), margin.left, content.y + barH / 2, { baseline: 'middle' });
          content.y += barH + spacing.sm;
        }

        function kpiGrid(kpis, columns) {
          if (!kpis || kpis.length === 0) return;
          const gap = spacing.md;
          const cardW = (content.w - gap * (columns - 1)) / columns;
          const cardH = 34;
          let col = 0;
          kpis.forEach((kpi, idx) => {
            if (col === 0) ensurePage(cardH + spacing.sm);
            const x = content.x + (cardW + gap) * col;
            const y = content.y;
            // Card
            doc.setFillColor(...colors.white);
            doc.setDrawColor(...colors.border);
            doc.roundedRect(x, y, cardW, cardH, 2, 2, 'FD');
            // Label
            doc.setTextColor(...colors.textLight);
            doc.setFontSize(8);
            doc.setFont(undefined, 'normal');
            const type = getKPIType(kpi.typeKey);
            doc.text(type.label, x + cardW / 2, y + 7, { align: 'center', baseline: 'middle' });
            // Value
            doc.setTextColor(...colors.text);
            doc.setFontSize(17);
            doc.setFont(undefined, 'bold');
            doc.text(`${kpi.currentValue}${type.unit}`, x + cardW / 2, y + 19, { align: 'center', baseline: 'middle' });
            // Delta
            if (kpi.comparePrevious && kpi.previousValue) {
              const delta = calculateDelta(kpi.currentValue, kpi.previousValue);
              const c = delta >= 0 ? colors.success : colors.danger;
              doc.setTextColor(...c);
              doc.setFontSize(9);
              doc.setFont(undefined, 'bold');
              doc.text(`${delta >= 0 ? '+' : ''}${delta}%`, x + cardW / 2, y + 27, { align: 'center', baseline: 'middle' });
            }
            col++;
            if (col >= columns) {
              col = 0;
              content.y += cardH + gap;
            }
          });
          if (col !== 0) content.y += cardH + spacing.md;
        }

        // Build document
        drawHeader();
        content.y = 24;

        // Account Overview strip
        ensurePage(32);
        doc.setFillColor(...colors.background);
        doc.rect(content.x, content.y, content.w, 28, 'F');
        // Name
        doc.setTextColor(...colors.text);
        doc.setFontSize(16);
        doc.setFont(undefined, 'bold');
        doc.text(state.customerName, content.x + 10, content.y + 11, { baseline: 'middle' });
        // Health chip perfectly centered
        const healthMap = { green: { label: 'Healthy', color: colors.success }, yellow: { label: 'At Risk', color: colors.warning }, red: { label: 'Critical', color: colors.danger } };
        const hc = healthMap[state.planHealth] || healthMap.green;
        const chip = drawStatusPill(hc.label, content.x + 10, content.y + 15, hc.color, colors.white);
        // Products
        doc.setTextColor(...colors.textLight);
        doc.setFontSize(9);
        doc.setFont(undefined, 'normal');
        doc.text(`Products: ${state.products.join(', ')}`, content.x + 10 + chip.w + 6, content.y + 19, { baseline: 'middle' });
        content.y += 32;

        // Executive Summary
        if (options.includeSummary && state.missionSummary) {
          sectionHeading('Executive Summary', 24);
          // Split summary into paragraphs for elegant layout
          const parts = String(state.missionSummary).split(/\n\n+/).map(s => s.trim()).filter(Boolean);
          parts.forEach((para, idx) => {
            const h = textBlock(para, content.x, content.y, content.w, 10, colors.text, 'normal', 1.55);
            content.y += h;
            if (idx < parts.length - 1) content.y += spacing.sm;
          });
          content.y += spacing.md;
        }

        // Mission Goals
        if (options.includeGoals && state.missionGoals.length > 0) {
          sectionHeading('Mission Goals', 22);
          state.missionGoals.forEach((goal, idx) => {
            const est = 18; // estimated header block
            const lines = doc.splitTextToSize(goal.description, content.w - 22);
            const h = lines.length * (10 * 1.35) * 0.3528;
            ensurePage(Math.min(est + h + spacing.md, 50));
            // Badge
            drawNumberCircle(idx + 1, content.x + 6, content.y + 7.5, 6.5, colors.accent, colors.white);
            // Title
            doc.setTextColor(...colors.text);
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            doc.text(goal.title, content.x + 22, content.y + 6, { baseline: 'middle' });
            // Description
            doc.setTextColor(...colors.textLight);
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(lines, content.x + 22, content.y + 12);
            content.y += est + h;
          });
          content.y += spacing.sm;
        }

        // Current Objectives
        if (options.includeObjectives && state.objectives.length > 0) {
          sectionHeading('Current Objectives', 30);
          state.objectives.forEach(obj => {
            // Preflight height estimate to avoid starting an objective at the bottom
            const columns = Math.max(2, Math.min(4, options.kpiColumns || 3));
            const descLines = obj.description ? doc.splitTextToSize(String(obj.description), content.w - 4) : [];
            const descH = descLines.length * (9.5 * 1.5) * 0.3528; // approximate
            const kpiCount = (obj.kpis || []).length;
            const kpiRows = kpiCount > 0 ? Math.ceil(kpiCount / columns) : 0;
            const kpiH = kpiRows > 0 ? (kpiRows * (34 + spacing.md)) : 0;
            const objectiveMin = 14 /* header */ + spacing.sm /* meta */ + descH + (descH ? spacing.sm : 0) + kpiH + spacing.md;
            ensurePage(Math.min(objectiveMin, 70)); // require at least a reasonable chunk to avoid orphan headers

            // Header row
            ensurePage(20);
            doc.setFillColor(...colors.white);
            doc.setDrawColor(...colors.border);
            doc.roundedRect(content.x, content.y, content.w, 10, 2, 2, 'FD');
            doc.setTextColor(...colors.text);
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            doc.text(obj.name, content.x + 4, content.y + 7, { baseline: 'middle' });
            // Status right-aligned chip
            const statusMap = { 'On Track': colors.success, 'At Risk': colors.warning, 'Completed': colors.success, 'Not Started': colors.text, 'In Progress': colors.accent };
            const chipText = obj.status;
            const dims = doc.getTextDimensions(chipText);
            const padX = 3.2, padY = 2.2;
            const w = dims.w + padX * 2;
            const h = dims.h + padY * 2;
            const chipX = content.x + content.w - w - 4;
            const chipY = content.y + 2;
            doc.setFillColor(...(statusMap[obj.status] || colors.textLight));
            doc.roundedRect(chipX, chipY, w, h, 3, 3, 'F');
            const chipTextColor = obj.status === 'Not Started' ? colors.white : colors.white;
            centeredTextInRect(chipText, chipX, chipY, w, h, 9, chipTextColor, 'bold');
            content.y += 14;

            // Meta
            doc.setTextColor(...colors.textLight);
            doc.setFontSize(9);
            doc.setFont(undefined, 'normal');
            doc.text(`Target: ${obj.targetDate || 'Not set'}`, content.x + 2, content.y, { baseline: 'middle' });
            content.y += spacing.sm;

            // Description
            if (obj.description) {
              const paras = String(obj.description).split(/\n\n+/).map(s => s.trim()).filter(Boolean);
              paras.forEach((para, idx) => {
                const h = textBlock(para, content.x + 2, content.y, content.w - 4, 9.5, colors.text, 'normal', 1.5);
                content.y += h;
                if (idx < paras.length - 1) content.y += spacing.xs;
              });
              content.y += spacing.sm;
            }

            // KPIs grid
            if (obj.kpis && obj.kpis.length > 0) {
              kpiGrid(obj.kpis, columns);
            }

            content.y += spacing.md;
          });
        }

        // Value Realized
        if (options.includeValue && state.valueRealized.length > 0) {
          sectionHeading('Value Realized', 24);
          state.valueRealized.forEach(value => {
            const lines = doc.splitTextToSize(value.description, content.w - 22);
            const h = lines.length * (10 * 1.35) * 0.3528;
            ensurePage(Math.min(26 + h, 50));
            // Icon
            doc.setFillColor(...colors.success);
            doc.circle(content.x + 5, content.y + 6, 4, 'F');
            doc.setTextColor(...colors.white);
            doc.setFontSize(9);
            doc.setFont(undefined, 'bold');
            doc.text('✓', content.x + 5, content.y + 7.6, { align: 'center', baseline: 'middle' });
            // Title/date
            doc.setTextColor(...colors.text);
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            doc.text(value.type, content.x + 16, content.y + 6, { baseline: 'middle' });
            doc.setTextColor(...colors.textLight);
            doc.setFontSize(9);
            doc.setFont(undefined, 'normal');
            doc.text(value.date || 'Not specified', content.x + content.w, content.y + 6, { align: 'right', baseline: 'middle' });
            // Description
            doc.setTextColor(...colors.text);
            doc.setFontSize(10);
            doc.text(lines, content.x + 16, content.y + 12);
            content.y += 20 + h;
          });
          content.y += spacing.sm;
        }

        // Past Objectives
        if (options.includePast && state.pastObjectives.length > 0) {
          sectionHeading('Completed Objectives', 18);
          state.pastObjectives.forEach(obj => {
            ensurePage(18);
            doc.setTextColor(...colors.success);
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            doc.text('✓', content.x + 2, content.y + 3, { baseline: 'middle' });
            doc.setTextColor(...colors.text);
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text(obj.name, content.x + 8, content.y + 3, { baseline: 'middle' });
            doc.setTextColor(...colors.textLight);
            doc.setFontSize(9);
            doc.setFont(undefined, 'normal');
            doc.text(`Completed: ${obj.targetDate || 'Not specified'}`, content.x + 8, content.y + 8, { baseline: 'middle' });
            content.y += spacing.md;
          });
        }

        // Stakeholders
        if (options.includeStakeholders && state.stakeholders.length > 0) {
          sectionHeading('Key Stakeholders', 18);
          const cols = [
            { label: 'Name', w: content.w * 0.33 },
            { label: 'Title', w: content.w * 0.27 },
            { label: 'Email', w: content.w * 0.40 }
          ];
          ensurePage(12);
          // Header
          doc.setFillColor(...colors.background);
          doc.rect(content.x, content.y, content.w, 10, 'F');
          doc.setTextColor(...colors.text);
          doc.setFontSize(10);
          doc.setFont(undefined, 'bold');
          let cx = content.x + 2;
          cols.forEach(c => { doc.text(c.label, cx, content.y + 7, { baseline: 'middle' }); cx += c.w; });
          content.y += 12;
          // Rows
          doc.setFont(undefined, 'normal');
          doc.setTextColor(...colors.text);
          state.stakeholders.forEach(st => {
            ensurePage(10);
            let x = content.x + 2;
            doc.text(st.name, x, content.y + 4, { baseline: 'middle' }); x += cols[0].w;
            doc.text(st.title, x, content.y + 4, { baseline: 'middle' }); x += cols[1].w;
            doc.text(st.email, x, content.y + 4, { baseline: 'middle' });
            doc.setDrawColor(...colors.border);
            doc.line(content.x, content.y + 6, content.x + content.w, content.y + 6);
            content.y += 8;
          });
        }

        // Footer
        if (options.showPageNumbers || options.showFooterNote) {
          const pageCount = doc.internal.getNumberOfPages();
          for (let i = 1; i <= pageCount; i++) {
            doc.setPage(i);
            if (options.showFooterNote) {
              doc.setDrawColor(...colors.border);
              doc.line(margin.left, page.height - margin.bottom + 4, page.width - margin.right, page.height - margin.bottom + 4);
              doc.setTextColor(...colors.textLight);
              doc.setFontSize(8);
              doc.text('Confidential - Receptive Platform', margin.left, page.height - margin.bottom + 10, { baseline: 'middle' });
            }
            if (options.showPageNumbers) {
              doc.setTextColor(...colors.textLight);
              doc.setFontSize(8);
              doc.text(`Page ${i} of ${pageCount}`, page.width - margin.right, page.height - margin.bottom + 10, { align: 'right', baseline: 'middle' });
            }
          }
        }

        const fileName = `${state.customerName.toLowerCase().replace(/\s+/g, '-')}-success-report-${new Date().toISOString().split('T')[0]}.pdf`;
        doc.save(fileName);
        showNotification('Report exported successfully!', 'success');
      } catch (error) {
        console.error('PDF export error:', error);
        showNotification('Failed to generate report. Please try again.', 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V7.414A2 2 0 0015.414 6L12 2.586A2 2 0 0010.586 2H6zm5 6a1 1 0 10-2 0v3.586l-1.293-1.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V8z" clip-rule="evenodd" /></svg>Generate PDF Report';
      }
    }

    // Lightweight automated layout tests (run manually via console: runAutomatedPDFLayoutTests())
    window.runAutomatedPDFLayoutTests = function() {
      const presets = Object.keys(getPDFPresets());
      const scenarios = [
        () => ({ ...buildOptionsFromPreset(presets[0]), kpiColumns: 3 }),
        () => ({ ...buildOptionsFromPreset(presets[1]), includeGoals: true, kpiColumns: 2 }),
        () => ({ ...buildOptionsFromPreset(presets[2]), orientation: 'l', kpiColumns: 4 })
      ];
      let success = 0;
      scenarios.forEach((make, i) => {
        try { generateModernPDF(make()); success++; } catch(e) { console.error('Test failed', i+1, e); }
      });
      showNotification(`PDF layout tests executed: ${success}/${scenarios.length} succeeded`, success === scenarios.length ? 'success' : 'error');
    };

    // Scenario-based stress tests that mutate data counts and content safely
    window.runPDFStressTests = function() {
      const original = JSON.parse(JSON.stringify(state));
      let success = 0, total = 0;

      function withState(tempState, fn) {
        Object.assign(state, tempState);
        try { fn(); success++; } catch (e) { console.error('Stress test error:', e); }
        Object.assign(state, original);
      }

      // Scenario 1: Minimal concise report with 2 objectives
      total++;
      withState({
        objectives: original.objectives.slice(0, 2).map((o, i) => ({
          ...o,
          status: i % 2 === 0 ? 'In Progress' : 'Not Started',
          kpis: (o.kpis || []).slice(0, 3)
        })),
        pastObjectives: original.pastObjectives.slice(0, 1)
      }, () => generateModernPDF({ ...buildOptionsFromPreset('Compact'), includeGoals: true }));

      // Scenario 2: Rich KPIs with 5 objectives and 2 rows of KPI grid
      total++;
      withState({
        objectives: (original.objectives.concat(original.objectives)).slice(0, 5).map((o, i) => ({
          ...o,
          status: ['On Track','At Risk','Completed','In Progress','Not Started'][i % 5],
          kpis: (o.kpis || []).concat(o.kpis || []).slice(0, 6)
        })),
        pastObjectives: original.pastObjectives.slice(0, 3)
      }, () => generateModernPDF({ ...buildOptionsFromPreset('Executive'), kpiColumns: 3 }));

      // Scenario 3: Heavy past objectives and landscape orientation
      total++;
      withState({
        objectives: original.objectives.slice(0, 3),
        pastObjectives: (original.pastObjectives.concat(original.pastObjectives).concat(original.pastObjectives)).slice(0, 10)
      }, () => generateModernPDF({ ...buildOptionsFromPreset('Detailed'), orientation: 'l', includeGoals: true }));

      showNotification(`PDF stress tests executed: ${success}/${total} scenarios succeeded`, success === total ? 'success' : 'error');
    };

    function exportToExcel() {
      try {
        // Exit any active edit modes before export
        ['objectives', 'valueRealized', 'pastObjectives'].forEach(section => {
          if (state.editModes[section]) {
            cancelEditMode(section);
          }
        });
        
        const wb = XLSX.utils.book_new();
        
        // Plan Overview
        const overview = [{
          'Executive Summary': state.missionSummary,
          'Health Status': state.planHealth,
          'Active Products': state.products.join(', ')
        }];
        
        // Objectives with KPIs
        const objectives = [];
        state.objectives.forEach(obj => {
          objectives.push({
            'Objective': obj.name,
            'Status': obj.status,
            'Target Date': obj.targetDate,
            'Type': 'Current'
          });
          
          if (obj.kpis) {
            obj.kpis.forEach(kpi => {
              const type = getKPIType(kpi.typeKey);
              objectives.push({
                'Objective': `  → ${type.label}`,
                'Status': `${kpi.currentValue} ${type.unit}`,
                'Target Date': `Delta: ${calculateDelta(kpi.currentValue, kpi.previousValue)}%`,
                'Type': 'KPI'
              });
            });
          }
        });
        
        // Add sheets
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(overview), 'Overview');
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(objectives), 'Objectives & KPIs');
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(state.missionGoals), 'Mission Goals');
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(state.valueRealized), 'Value Realized');
        
        XLSX.writeFile(wb, 'customer-success-plan-receptive.xlsx');
        showNotification('Excel exported successfully', 'success');
      } catch (error) {
        showNotification('Excel export failed. Please try again.', 'error');
      }
    }

    // ---------- Data Backup and Restore Functions ----------
    function addDataBackupButtons() {
      // Create hidden file input for import
      const fileInput = document.createElement('input');
      fileInput.type = 'file';
      fileInput.id = 'import-file-input';
      fileInput.accept = '.json';
      fileInput.style.display = 'none';
      document.body.appendChild(fileInput);
      
      // Add event listeners to the buttons
      const exportBtn = document.getElementById('export-data-btn');
      const importBtn = document.getElementById('import-data-btn');
      
      if (exportBtn) {
        exportBtn.addEventListener('click', exportDataBackup);
      }
      
      if (importBtn) {
        importBtn.addEventListener('click', () => fileInput.click());
      }
      
      fileInput.addEventListener('change', importDataBackup);
    }

    function exportDataBackup() {
      try {
        const savedData = localStorage.getItem('responsiveCustomerSuccess');
        if (!savedData) {
          showNotification('No data to export. Please save your changes first.', 'warning');
          return;
        }
        
        const exportData = {
          version: '1.0',
          exportDate: new Date().toISOString(),
          platform: 'Receptive Customer Success Platform',
          data: JSON.parse(savedData)
        };
        
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
        const filename = `customer-success-backup-${timestamp}.json`;
        
        const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showNotification(`Data backed up as ${filename}`, 'success');
      } catch (error) {
        console.error('Export error:', error);
        showNotification('Failed to export data', 'error');
      }
    }

    function importDataBackup(event) {
      const file = event.target.files?.[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const importedData = JSON.parse(e.target.result);
          const data = importedData.data || importedData;
          
          // Validate data structure
          if (!data.customerName && !data.objectives && !data.missionSummary) {
            throw new Error('Invalid data format');
          }
          
          // Show import confirmation modal
          showImportConfirmModal(importedData, file.name);
          
        } catch (error) {
          console.error('Import error:', error);
          showNotification('Failed to import file. Please ensure it\'s a valid backup file.', 'error');
        }
        
        // Reset file input
        event.target.value = '';
      };
      
      reader.readAsText(file);
    }

    function showImportConfirmModal(importedData, filename) {
      const data = importedData.data || importedData;
      const exportDate = importedData.exportDate ? new Date(importedData.exportDate).toLocaleString() : 'Unknown';
      
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      modal.innerHTML = `
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl">
          <h3 class="text-xl font-bold mb-4">Confirm Data Import</h3>
          <div class="mb-4 space-y-2">
            <p class="text-sm text-gray-600">File: <span class="font-medium">${filename}</span></p>
            <p class="text-sm text-gray-600">Export Date: <span class="font-medium">${exportDate}</span></p>
            <p class="text-sm text-gray-600">Customer: <span class="font-medium">${data.customerName || '[Not Set]'}</span></p>
            <p class="text-sm text-gray-600">Objectives: <span class="font-medium">${data.objectives?.length || 0}</span></p>
            <p class="text-sm text-gray-600">Stakeholders: <span class="font-medium">${data.stakeholders?.length || 0}</span></p>
          </div>
          <div class="bg-yellow-50 border border-yellow-200 rounded p-3 mb-4">
            <p class="text-sm text-yellow-800">
              <strong>Warning:</strong> Importing this file will replace all current data. 
              This action cannot be undone. Make sure to export your current data first if needed.
            </p>
          </div>
          <div class="flex gap-3 justify-end">
            <button class="btn bg-gray-300 hover:bg-gray-400 text-gray-800" onclick="this.closest('.fixed').remove()">
              Cancel
            </button>
            <button class="btn bg-red-600 hover:bg-red-700 text-white" id="confirm-import-btn">
              Import and Replace Data
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // Add event listener for confirm button
      document.getElementById('confirm-import-btn').addEventListener('click', () => {
        performImport(data);
        modal.remove();
      });
      
      // Close modal on backdrop click
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.remove();
        }
      });
    }

    function performImport(data) {
      try {
        // Save to localStorage
        localStorage.setItem('responsiveCustomerSuccess', JSON.stringify(data));
        
        // Update the current state
        Object.assign(state, data);
        
        showNotification('Data imported successfully! Refreshing page...', 'success');
        
        // Reload the page to apply changes
        setTimeout(() => {
          window.location.reload();
        }, 1500);
        
      } catch (error) {
        console.error('Import error:', error);
        showNotification('Failed to import data. Please try again.', 'error');
      }
    }

    // ---------- Storage ----------
    function saveToLocalStorage() {
      try {
        localStorage.setItem('responsiveCustomerSuccess', JSON.stringify(state));
      } catch (error) {
        // Silently fail - localStorage may be disabled
      }
    }

    function loadFromLocalStorage() {
      try {
        const saved = localStorage.getItem('responsiveCustomerSuccess');
        if (saved) {
          const savedState = JSON.parse(saved);
          // Only load if the saved state has valid data
          if (savedState && typeof savedState === 'object') {
            // Preserve the default data if saved data is empty
            if (savedState.objectives && savedState.objectives.length > 0) {
              state.objectives = savedState.objectives;
            }
            if (savedState.pastObjectives && savedState.pastObjectives.length > 0) {
              state.pastObjectives = savedState.pastObjectives;
            }
            if (savedState.valueRealized && savedState.valueRealized.length > 0) {
              state.valueRealized = savedState.valueRealized;
            }
            if (savedState.missionGoals && savedState.missionGoals.length > 0) {
              state.missionGoals = savedState.missionGoals;
            }
            if (savedState.stakeholders && savedState.stakeholders.length > 0) {
              state.stakeholders = savedState.stakeholders;
            }
            if (savedState.products && savedState.products.length > 0) {
              state.products = savedState.products;
            }
            if (savedState.customerName) {
              state.customerName = savedState.customerName;
            }
            if (savedState.missionSummary) {
              state.missionSummary = savedState.missionSummary;
            }
            if (savedState.planHealth) {
              state.planHealth = savedState.planHealth;
            }
            // Reset edit states
            state.editModes = {
              objectives: false,
              valueRealized: false,
              pastObjectives: false
            };
            state.selectedItems = {
              objectives: new Set(),
              valueRealized: new Set(),
              pastObjectives: new Set()
            };
          }
        }
      } catch (error) {
        console.error('Error loading from localStorage:', error);
        // Keep default data on error
      }
    }

    // ---------- Render All ----------
    function renderAll() {
      renderCustomerName();
      renderMissionSummary();
      renderMissionGoalsDisplay();
      renderValueDisplay();
      renderObjectives();
      renderStakeholders();
      renderProducts();
      renderHealthScore();
    }
    
    function renderCustomerName() {
      const display = $('#customer-name-display');
      if (display) {
        display.textContent = state.customerName || 'Customer';
      }
    }

    // ---------- Initialize ----------
    function init() {
        // Set date
        const dateEl = $('#last-updated-date');
        if (dateEl) {
          dateEl.textContent = new Date().toLocaleDateString('en-US', { 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
          });
        }
        
        // Set responsive font size for title
        function updateTitleSize() {
          const title = $('#main-title');
          if (title) {
            const width = window.innerWidth;
            if (width >= 1024) {
              title.style.fontSize = '36px';
            } else if (width >= 768) {
              title.style.fontSize = '32px';
            } else {
              title.style.fontSize = '28px';
            }
          }
        }
        
        updateTitleSize();
        window.addEventListener('resize', updateTitleSize);
        
        loadFromLocalStorage();
        renderAll();
        setupSectionEditing();
        setupEventHandlers();
        
        // Add keyboard shortcuts
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') {
            const modal = $('.modal-overlay');
            if (modal) closeModal();
          }
        });
    }

    // Add a global function to reset data if needed
    window.resetToDefaultData = function() {
      localStorage.removeItem('responsiveCustomerSuccess');
      location.reload();
    };
    
    // Debug function to check state
    window.debugState = function() {
      console.log('Current State:', state);
      console.log('Objectives:', state.objectives.length);
      console.log('Past Objectives:', state.pastObjectives.length);
      console.log('Value Realized:', state.valueRealized.length);
      console.log('Mission Goals:', state.missionGoals.length);
      console.log('Products:', state.products);
      console.log('Stakeholders:', state.stakeholders.length);
    };

    // Ensure DOM is ready before initializing
    console.log('Setting up initialization...');
    
    function safeInit() {
      try {
        console.log('Calling init function...');
        // Clear any corrupted localStorage
        try {
          localStorage.removeItem('responsiveCustomerSuccess');
          console.log('Cleared localStorage');
        } catch (e) {
          console.warn('Could not clear localStorage:', e);
        }
        
        init();
        console.log('Init completed successfully!');
      } catch (error) {
        console.error('ERROR in init:', error);
        console.error('Stack trace:', error.stack);
        alert('Application failed to initialize. Check console for errors.\n\nError: ' + error.message);
      }
    }
    
    if (document.readyState === 'loading') {
      console.log('DOM still loading, waiting for DOMContentLoaded...');
      document.addEventListener('DOMContentLoaded', safeInit);
    } else {
      console.log('DOM already loaded, initializing now...');
      setTimeout(safeInit, 100); // Small delay to ensure everything is ready
    }
  </script>
</body>
</html>
