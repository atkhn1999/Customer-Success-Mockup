<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Customer Success Plan - Responsive Platform</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root { 
      --ink: #0f172a; 
      --ink-2: #334155; 
      --ink-3: #64748b;
      --responsive-teal: #14b8a6;
      --responsive-teal-dark: #0d9488;
      --responsive-teal-light: #5eead4;
      --primary-gradient: linear-gradient(135deg, #14b8a6 0%, #0d9488 100%);
      --success-gradient: linear-gradient(135deg, #10b981 0%, #059669 100%);
      --danger-gradient: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      --light-bg: #f8fafc;
      --card-bg: #ffffff;
      --border-color: #e5e7eb;
      --text-primary: #111827;
      --text-secondary: #6b7280;
      --text-tertiary: #9ca3af;
    }
    
    * { 
      box-sizing: border-box; 
      margin: 0;
      padding: 0;
    }
    
    body { 
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
      background: var(--light-bg); 
      color: var(--text-primary); 
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Typography System */
    h1 { 
      font-size: 28px; 
      font-weight: 800; 
      line-height: 1.1; 
      letter-spacing: -0.02em;
      color: var(--text-primary);
    }
    @media (min-width: 768px) {
      h1 {
        font-size: 32px;
      }
    }
    @media (min-width: 1024px) {
      h1 {
        font-size: 36px;
      }
    }
    h2 { 
      font-size: 1.875rem; 
      font-weight: 700; 
      line-height: 1.3; 
      letter-spacing: -0.025em;
      color: var(--text-primary);
    }
    h3 { 
      font-size: 1.25rem; 
      font-weight: 600; 
      line-height: 1.4;
      color: var(--text-primary);
    }
    h4 {
      font-size: 1.125rem;
      font-weight: 600;
      line-height: 1.4;
      color: var(--text-primary);
    }
    
    p {
      margin-bottom: 0.5rem;
    }
    
    /* Text utilities */
    .text-xs { font-size: 0.75rem; line-height: 1rem; }
    .text-sm { font-size: 0.875rem; line-height: 1.25rem; }
    .text-base { font-size: 1rem; line-height: 1.5rem; }
    .text-lg { font-size: 1.125rem; line-height: 1.75rem; }
    .text-xl { font-size: 1.25rem; line-height: 1.75rem; }
    .text-2xl { font-size: 1.5rem; line-height: 2rem; }
    .text-3xl { font-size: 1.875rem; line-height: 2.25rem; }
    
    /* Font weight utilities */
    .font-normal { font-weight: 400; }
    .font-medium { font-weight: 500; }
    .font-semibold { font-weight: 600; }
    .font-bold { font-weight: 700; }
    .font-extrabold { font-weight: 800; }
    .font-light { font-weight: 300; }
    
    /* Text style utilities */
    .italic { font-style: italic; }
    .drop-shadow-lg { 
      text-shadow: 0 10px 15px rgba(0, 0, 0, 0.3), 0 4px 6px rgba(0, 0, 0, 0.2);
    }

    /* Form Controls */
    .text-zone { 
      width: 100%; 
      border-radius: 0; 
      border: 1px solid var(--border-color); 
      background: var(--card-bg); 
      box-shadow: none; 
      transition: all .15s ease; 
      outline: none; 
      font-size: 0.875rem;
      line-height: 1.25rem;
      color: var(--text-primary);
    }
    .text-zone:focus { 
      border-color: var(--responsive-teal); 
      box-shadow: 0 0 0 3px rgba(20, 184, 166, 0.1); 
    }
    .text-zone:disabled {
      background: #f9fafb;
      color: var(--text-tertiary);
      cursor: not-allowed;
    }
    .text-area { 
      resize: none; 
      min-height: 4rem; 
      overflow: hidden; 
      line-height: 1.6; 
    }
    
    select.text-zone {
      cursor: pointer;
      /* Remove default browser arrow */
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      /* Add custom arrow */
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
      background-position: right 0.5rem center;
      background-repeat: no-repeat;
      background-size: 1.5em 1.5em;
      padding-right: 2.5rem;
    }
    
    /* For Internet Explorer */
    select.text-zone::-ms-expand {
      display: none;
    }

    /* Cards */
    .card { 
      background: var(--card-bg); 
      border-radius: 0; 
      box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
      border: 1px solid var(--border-color); 
      transition: all 0.15s ease;
    }
    .card:hover {
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      transform: translateY(-1px);
    }

    /* Buttons */
    .btn { 
      display: inline-flex; 
      align-items: center; 
      justify-content: center;
      gap: .5rem; 
      font-weight: 600; 
      border-radius: 0; 
      padding: .625rem 1.25rem; 
      border: 1px solid transparent; 
      transition: all .15s ease; 
      cursor: pointer;
      font-size: 0.875rem;
      white-space: nowrap;
      text-decoration: none;
      position: relative;
      overflow: hidden;
    }
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .btn:focus {
      outline: 2px solid var(--responsive-teal);
      outline-offset: 2px;
    }
    .btn-sm { 
      padding: .375rem .875rem; 
      font-size: .875rem; 
    }
    .btn-primary { 
      background: var(--primary-gradient);
      color: #fff; 
      border: none;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .btn-primary:hover:not(:disabled) { 
      box-shadow: 0 4px 6px rgba(0,0,0,0.15);
      transform: translateY(-1px);
    }
    .btn-success { 
      background: var(--success-gradient);
      color: #fff;
      border: none;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .btn-success:hover:not(:disabled) { 
      box-shadow: 0 4px 6px rgba(0,0,0,0.15);
      transform: translateY(-1px);
    }
    .btn-danger {
      background: var(--danger-gradient);
      color: #fff;
      border: none;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .btn-danger:hover:not(:disabled) {
      box-shadow: 0 4px 6px rgba(0,0,0,0.15);
      transform: translateY(-1px);
    }
    .btn-outline { 
      background: var(--card-bg); 
      color: var(--text-primary); 
      border: 1px solid var(--border-color); 
    }
    .btn-outline:hover:not(:disabled) { 
      background: #f9fafb; 
      border-color: var(--text-secondary);
    }
    .btn-ghost { 
      background: transparent; 
      color: var(--text-secondary); 
      border: none;
    }
    .btn-ghost:hover:not(:disabled) { 
      background: #f3f4f6; 
      color: var(--text-primary);
    }
    
    /* Header button styles */
    .btn-header {
      background: rgba(255, 255, 255, 0.1);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    .btn-header:hover:not(:disabled) {
      background: rgba(255, 255, 255, 0.2);
      border-color: rgba(255, 255, 255, 0.4);
      transform: translateY(-1px);
    }

    /* Read-only sections */
    .section-readonly {
      position: relative;
    }
    .section-readonly .edit-overlay {
      position: absolute;
      top: 1rem;
      right: 1rem;
      z-index: 10;
    }
    .section-readonly.editing .edit-overlay {
      display: none;
    }
    .readonly-content {
      color: var(--text-primary);
      padding: 1rem;
      background: #f9fafb;
      border: 1px solid var(--border-color);
      min-height: 3rem;
      border-radius: 0;
    }

    /* Status pills */
    .status-pill { 
      font-size: .75rem; 
      font-weight: 600; 
      padding: .25rem .75rem; 
      border-radius: 0; 
      display: inline-flex; 
      align-items: center; 
      text-transform: uppercase;
      letter-spacing: 0.025em;
    }
    .status-green { background: #10b981; color: #fff; }
    .status-yellow { background: #f59e0b; color: #fff; }
    .status-red { background: #ef4444; color: #fff; }
    .status-gray { background: #6b7280; color: #fff; }
    .status-cyan { background: #06b6d4; color: #fff; }

    /* KPI display */
    .kpi-card {
      background: #f9fafb;
      border: 1px solid var(--border-color);
      padding: 1rem;
      position: relative;
      transition: all 0.15s ease;
    }
    .kpi-card:hover {
      background: #f3f4f6;
      border-color: var(--responsive-teal);
    }
    .kpi-value {
      font-size: 2.5rem;
      font-weight: 700;
      line-height: 1;
      color: var(--text-primary);
    }
    .kpi-unit {
      font-size: 1.125rem;
      font-weight: 400;
      color: var(--text-secondary);
      margin-left: 0.25rem;
    }
    .kpi-delta {
      font-size: 1rem;
      font-weight: 600;
      padding: 0.375rem 0.75rem;
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
      border-radius: 0;
    }
    .kpi-delta.positive {
      background: #d1fae5;
      color: #065f46;
    }
    .kpi-delta.negative {
      background: #fee2e2;
      color: #991b1b;
    }
    .kpi-arrow {
      width: 1rem;
      height: 1rem;
    }

    /* Period switcher */
    .period-switcher {
      display: inline-flex;
      background: #f3f4f6;
      border: 1px solid var(--border-color);
      padding: 0.125rem;
    }
    .period-switcher button {
      padding: 0.25rem 0.625rem;
      font-size: 0.75rem;
      font-weight: 500;
      background: transparent;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.15s;
    }
    .period-switcher button.active {
      background: var(--card-bg);
      color: var(--responsive-teal);
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    
    .period-switcher.small {
      padding: 0.0625rem;
    }
    .period-switcher.small button {
      padding: 0.125rem 0.5rem;
      font-size: 0.625rem;
    }

    /* Modal */
    .modal-overlay { 
      position: fixed; 
      inset: 0; 
      background: rgba(0,0,0,0.5); 
      backdrop-filter: blur(4px); 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      z-index: 50; 
      animation: fadeIn 0.15s ease;
    }
    .modal-panel { 
      border-radius: 0; 
      box-shadow: 0 20px 40px rgba(0,0,0,0.15); 
      max-height: 90vh; 
      overflow-y: auto; 
      background: var(--card-bg); 
      position: relative;
      animation: slideIn 0.2s ease;
    }
    .modal-header { 
      padding: 1.5rem; 
      border-bottom: 1px solid var(--border-color); 
      background: #f9fafb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .modal-body { 
      padding: 1.5rem; 
    }
    .modal-footer { 
      padding: 1rem 1.5rem; 
      border-top: 1px solid var(--border-color); 
      display: flex; 
      justify-content: flex-end; 
      gap: 1rem; 
      background: #f9fafb;
    }
    .modal-close {
      width: 2rem;
      height: 2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: none;
      font-size: 1.5rem;
      color: var(--text-secondary);
      cursor: pointer;
      transition: color 0.15s;
      border-radius: 0;
    }
    .modal-close:hover {
      color: var(--text-primary);
      background: #f3f4f6;
    }

    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes slideIn {
      from { 
        opacity: 0;
        transform: translateY(-10px);
      }
      to { 
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Helpers */
    .linkish { 
      text-decoration: underline; 
      color: var(--responsive-teal); 
      cursor: pointer;
      transition: color 0.15s;
    }
    .linkish:hover { 
      color: var(--responsive-teal-dark); 
    }

    /* Product selection */
    .product-checkbox {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem;
      transition: background 0.15s;
    }
    .product-checkbox:hover {
      background: #f9fafb;
    }
    .product-checkbox input[type="checkbox"] {
      width: 1.25rem;
      height: 1.25rem;
      cursor: pointer;
      accent-color: var(--responsive-teal);
    }

    /* Custom field inputs */
    .custom-field-input {
      min-width: 400px;
    }

    /* Loading states */
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .animate-spin {
      animation: spin 1s linear infinite;
      display: inline-block;
    }
    .loading {
      opacity: 0.6;
      pointer-events: none;
    }
    
    /* Utility classes */
    .shadow-sm { box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
    .shadow { box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .shadow-md { box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .shadow-lg { box-shadow: 0 10px 15px rgba(0,0,0,0.1); }
    .shadow-xl { box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
    
    /* Opacity utilities */
    .text-teal-50\/90 { color: rgb(240 253 250 / 0.9); }
    
    /* Responsive utilities */
    @media (max-width: 768px) {
      .modal-panel {
        margin: 1rem;
        max-width: calc(100vw - 2rem);
      }
      .custom-field-input {
        min-width: 100%;
      }
    }
  </style>
</head>
<body>
  <div id="app" class="max-w-screen-xl mx-auto p-4 sm:p-6 lg:p-8">
    <!-- Header -->
    <header class="mb-10 p-6 md:p-8 lg:p-10 bg-gradient-to-r from-teal-950 via-teal-800 to-emerald-600 text-white shadow-xl">
      <div class="flex flex-col lg:flex-row justify-between items-start lg:items-end gap-6">
        <div class="flex-1">
          <h1 id="main-title" class="font-extrabold text-white drop-shadow-lg flex flex-wrap items-baseline gap-3" style="font-size: 28px;">
            <span id="customer-name-display" class="cursor-pointer hover:opacity-80 border-b-2 border-transparent hover:border-white/50 transition-all" title="Click to edit customer name">TechCorp</span>
            <span>Success Plan</span>
          </h1>
        </div>
        <div class="flex flex-col md:flex-row items-start md:items-center gap-4">
          <p class="text-teal-50/90 text-sm font-light whitespace-nowrap">Last updated: <span id="last-updated-date"></span></p>
          <div class="flex items-center gap-3">
            <button id="export-excel-btn" class="btn btn-header" aria-label="Export to Excel">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path d="M13 7h-2v4H9v2h2v4h2v-4h4v-2h-4V7zm-8 6h4v2H5v-2z"/></svg>
              Export Excel
            </button>
            <button id="export-pdf-btn" class="btn btn-primary flex items-center" aria-label="Export to PDF">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V7.414A2 2 0 0015.414 6L12 2.586A2 2 0 0010.586 2H6zm5 6a1 1 0 10-2 0v3.586l-1.293-1.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V8z" clip-rule="evenodd" /></svg>
              Export PDF
            </button>
          </div>
        </div>
      </div>
    </header>



    <!-- Mission Summary -->
    <section class="card mb-6 p-6 section-readonly" id="mission-summary-section">
      <div class="edit-overlay">
        <button class="btn btn-ghost btn-sm" data-edit="mission-summary">Edit</button>
      </div>
      <h2 class="text-2xl font-bold mb-4">Mission Summary</h2>
      <div id="mission-summary-display" class="readonly-content"></div>
      <div id="mission-summary-edit" class="hidden">
        <textarea id="mission-summary-input" class="text-zone text-area p-3" rows="3"></textarea>
        <div class="mt-3 flex gap-2">
          <button class="btn btn-primary btn-sm" data-save="mission-summary">Save</button>
          <button class="btn btn-ghost btn-sm" data-cancel="mission-summary">Cancel</button>
        </div>
      </div>
    </section>

    <!-- Mission Goals -->
    <section class="card mb-10 p-6 section-readonly" id="mission-goals-section">
      <div class="edit-overlay">
        <button class="btn btn-ghost btn-sm" data-edit="mission-goals">Edit</button>
      </div>
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold">Mission Goals</h2>
      </div>
      <div id="mission-goals-display" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
      <div id="mission-goals-edit" class="hidden">
        <div id="mission-goals-container" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
        <div class="mt-4 flex gap-2">
          <button class="btn btn-success btn-sm" id="add-mission-goal-btn">+ Add Goal</button>
          <button class="btn btn-primary btn-sm" data-save="mission-goals">Save All</button>
          <button class="btn btn-ghost btn-sm" data-cancel="mission-goals">Cancel</button>
        </div>
      </div>
    </section>

    <main class="grid grid-cols-1 lg:grid-cols-4 gap-8">
      <!-- Left Column -->
      <div class="lg:col-span-3 space-y-8">
        <!-- Value Realized -->
        <section id="value-realized-section" class="card p-6 section-readonly">
          <div class="edit-overlay">
            <button class="btn btn-ghost btn-sm" data-edit="value-realized">Edit</button>
          </div>
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold">Value Realized</h2>
          </div>
          <div id="value-display" class="space-y-4"></div>
          <div id="value-edit" class="hidden">
            <div id="value-container" class="space-y-4"></div>
            <div class="mt-4 flex gap-2">
              <button class="btn btn-success btn-sm" id="add-value-btn">+ Add Value</button>
              <button class="btn btn-primary btn-sm" data-save="value-realized">Save All</button>
              <button class="btn btn-ghost btn-sm" data-cancel="value-realized">Cancel</button>
            </div>
          </div>
        </section>

        <!-- Current Objectives -->
        <section id="current-objectives" class="card p-6">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold">Current Objectives</h2>
            <button id="add-objective-btn" class="btn btn-primary">+ Add Objective</button>
          </div>
          <div id="objectives-container" class="space-y-6"></div>
          <div id="no-objectives" class="hidden text-center py-10 px-4 text-gray-500">
            No active objectives. Click "Add Objective" to create one.
          </div>
        </section>

        <!-- Past Objectives -->
        <section id="past-objectives" class="card p-6">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold">Past Objectives Achieved</h2>
            <button id="add-past-objective-btn" class="btn btn-success btn-sm">+ Add Past Objective</button>
          </div>
          <div id="past-objectives-container" class="space-y-6"></div>
          <div id="no-past-objectives" class="hidden text-center py-10 px-4 text-gray-500">
            Completed objectives will appear here.
          </div>
        </section>
      </div>

      <!-- Right Column -->
      <div class="lg:col-span-1 space-y-8">
        <!-- Overall Health -->
        <section class="card p-6">
          <h3 class="text-lg font-semibold mb-3">Overall Health</h3>
          <select id="health-score" class="text-zone p-2">
            <option value="green">ðŸŸ¢ On Track</option>
            <option value="yellow">ðŸŸ¡ Needs Attention</option>
            <option value="red">ðŸ”´ At Risk</option>
          </select>
        </section>

        <!-- Key Stakeholders -->
        <section class="card p-6">
          <h3 class="text-lg font-semibold mb-3">Key Stakeholders</h3>
          <div id="stakeholders-container" class="space-y-3 mb-3"></div>
          <select id="add-stakeholder-select" class="text-zone p-2">
            <option value="">+ Add a contact...</option>
            <option value="new">Add New Stakeholder...</option>
          </select>
        </section>

        <!-- Responsive Platform Products -->
        <section class="card p-6 section-readonly" id="products-section">
          <div class="edit-overlay">
            <button class="btn btn-ghost btn-sm" data-edit="products">Edit</button>
          </div>
          <h3 class="text-lg font-semibold mb-3">Responsive Platform Products</h3>
          <div id="products-display" class="space-y-2"></div>
          <div id="products-edit" class="hidden">
            <div class="space-y-2">
              <div class="product-checkbox">
                <input type="checkbox" id="product-content-library" value="Content Library">
                <label for="product-content-library" class="text-sm font-medium cursor-pointer">Content Library</label>
              </div>
              <div class="product-checkbox">
                <input type="checkbox" id="product-ai" value="AI">
                <label for="product-ai" class="text-sm font-medium cursor-pointer">AI</label>
              </div>
              <div class="product-checkbox">
                <input type="checkbox" id="product-projects" value="Projects">
                <label for="product-projects" class="text-sm font-medium cursor-pointer">Projects</label>
              </div>
              <div class="product-checkbox">
                <input type="checkbox" id="product-trust-center" value="Trust Center">
                <label for="product-trust-center" class="text-sm font-medium cursor-pointer">Trust Center</label>
              </div>
            </div>
            <div class="mt-4 flex gap-2">
              <button class="btn btn-primary btn-sm" data-save="products">Save</button>
              <button class="btn btn-ghost btn-sm" data-cancel="products">Cancel</button>
            </div>
          </div>
        </section>
      </div>
    </main>
  </div>

  <script>
    // ---------- Data Models ----------
    const PRODUCT_KPIS = {
      'Content Library': [
        { key: 'content_utilization', label: 'Content Utilization', unit: '%', higherIsBetter: true },
        { key: 'tagging_percentage', label: 'Tagging Percentage', unit: '%', higherIsBetter: true },
        { key: 'records_with_reviews', label: '% of Records with Reviews enabled', unit: '%', higherIsBetter: true },
        { key: 'content_ownership', label: '% of content with ownership', unit: '%', higherIsBetter: true },
        { key: 'obsolete_records', label: '% of obsolete records', unit: '%', higherIsBetter: false },
        { key: 'duplicated_records', label: '% of duplicated records', unit: '%', higherIsBetter: false }
      ],
      'AI': [
        { key: 'unedited_ai_responses', label: 'Unedited AI responses', unit: '%', higherIsBetter: false },
        { key: 'answer_with_ai', label: '% answer with AI', unit: '%', higherIsBetter: true },
        { key: 'ai_chatbot_usage', label: 'AI chatbot usage', unit: 'sessions', higherIsBetter: true }
      ],
      'Projects': [
        { key: 'answer_library_usage', label: '% Answer library usage', unit: '%', higherIsBetter: true },
        { key: 'manual_answers', label: '% of manual answers', unit: '%', higherIsBetter: false },
        { key: 'answers_edited', label: '% of Answers edited from Answer Library', unit: '%', higherIsBetter: false },
        { key: 'time_per_response', label: 'Time spent per response', unit: 's', higherIsBetter: false }
      ],
      'Trust Center': [
        { key: 'profile_views', label: '% of profile views', unit: '%', higherIsBetter: true }
      ]
    };

    const mockContacts = [
      { id: 1, name: 'Sarah Chen', title: 'VP Sales', email: 'sarah.chen@techcorp.com' },
      { id: 2, name: 'Michael Rodriguez', title: 'Sales Director', email: 'michael.r@techcorp.com' },
      { id: 3, name: 'Jennifer Park', title: 'Head of Enablement', email: 'jennifer.p@techcorp.com' },
      { id: 4, name: 'David Thompson', title: 'CRO', email: 'david.t@techcorp.com' },
      { id: 5, name: 'Emily Watson', title: 'Sales Operations Manager', email: 'emily.w@techcorp.com' },
      { id: 6, name: 'Robert Johnson', title: 'Enterprise Account Executive', email: 'robert.j@techcorp.com' }
    ];

    // Application State
    const state = {
      customerName: 'TechCorp',
      products: ['Content Library', 'AI'],
      missionSummary: 'Transform TechCorp\'s sales organization with Responsive\'s AI-powered platform, enabling 200+ sales reps to access the right content instantly, personalize customer interactions, and close deals 40% faster while maintaining compliance and brand consistency.',
      missionGoals: [
        { 
          id: 1, 
          title: 'Content Excellence Initiative', 
          description: 'Achieve 95% content accuracy and reduce obsolete content to less than 5% through AI-powered content management and automated review workflows.',
          customFields: [
            {id: 1, label: 'Success Dashboard', value: 'https://analytics.responsive.io/techcorp/content'},
            {id: 2, label: 'Content Audit Report', value: 'https://docs.responsive.io/content-audit-q1'}
          ] 
        },
        { 
          id: 2, 
          title: 'AI Adoption Program', 
          description: 'Drive 80% adoption of AI-powered responses across all sales teams, reducing average response time from 45 minutes to under 5 minutes.',
          customFields: [
            {id: 3, label: 'AI Training Portal', value: 'https://learn.responsive.io/ai-certification'},
            {id: 4, label: 'ROI Calculator', value: 'https://responsive.io/roi/techcorp-ai'}
          ] 
        }
      ],
      stakeholders: [mockContacts[0], mockContacts[1], mockContacts[2]],
      objectives: [
        {
          id: 1,
          name: 'Implement Content Governance Framework',
          targetDate: '2025-03-15',
          status: 'In Progress',
          description: 'Establish automated content lifecycle management with ownership assignment, review cycles, and obsolescence tracking for 5,000+ sales assets.',
          challenges: 'Legacy content lacks metadata. Need to train content owners on new tagging taxonomy.',
          nextSteps: 'Complete content audit by Feb 15. Deploy automated tagging tool by March 1.',
          kpis: [
            { 
              id: 101, 
              typeKey: 'content_ownership', 
              currentValue: 62, 
              previousValue: 15,
              period: 'Quarter',
              comparePrevious: true
            },
            { 
              id: 102, 
              typeKey: 'obsolete_records', 
              currentValue: 18, 
              previousValue: 32,
              period: 'Quarter',
              comparePrevious: true
            },
            { 
              id: 103, 
              typeKey: 'tagging_percentage', 
              currentValue: 71, 
              previousValue: 23,
              period: 'Month',
              comparePrevious: true
            }
          ]
        },
        {
          id: 2,
          name: 'Scale AI-Powered Responses',
          targetDate: '2025-04-30',
          status: 'Not Started',
          description: 'Roll out AI response capabilities to all 200+ sales reps with personalized training and success tracking.',
          challenges: 'Varying technical proficiency across teams. Need to customize AI models for different product lines.',
          nextSteps: 'Define success metrics. Create team-specific training paths. Set up AI performance dashboards.',
          kpis: [
            { 
              id: 201, 
              typeKey: 'answer_with_ai', 
              currentValue: 34, 
              previousValue: 8,
              period: 'Quarter',
              comparePrevious: true
            },
            { 
              id: 202, 
              typeKey: 'time_per_response', 
              currentValue: 12, 
              previousValue: 45,
              period: 'Month',
              comparePrevious: true
            }
          ]
        }
      ],
      pastObjectives: [
        {
          id: 100,
          name: 'Platform Onboarding & Initial Setup',
          targetDate: '2024-12-31',
          status: 'Completed',
          description: 'Successfully onboarded TechCorp to Responsive platform with SSO integration, initial content migration, and pilot team training.',
          challenges: 'Initial API rate limits required optimization. SSO integration needed custom SAML configuration.',
          nextSteps: 'Monitor system performance. Gather user feedback for Phase 2 rollout.',
          kpis: [
            { 
              id: 1001, 
              typeKey: 'content_utilization', 
              currentValue: 78, 
              previousValue: 0,
              period: 'Quarter',
              comparePrevious: true
            }
          ]
        }
      ],
      valueRealized: [
        { 
          id: 1, 
          type: 'Time Savings', 
          description: 'Sales team saves average 6 hours/week per rep through instant content discovery and AI-powered responses. Validated through time tracking study of 50 pilot users.',
          date: '2025-01-15', 
          link: 'https://responsive.io/impact/techcorp/time-savings' 
        },
        {
          id: 2,
          type: 'Win Rate Increase',
          description: 'Teams using AI-recommended content show 12% higher win rates compared to control group, resulting in $2.1M additional revenue in Q1.',
          date: '2025-01-22',
          link: 'https://responsive.io/impact/techcorp/win-rate'
        },
        {
          id: 3,
          type: 'Cost Reduction',
          description: 'Reduced content creation costs by 35% through reuse of high-performing materials and AI-assisted content generation.',
          date: '2025-01-10',
          link: 'https://responsive.io/impact/techcorp/cost-savings'
        }
      ],
      valueRealizedBackup: [], // For cancel functionality
      planHealth: 'green'
    };

    // ---------- Utility Functions ----------
    const $ = (q, root = document) => root.querySelector(q);
    const $$ = (q, root = document) => [...root.querySelectorAll(q)];
    
    function calculateDelta(current, previous) {
      if (!previous || previous === 0) return 0;
      return ((current - previous) / Math.abs(previous) * 100).toFixed(1);
    }

    function getAvailableKPITypes() {
      const types = [];
      state.products.forEach(product => {
        if (PRODUCT_KPIS[product]) {
          types.push(...PRODUCT_KPIS[product]);
        }
      });
      return types;
    }

    function getKPIType(typeKey) {
      const allTypes = getAvailableKPITypes();
      return allTypes.find(t => t.key === typeKey) || { label: 'Unknown KPI', unit: '', higherIsBetter: true };
    }

    function autoResizeTextarea(textarea) {
      if (!textarea) return;
      textarea.style.height = 'auto';
      textarea.style.height = (textarea.scrollHeight + 2) + 'px';
    }

    function applyAutoResize(root = document) {
      $$('.text-area', root).forEach(autoResizeTextarea);
    }

    // ---------- Section Locking/Editing ----------
    function setupSectionEditing() {
      document.addEventListener('click', (e) => {
        if (e.target.matches('[data-edit]')) {
          const section = e.target.dataset.edit;
          enterEditMode(section);
        } else if (e.target.matches('[data-save]')) {
          const section = e.target.dataset.save;
          saveSection(section);
        } else if (e.target.matches('[data-cancel]')) {
          const section = e.target.dataset.cancel;
          cancelEdit(section);
        }
      });
    }

    function enterEditMode(section) {
      const sectionEl = $(`#${section}-section`);
      if (sectionEl) sectionEl.classList.add('editing');
      
      if (section === 'mission-summary') {
        $('#mission-summary-display').classList.add('hidden');
        $('#mission-summary-edit').classList.remove('hidden');
        $('#mission-summary-input').value = state.missionSummary;
        autoResizeTextarea($('#mission-summary-input'));
      } else if (section === 'mission-goals') {
        $('#mission-goals-display').classList.add('hidden');
        $('#mission-goals-edit').classList.remove('hidden');
        renderMissionGoalsEdit();
      } else if (section === 'value-realized') {
        // Create backup for cancel functionality
        state.valueRealizedBackup = JSON.parse(JSON.stringify(state.valueRealized));
        $('#value-display').classList.add('hidden');
        $('#value-edit').classList.remove('hidden');
        renderValueEdit();
      } else if (section === 'products') {
        $('#products-display').classList.add('hidden');
        $('#products-edit').classList.remove('hidden');
        // Set checkbox states
        state.products.forEach(product => {
          const checkbox = $(`#product-${product.toLowerCase().replace(' ', '-')}`);
          if (checkbox) checkbox.checked = true;
        });
      }
    }

    function saveSection(section) {
      if (section === 'mission-summary') {
        state.missionSummary = $('#mission-summary-input').value;
      } else if (section === 'value-realized') {
        // Clear backup since we're saving
        state.valueRealizedBackup = [];
      } else if (section === 'products') {
        const newProducts = [];
        $$('#products-edit input[type="checkbox"]:checked').forEach(cb => {
          newProducts.push(cb.value);
        });
        state.products = newProducts;
      }
      
      exitEditMode(section);
      renderAll();
      saveToLocalStorage();
      showNotification('Changes saved successfully', 'success');
    }

    function cancelEdit(section) {
      if (section === 'value-realized') {
        // Restore from backup
        state.valueRealized = JSON.parse(JSON.stringify(state.valueRealizedBackup));
        state.valueRealizedBackup = [];
      }
      exitEditMode(section);
      renderAll();
    }

    function exitEditMode(section) {
      const sectionEl = $(`#${section}-section`);
      if (sectionEl) sectionEl.classList.remove('editing');
      
      if (section === 'mission-summary') {
        $('#mission-summary-display').classList.remove('hidden');
        $('#mission-summary-edit').classList.add('hidden');
      } else if (section === 'mission-goals') {
        $('#mission-goals-display').classList.remove('hidden');
        $('#mission-goals-edit').classList.add('hidden');
      } else if (section === 'value-realized') {
        $('#value-display').classList.remove('hidden');
        $('#value-edit').classList.add('hidden');
      } else if (section === 'products') {
        $('#products-display').classList.remove('hidden');
        $('#products-edit').classList.add('hidden');
      }
    }

    // ---------- Rendering Functions ----------
    function renderMissionSummary() {
      const display = $('#mission-summary-display');
      if (display) {
        display.innerHTML = state.missionSummary || '<span class="text-gray-500 italic">No mission summary defined</span>';
      }
    }

    function renderMissionGoalsDisplay() {
      const container = $('#mission-goals-display');
      if (!container) return;
      
      container.innerHTML = state.missionGoals.map(g => `
        <div class="card p-4">
          <h3 class="font-semibold text-lg mb-2">${g.title}</h3>
          <p class="text-sm text-gray-600 mb-3">${g.description}</p>
          ${g.customFields && g.customFields.length > 0 ? `
            <div class="space-y-1">
              ${g.customFields.map(f => `
                <div class="text-xs">
                  <span class="font-medium text-gray-700">${f.label}:</span>
                  ${f.value.startsWith('http') ? 
                    `<a href="${f.value}" target="_blank" class="linkish ml-1">${f.value}</a>` : 
                    `<span class="ml-1">${f.value}</span>`
                  }
                </div>
              `).join('')}
            </div>
          ` : ''}
        </div>
      `).join('') || '<p class="text-gray-500">No mission goals defined.</p>';
    }

    function renderMissionGoalsEdit() {
      const container = $('#mission-goals-container');
      if (!container) return;
      
      container.innerHTML = state.missionGoals.map(g => `
        <div class="card p-4" data-id="${g.id}">
          <button class="float-right text-red-500 hover:text-red-700" data-role="remove-goal">Ã—</button>
          <div class="mb-3">
            <input class="text-zone p-2 font-semibold w-full" value="${g.title}" data-role="goal-title" />
          </div>
          <textarea class="text-zone text-area p-3 text-sm" rows="3" data-role="goal-desc">${g.description || ''}</textarea>
          <div class="mt-3 space-y-2" data-role="custom-fields">
            ${(g.customFields || []).map(f => `
              <div class="flex items-center gap-2" data-field-id="${f.id}">
                <input class="text-zone p-2 text-xs font-semibold" value="${f.label}" data-role="cf-label" />
                <input class="text-zone p-2 text-xs flex-1 custom-field-input" value="${f.value || ''}" data-role="cf-value" />
                <button class="text-red-500 hover:text-red-700 text-xl" data-role="remove-cf">Ã—</button>
              </div>
            `).join('')}
          </div>
          <button class="text-teal-600 hover:text-teal-700 font-medium text-sm mt-2" data-role="add-cf">+ Add Field</button>
        </div>
      `).join('');
      applyAutoResize(container);
    }

    function renderValueDisplay() {
      const container = $('#value-display');
      if (!container) return;
      
      container.innerHTML = state.valueRealized.map(v => `
        <div class="card p-4">
          <div class="flex justify-between items-start">
            <div class="flex-1">
              <h4 class="font-semibold text-emerald-700">${v.type}</h4>
              <p class="text-sm text-gray-700 mt-1">${v.description}</p>
              <div class="flex gap-4 mt-2 text-xs text-gray-500">
                <span>Realized: ${v.date || 'Not specified'}</span>
                ${v.link ? `<a href="${v.link}" target="_blank" class="linkish">View Details</a>` : ''}
              </div>
            </div>
          </div>
        </div>
      `).join('') || '<p class="text-gray-500">No value realized items yet.</p>';
    }

    function renderValueEdit() {
      const container = $('#value-container');
      if (!container) return;
      
      container.innerHTML = state.valueRealized.map(v => `
        <div class="card p-4" data-id="${v.id}">
          <button class="float-right text-red-500 hover:text-red-700 text-xl" data-role="remove-value">Ã—</button>
          <div class="grid grid-cols-2 gap-3 mb-3">
            <select class="text-zone p-2 text-sm font-semibold" data-role="value-type">
              <option ${v.type === 'Time Savings' ? 'selected' : ''}>Time Savings</option>
              <option ${v.type === 'Win Rate Increase' ? 'selected' : ''}>Win Rate Increase</option>
              <option ${v.type === 'Cost Reduction' ? 'selected' : ''}>Cost Reduction</option>
              <option ${v.type === 'Revenue Growth' ? 'selected' : ''}>Revenue Growth</option>
              <option ${v.type === 'Productivity Gain' ? 'selected' : ''}>Productivity Gain</option>
              <option ${v.type === 'Risk Mitigation' ? 'selected' : ''}>Risk Mitigation</option>
            </select>
            <input type="date" value="${v.date || ''}" class="text-zone p-2" data-role="value-date" />
          </div>
          <textarea class="text-zone text-area p-3 text-sm mb-3" rows="2" data-role="value-desc">${v.description || ''}</textarea>
          <input type="text" value="${v.link || ''}" placeholder="https://..." class="text-zone p-2 w-full" data-role="value-link" />
        </div>
      `).join('');
      applyAutoResize(container);
    }

    function renderObjectives() {
      const container = $('#objectives-container');
      const noObjectivesMsg = $('#no-objectives');
      
      if (!container) return;
      
      if (state.objectives.length === 0) {
        container.innerHTML = '';
        noObjectivesMsg?.classList.remove('hidden');
      } else {
        noObjectivesMsg?.classList.add('hidden');
        container.innerHTML = state.objectives.map(o => renderObjectiveCard(o)).join('');
      }
      
      const pastContainer = $('#past-objectives-container');
      if (pastContainer) {
        pastContainer.innerHTML = state.pastObjectives.map(o => renderObjectiveCard(o, true)).join('');
      }
      $('#no-past-objectives')?.classList.toggle('hidden', state.pastObjectives.length > 0);
    }

    function renderObjectiveCard(obj, isPast = false) {
      const statusClass = {
        'In Progress': 'status-cyan',
        'Not Started': 'status-gray',
        'Completed': 'status-green',
        'At Risk': 'status-yellow'
      }[obj.status] || 'status-gray';
      
      return `
        <div class="card p-6" data-id="${obj.id}">
          <div class="flex justify-between items-start mb-4">
            <div>
              <h3 class="font-semibold text-lg">${obj.name}</h3>
              <div class="flex items-center gap-3 mt-2">
                <span class="status-pill ${statusClass}">${obj.status}</span>
                <span class="text-sm text-gray-500">Target: ${obj.targetDate || 'Not set'}</span>
              </div>
            </div>
            <div class="flex gap-2">
              <button class="btn btn-ghost btn-sm" onclick="editObjective(${obj.id}, ${isPast})">Edit</button>
              ${!isPast ? `
                <button class="btn btn-primary btn-sm" onclick="showAddKPIModal(${obj.id})">+ Add KPI</button>
              ` : `
                <button class="btn btn-danger btn-sm" onclick="removePastObjective(${obj.id})">Remove</button>
              `}
            </div>
          </div>
          
          <p class="text-sm text-gray-600 mb-4">${obj.description}</p>
          
          ${obj.kpis && obj.kpis.length > 0 ? `
            <div class="space-y-3 mb-4">
              <h4 class="font-semibold text-sm text-gray-700">Key Performance Indicators</h4>
              ${obj.kpis.map(kpi => renderKPI(kpi, obj.id)).join('')}
            </div>
          ` : ''}
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
            <div>
              <span class="font-medium text-gray-600">Challenges:</span>
              <p class="text-gray-700 mt-1">${obj.challenges || 'None identified'}</p>
            </div>
            <div>
              <span class="font-medium text-gray-600">Next Steps:</span>
              <p class="text-gray-700 mt-1">${obj.nextSteps || 'To be determined'}</p>
            </div>
          </div>
        </div>
      `;
    }

    function renderKPI(kpi, objectiveId) {
      const type = getKPIType(kpi.typeKey);
      const delta = calculateDelta(kpi.currentValue, kpi.previousValue);
      const deltaNum = parseFloat(delta);
      const isPositive = type.higherIsBetter ? deltaNum >= 0 : deltaNum <= 0;
      const showDelta = kpi.comparePrevious && kpi.previousValue !== undefined;
      
      const periodLabel = {
        'Month': 'MoM',
        'Quarter': 'QoQ',
        'Year': 'YoY'
      }[kpi.period] || 'QoQ';
      
      return `
        <div class="kpi-card" data-kpi-id="${kpi.id}">
          <div class="flex justify-between items-start mb-2">
            <div class="flex-1">
              <div class="text-sm font-medium text-gray-700">${type.label}</div>
            </div>
            <div class="flex items-center gap-2">
              <div class="period-switcher small">
                <button class="${kpi.period === 'Month' ? 'active' : ''}" onclick="updateKPIPeriod(${objectiveId}, ${kpi.id}, 'Month')">M</button>
                <button class="${kpi.period === 'Quarter' ? 'active' : ''}" onclick="updateKPIPeriod(${objectiveId}, ${kpi.id}, 'Quarter')">Q</button>
                <button class="${kpi.period === 'Year' ? 'active' : ''}" onclick="updateKPIPeriod(${objectiveId}, ${kpi.id}, 'Year')">Y</button>
              </div>
              <button class="text-gray-400 hover:text-gray-600" onclick="editKPI(${objectiveId}, ${kpi.id})">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
                </svg>
              </button>
            </div>
          </div>
          <div class="flex items-baseline gap-2">
            <span class="kpi-value">${kpi.currentValue}</span>
            <span class="kpi-unit">${type.unit}</span>
            ${showDelta ? `
              <span class="kpi-delta ${isPositive ? 'positive' : 'negative'}">
                ${isPositive ? 
                  '<svg class="kpi-arrow" fill="currentColor" viewBox="0 0 20 20"><path d="M5.293 7.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L11 5.414V17a1 1 0 11-2 0V5.414L6.707 7.707a1 1 0 01-1.414 0z"/></svg>' :
                  '<svg class="kpi-arrow" fill="currentColor" viewBox="0 0 20 20"><path d="M14.707 12.293a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 111.414-1.414L9 14.586V3a1 1 0 012 0v11.586l2.293-2.293a1 1 0 011.414 0z"/></svg>'
                }
                ${Math.abs(deltaNum)}% ${periodLabel}
              </span>
            ` : ''}
          </div>
          ${kpi.comparePrevious ? '' : `
            <button class="text-xs text-teal-600 hover:text-teal-700 mt-1" onclick="toggleKPIComparison(${objectiveId}, ${kpi.id})">
              Show comparison
            </button>
          `}
        </div>
      `;
    }

    function renderStakeholders() {
      const container = $('#stakeholders-container');
      if (!container) return;
      
      container.innerHTML = state.stakeholders.map(s => `
        <div class="flex items-center justify-between p-3 bg-gray-50 border border-gray-200 hover:bg-gray-100 transition-colors">
          <div>
            <p class="font-semibold text-sm">${s.name}</p>
            <p class="text-xs text-gray-600">${s.title}</p>
            <p class="text-xs text-gray-500">${s.email}</p>
          </div>
          <button class="text-gray-400 hover:text-red-600 text-xl" onclick="removeStakeholder(${s.id})">Ã—</button>
        </div>
      `).join('');
      
      // Update select options
      const select = $('#add-stakeholder-select');
      if (select) {
        const unselected = mockContacts.filter(mc => !state.stakeholders.find(sc => sc.id === mc.id));
        select.innerHTML = '<option value="">+ Add a contact...</option>' + 
          unselected.map(c => `<option value="${c.id}">${c.name} - ${c.title}</option>`).join('') + 
          '<option value="new">Add New Stakeholder...</option>';
      }
    }

    function renderProducts() {
      const display = $('#products-display');
      if (!display) return;
      
      if (state.products.length === 0) {
        display.innerHTML = '<p class="text-gray-500 text-sm">No products selected</p>';
      } else {
        display.innerHTML = state.products.map(product => `
          <div class="flex items-center gap-2">
            <span class="w-2 h-2 bg-teal-500 rounded-full"></span>
            <span class="text-sm">${product}</span>
          </div>
        `).join('');
      }
    }

    // ---------- Modals ----------
    window.showAddObjectiveModal = function(isPast = false) {
      const modal = createModal(isPast ? 'Add Past Objective' : 'Add New Objective', `
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium mb-1">Objective Name</label>
            <input type="text" id="obj-name" class="text-zone p-2 w-full" placeholder="e.g., Improve content quality metrics">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Description</label>
            <textarea id="obj-desc" class="text-zone text-area p-3 w-full" rows="3" placeholder="Describe the objective and success criteria..."></textarea>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-1">Target Date</label>
              <input type="date" id="obj-date" class="text-zone p-2 w-full">
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Status</label>
              <select id="obj-status" class="text-zone p-2 w-full">
                ${isPast ? 
                  '<option selected>Completed</option>' : 
                  `<option>Not Started</option>
                   <option>In Progress</option>
                   <option>At Risk</option>`
                }
              </select>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Challenges</label>
            <textarea id="obj-challenges" class="text-zone text-area p-3 w-full" rows="2" placeholder="Any known challenges or risks..."></textarea>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Next Steps</label>
            <textarea id="obj-steps" class="text-zone text-area p-3 w-full" rows="2" placeholder="Immediate next actions..."></textarea>
          </div>
        </div>
      `, [
        { label: 'Cancel', class: 'btn-ghost', action: () => closeModal() },
        { label: 'Create Objective', class: 'btn-primary', action: () => {
          const obj = {
            id: Date.now(),
            name: $('#obj-name').value.trim(),
            description: $('#obj-desc').value.trim(),
            targetDate: $('#obj-date').value,
            status: $('#obj-status').value,
            challenges: $('#obj-challenges').value.trim(),
            nextSteps: $('#obj-steps').value.trim(),
            kpis: []
          };
          
          if (!obj.name) {
            showNotification('Please enter an objective name', 'error');
            return;
          }
          
          if (isPast) {
            state.pastObjectives.unshift(obj);
            showNotification('Past objective added successfully', 'success');
          } else {
            state.objectives.unshift(obj);
            showNotification('Objective created successfully', 'success');
          }
          renderAll();
          saveToLocalStorage();
          closeModal();
        }}
      ]);
      
      applyAutoResize(modal);
    }

    window.showAddKPIModal = function(objectiveId) {
      const availableTypes = getAvailableKPITypes();
      
      if (availableTypes.length === 0) {
        showNotification('Please select products first to see available KPIs', 'error');
        return;
      }
      
      const modal = createModal('Add KPI', `
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium mb-1">KPI Type</label>
            <select id="kpi-type" class="text-zone p-2 w-full">
              <option value="">Select a KPI type...</option>
              ${availableTypes.map(t => `<option value="${t.key}">${t.label}</option>`).join('')}
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Unit</label>
            <input id="kpi-unit" class="text-zone p-2 w-full bg-gray-100" readonly placeholder="Auto-filled based on type">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Time Period</label>
            <select id="kpi-period" class="text-zone p-2 w-full">
              <option value="Month">Month</option>
              <option value="Quarter" selected>Quarter</option>
              <option value="Year">Year</option>
            </select>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-1">Current Value</label>
              <input type="number" id="kpi-current" class="text-zone p-2 w-full" placeholder="0" step="0.1">
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Previous Value</label>
              <input type="number" id="kpi-previous" class="text-zone p-2 w-full" placeholder="0" step="0.1">
            </div>
          </div>
          <div class="flex items-center gap-2">
            <input type="checkbox" id="kpi-compare" checked>
            <label for="kpi-compare" class="text-sm cursor-pointer">Show comparison vs previous period</label>
          </div>
          <div id="kpi-preview" class="hidden p-3 bg-gray-50 border">
            <div class="text-sm text-gray-600">Preview:</div>
            <div class="font-semibold mt-1">
              <span id="preview-value">0</span>
              <span id="preview-unit"></span>
              <span id="preview-delta" class="ml-2 text-sm"></span>
            </div>
          </div>
        </div>
      `, [
        { label: 'Cancel', class: 'btn-ghost', action: () => closeModal() },
        { label: 'Add KPI', class: 'btn-primary', action: () => {
          const typeKey = $('#kpi-type').value;
          const current = parseFloat($('#kpi-current').value) || 0;
          const previous = parseFloat($('#kpi-previous').value) || 0;
          const period = $('#kpi-period').value;
          const comparePrevious = $('#kpi-compare').checked;
          
          if (!typeKey) {
            showNotification('Please select a KPI type', 'error');
            return;
          }
          
          const obj = state.objectives.find(o => o.id === objectiveId);
          if (!obj) return;
          
          if (!obj.kpis) obj.kpis = [];
          obj.kpis.push({
            id: Date.now(),
            typeKey,
            currentValue: current,
            previousValue: previous,
            period,
            comparePrevious
          });
          
          renderAll();
          saveToLocalStorage();
          closeModal();
          showNotification('KPI added successfully', 'success');
        }}
      ]);
      
      // Set up type change handler
      $('#kpi-type').addEventListener('change', (e) => {
        const type = getKPIType(e.target.value);
        $('#kpi-unit').value = type.unit;
        updateKPIPreview();
      });
      
      $('#kpi-current').addEventListener('input', updateKPIPreview);
      $('#kpi-previous').addEventListener('input', updateKPIPreview);
      $('#kpi-period').addEventListener('change', updateKPIPreview);
      $('#kpi-compare').addEventListener('change', updateKPIPreview);
      
      function updateKPIPreview() {
        const typeKey = $('#kpi-type').value;
        if (!typeKey) return;
        
        const type = getKPIType(typeKey);
        const current = parseFloat($('#kpi-current').value) || 0;
        const previous = parseFloat($('#kpi-previous').value) || 0;
        const period = $('#kpi-period').value;
        const comparePrevious = $('#kpi-compare').checked;
        const delta = calculateDelta(current, previous);
        const deltaNum = parseFloat(delta);
        const isPositive = type.higherIsBetter ? deltaNum >= 0 : deltaNum <= 0;
        
        const periodLabel = {
          'Month': 'MoM',
          'Quarter': 'QoQ',
          'Year': 'YoY'
        }[period] || 'QoQ';
        
        $('#kpi-preview').classList.remove('hidden');
        $('#preview-value').textContent = current;
        $('#preview-unit').textContent = type.unit;
        
        if (comparePrevious && previous !== 0) {
          $('#preview-delta').innerHTML = `
            <span class="${isPositive ? 'text-green-600' : 'text-red-600'}">
              ${deltaNum > 0 ? '+' : ''}${delta}% ${periodLabel}
            </span>
          `;
        } else {
          $('#preview-delta').textContent = '';
        }
      }
    }

    window.editKPI = function(objectiveId, kpiId) {
      const obj = state.objectives.find(o => o.id === objectiveId);
      if (!obj) return;
      
      const kpi = obj.kpis.find(k => k.id === kpiId);
      if (!kpi) return;
      
      const type = getKPIType(kpi.typeKey);
      
      const modal = createModal('Edit KPI', `
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium mb-1">KPI Type</label>
            <input class="text-zone p-2 w-full bg-gray-100" value="${type.label}" readonly>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Time Period</label>
            <select id="edit-kpi-period" class="text-zone p-2 w-full">
              <option value="Month" ${kpi.period === 'Month' ? 'selected' : ''}>Month</option>
              <option value="Quarter" ${kpi.period === 'Quarter' ? 'selected' : ''}>Quarter</option>
              <option value="Year" ${kpi.period === 'Year' ? 'selected' : ''}>Year</option>
            </select>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-1">Current Value</label>
              <input type="number" id="edit-kpi-current" class="text-zone p-2 w-full" value="${kpi.currentValue}" step="0.1">
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Previous Value</label>
              <input type="number" id="edit-kpi-previous" class="text-zone p-2 w-full" value="${kpi.previousValue}" step="0.1">
            </div>
          </div>
          <div class="flex items-center gap-2">
            <input type="checkbox" id="edit-kpi-compare" ${kpi.comparePrevious ? 'checked' : ''}>
            <label for="edit-kpi-compare" class="text-sm cursor-pointer">Show comparison vs previous period</label>
          </div>
          <div class="text-sm text-gray-500 mt-2">
            Note: Delta will be automatically recalculated when you save.
          </div>
        </div>
      `, [
        { label: 'Delete', class: 'btn-danger btn-sm', action: () => {
          if (confirm('Are you sure you want to delete this KPI?')) {
            obj.kpis = obj.kpis.filter(k => k.id !== kpiId);
            renderAll();
            saveToLocalStorage();
            closeModal();
            showNotification('KPI deleted', 'success');
          }
        }},
        { label: 'Cancel', class: 'btn-ghost', action: () => closeModal() },
        { label: 'Save Changes', class: 'btn-primary', action: () => {
          kpi.currentValue = parseFloat($('#edit-kpi-current').value) || 0;
          kpi.previousValue = parseFloat($('#edit-kpi-previous').value) || 0;
          kpi.period = $('#edit-kpi-period').value;
          kpi.comparePrevious = $('#edit-kpi-compare').checked;
          
          renderAll();
          saveToLocalStorage();
          closeModal();
          showNotification('KPI updated successfully', 'success');
        }}
      ]);
    }

    function createModal(title, content, buttons = []) {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-panel w-[600px] max-w-[90vw]">
          <div class="modal-header">
            <h3 class="text-lg font-semibold">${title}</h3>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
          </div>
          <div class="modal-body">
            ${content}
          </div>
          <div class="modal-footer">
            ${buttons.map(btn => `
              <button class="btn ${btn.class || ''}">${btn.label}</button>
            `).join('')}
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // Attach button handlers
      const footerButtons = modal.querySelectorAll('.modal-footer button');
      buttons.forEach((btn, i) => {
        if (footerButtons[i]) {
          footerButtons[i].addEventListener('click', btn.action);
        }
      });
      
      // Close on overlay click
      modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
      });
      
      return modal;
    }

    window.closeModal = function() {
      const modal = $('.modal-overlay');
      if (modal) modal.remove();
    };

    window.editObjective = function(id, isPast = false) {
      const obj = isPast ? 
        state.pastObjectives.find(o => o.id === id) : 
        state.objectives.find(o => o.id === id);
      if (!obj) return;
      
      const modal = createModal('Edit Objective', `
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium mb-1">Objective Name</label>
            <input type="text" id="edit-obj-name" class="text-zone p-2 w-full" value="${obj.name}">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Description</label>
            <textarea id="edit-obj-desc" class="text-zone text-area p-3 w-full" rows="3">${obj.description || ''}</textarea>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-1">Target Date</label>
              <input type="date" id="edit-obj-date" class="text-zone p-2 w-full" value="${obj.targetDate || ''}">
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Status</label>
              <select id="edit-obj-status" class="text-zone p-2 w-full">
                <option ${obj.status === 'Not Started' ? 'selected' : ''}>Not Started</option>
                <option ${obj.status === 'In Progress' ? 'selected' : ''}>In Progress</option>
                <option ${obj.status === 'At Risk' ? 'selected' : ''}>At Risk</option>
                <option ${obj.status === 'Completed' ? 'selected' : ''}>Completed</option>
              </select>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Challenges</label>
            <textarea id="edit-obj-challenges" class="text-zone text-area p-3 w-full" rows="2">${obj.challenges || ''}</textarea>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Next Steps</label>
            <textarea id="edit-obj-steps" class="text-zone text-area p-3 w-full" rows="2">${obj.nextSteps || ''}</textarea>
          </div>
        </div>
      `, [
        { label: 'Cancel', class: 'btn-ghost', action: () => closeModal() },
        { label: 'Save Changes', class: 'btn-primary', action: () => {
          const oldStatus = obj.status;
          obj.name = $('#edit-obj-name').value.trim();
          obj.description = $('#edit-obj-desc').value.trim();
          obj.targetDate = $('#edit-obj-date').value;
          obj.status = $('#edit-obj-status').value;
          obj.challenges = $('#edit-obj-challenges').value.trim();
          obj.nextSteps = $('#edit-obj-steps').value.trim();
          
          // Handle status changes and moving between lists
          if (!isPast && oldStatus !== 'Completed' && obj.status === 'Completed') {
            // Move from current to past
            state.objectives = state.objectives.filter(o => o.id !== id);
            state.pastObjectives.unshift(obj);
            showNotification('Objective completed and moved to past objectives', 'success');
          } else if (isPast && obj.status !== 'Completed') {
            // Move from past back to current
            state.pastObjectives = state.pastObjectives.filter(o => o.id !== id);
            state.objectives.push(obj);
            showNotification('Objective moved back to current objectives', 'success');
          }
          
          renderAll();
          saveToLocalStorage();
          closeModal();
        }}
      ]);
      
      applyAutoResize(modal);
    };

    window.removeStakeholder = function(id) {
      state.stakeholders = state.stakeholders.filter(s => s.id !== id);
      renderAll();
      saveToLocalStorage();
    };

    window.removePastObjective = function(id) {
      if (confirm('Are you sure you want to permanently remove this past objective?')) {
        state.pastObjectives = state.pastObjectives.filter(o => o.id !== id);
        renderAll();
        saveToLocalStorage();
        showNotification('Past objective removed', 'success');
      }
    };

    window.updateKPIPeriod = function(objectiveId, kpiId, period) {
      const obj = state.objectives.find(o => o.id === objectiveId);
      if (!obj) return;
      
      const kpi = obj.kpis.find(k => k.id === kpiId);
      if (!kpi) return;
      
      kpi.period = period;
      renderAll();
      saveToLocalStorage();
    };

    window.toggleKPIComparison = function(objectiveId, kpiId) {
      const obj = state.objectives.find(o => o.id === objectiveId);
      if (!obj) return;
      
      const kpi = obj.kpis.find(k => k.id === kpiId);
      if (!kpi) return;
      
      kpi.comparePrevious = true;
      renderAll();
      saveToLocalStorage();
    };

    // ---------- Notifications ----------
    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = `fixed top-4 right-4 p-4 shadow-lg z-50 font-medium min-w-[300px] ${
        type === 'success' ? 'bg-gradient-to-r from-emerald-500 to-emerald-600 text-white' : 
        type === 'error' ? 'bg-gradient-to-r from-red-500 to-red-600 text-white' : 
        'bg-gradient-to-r from-teal-500 to-teal-600 text-white'
      }`;
      notification.textContent = message;
      notification.style.animation = 'slideIn 0.3s ease';
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.animation = 'fadeOut 0.3s ease';
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }

    // ---------- Event Handlers ----------
    function setupEventHandlers() {
      // Customer name editing
      $('#customer-name-display')?.addEventListener('click', () => {
        const modal = createModal('Edit Customer Name', `
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium mb-1">Customer Name</label>
              <input type="text" id="edit-customer-name" class="text-zone p-3 w-full text-lg" value="${state.customerName}" placeholder="Enter customer name">
            </div>
          </div>
        `, [
          { label: 'Cancel', class: 'btn-ghost', action: () => closeModal() },
          { label: 'Save', class: 'btn-primary', action: () => {
            const newName = $('#edit-customer-name').value.trim();
            if (newName) {
              state.customerName = newName;
              $('#customer-name-display').textContent = newName;
              saveToLocalStorage();
              closeModal();
              showNotification('Customer name updated', 'success');
            } else {
              showNotification('Please enter a customer name', 'error');
            }
          }}
        ]);
        
        // Focus the input and handle Enter key
        setTimeout(() => {
          const input = $('#edit-customer-name');
          input?.focus();
          input?.select();
          
          // Handle Enter key
          input?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
              const saveBtn = modal.querySelector('.btn-primary');
              saveBtn?.click();
            }
          });
        }, 100);
      });
      
      // Add objective button
      $('#add-objective-btn')?.addEventListener('click', showAddObjectiveModal);
      
      // Add past objective button
      $('#add-past-objective-btn')?.addEventListener('click', () => {
        showAddObjectiveModal(true);
      });
      
      // Mission goals editing
      document.addEventListener('click', (e) => {
        const target = e.target;
        
        // Mission goals handlers
        if (target.dataset.role === 'add-cf') {
          const card = target.closest('[data-id]');
          const goalId = parseInt(card.dataset.id);
          const goal = state.missionGoals.find(g => g.id === goalId);
          if (!goal.customFields) goal.customFields = [];
          goal.customFields.push({
            id: Date.now(),
            label: 'New Field',
            value: ''
          });
          renderMissionGoalsEdit();
        } else if (target.dataset.role === 'remove-cf') {
          const card = target.closest('[data-id]');
          const fieldEl = target.closest('[data-field-id]');
          const goalId = parseInt(card.dataset.id);
          const fieldId = parseInt(fieldEl.dataset.fieldId);
          const goal = state.missionGoals.find(g => g.id === goalId);
          goal.customFields = goal.customFields.filter(f => f.id !== fieldId);
          renderMissionGoalsEdit();
        } else if (target.dataset.role === 'remove-goal') {
          const card = target.closest('[data-id]');
          const goalId = parseInt(card.dataset.id);
          state.missionGoals = state.missionGoals.filter(g => g.id !== goalId);
          renderMissionGoalsEdit();
        } else if (target.dataset.role === 'remove-value') {
          const card = target.closest('[data-id]');
          const valueId = parseInt(card.dataset.id);
          state.valueRealized = state.valueRealized.filter(v => v.id !== valueId);
          renderValueEdit();
        }
      });
      
      // Mission goals inputs
      document.addEventListener('input', (e) => {
        const target = e.target;
        
        // Mission goals
        if (target.closest('#mission-goals-container')) {
          const card = target.closest('[data-id]');
          if (!card) return;
          
          const goalId = parseInt(card.dataset.id);
          const goal = state.missionGoals.find(g => g.id === goalId);
          
          if (target.dataset.role === 'goal-title') {
            goal.title = target.value;
          } else if (target.dataset.role === 'goal-desc') {
            goal.description = target.value;
            autoResizeTextarea(target);
          } else if (target.dataset.role === 'cf-label' || target.dataset.role === 'cf-value') {
            const fieldEl = target.closest('[data-field-id]');
            const fieldId = parseInt(fieldEl.dataset.fieldId);
            const field = goal.customFields.find(f => f.id === fieldId);
            if (target.dataset.role === 'cf-label') {
              field.label = target.value;
            } else {
              field.value = target.value;
            }
          }
        }
        
        // Value realized
        if (target.closest('#value-container')) {
          const card = target.closest('[data-id]');
          if (!card) return;
          
          const valueId = parseInt(card.dataset.id);
          const value = state.valueRealized.find(v => v.id === valueId);
          
          if (target.dataset.role === 'value-type') {
            value.type = target.value;
          } else if (target.dataset.role === 'value-desc') {
            value.description = target.value;
            autoResizeTextarea(target);
          } else if (target.dataset.role === 'value-date') {
            value.date = target.value;
          } else if (target.dataset.role === 'value-link') {
            value.link = target.value;
          }
        }
      });
      
      // Add buttons
      $('#add-mission-goal-btn')?.addEventListener('click', () => {
        state.missionGoals.push({
          id: Date.now(),
          title: 'New Goal',
          description: '',
          customFields: []
        });
        renderMissionGoalsEdit();
      });
      
      $('#add-value-btn')?.addEventListener('click', () => {
        state.valueRealized.push({
          id: Date.now(),
          type: 'Time Savings',
          description: '',
          date: new Date().toISOString().split('T')[0],
          link: ''
        });
        renderValueEdit();
      });
      
      // Stakeholder select
      $('#add-stakeholder-select')?.addEventListener('change', (e) => {
        const value = e.target.value;
        if (value === 'new') {
          // Show new stakeholder modal
          const modal = createModal('Add New Stakeholder', `
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium mb-1">Name</label>
                <input type="text" id="new-name" class="text-zone p-2 w-full" placeholder="Full name">
              </div>
              <div>
                <label class="block text-sm font-medium mb-1">Title</label>
                <input type="text" id="new-title" class="text-zone p-2 w-full" placeholder="Job title">
              </div>
              <div>
                <label class="block text-sm font-medium mb-1">Email</label>
                <input type="email" id="new-email" class="text-zone p-2 w-full" placeholder="email@company.com">
              </div>
            </div>
          `, [
            { label: 'Cancel', class: 'btn-ghost', action: () => closeModal() },
            { label: 'Add Stakeholder', class: 'btn-primary', action: () => {
              const stakeholder = {
                id: Date.now(),
                name: $('#new-name').value.trim(),
                title: $('#new-title').value.trim(),
                email: $('#new-email').value.trim()
              };
              
              if (!stakeholder.name || !stakeholder.email) {
                showNotification('Name and email are required', 'error');
                return;
              }
              
              if (!stakeholder.email.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)) {
                showNotification('Please enter a valid email address', 'error');
                return;
              }
              
              state.stakeholders.push(stakeholder);
              renderAll();
              saveToLocalStorage();
              closeModal();
              showNotification('Stakeholder added', 'success');
            }}
          ]);
        } else if (value) {
          const contact = mockContacts.find(c => c.id === parseInt(value));
          if (contact) {
            state.stakeholders.push(contact);
            renderAll();
            saveToLocalStorage();
          }
        }
        e.target.value = '';
      });
      
      // Health score
      $('#health-score')?.addEventListener('change', (e) => {
        state.planHealth = e.target.value;
        saveToLocalStorage();
      });
      
      // Export buttons
      $('#export-pdf-btn')?.addEventListener('click', exportToPDF);
      $('#export-excel-btn')?.addEventListener('click', exportToExcel);
    }

    // ---------- Export Functions ----------
    async function exportToPDF() {
      const btn = $('#export-pdf-btn');
      btn.disabled = true;
      btn.innerHTML = '<span class="animate-spin">âŸ³</span> Generating...';
      
      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');
        
        // Define theme colors
        const colors = {
          primary: [20, 184, 166], // Teal
          primaryDark: [13, 148, 136],
          text: [17, 24, 39],
          textSecondary: [107, 114, 128],
          background: [249, 250, 251],
          success: [16, 185, 129],
          warning: [245, 158, 11],
          danger: [239, 68, 68],
          border: [229, 231, 235]
        };
        
        // Page setup
        const pageWidth = 210;
        const pageHeight = 297;
        const margin = 15;
        const contentWidth = pageWidth - (margin * 2);
        let y = margin;
        
        // Header with gradient background
        doc.setFillColor(...colors.primary);
        doc.rect(0, 0, pageWidth, 35, 'F');
        
        // Company logo placeholder
        doc.setFillColor(255, 255, 255);
        doc.circle(margin + 8, 17.5, 7, 'F');
        
        // Title
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(18);
        doc.setFont(undefined, 'bold');
        doc.text('Customer Success Plan', margin + 20, 15);
        
        doc.setFontSize(12);
        doc.setFont(undefined, 'normal');
        doc.text(state.customerName, margin + 20, 22);
        
        // Date
        doc.setFontSize(10);
        doc.text(`Generated: ${new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}`, pageWidth - margin - 50, 20);
        
        y = 45;
        
        // Mission Summary Section
        doc.setTextColor(...colors.text);
        doc.setFontSize(14);
        doc.setFont(undefined, 'bold');
        doc.text('Mission Summary', margin, y);
        y += 8;
        
        doc.setFontSize(9);
        doc.setFont(undefined, 'normal');
        doc.setTextColor(...colors.textSecondary);
        const summaryLines = doc.splitTextToSize(state.missionSummary || 'No mission summary defined', contentWidth);
        doc.text(summaryLines, margin, y);
        y += summaryLines.length * 4 + 8;
        
        // Two-column layout for Goals and Value Realized
        const colWidth = (contentWidth - 10) / 2;
        const col1X = margin;
        const col2X = margin + colWidth + 10;
        let col1Y = y;
        let col2Y = y;
        
        // Mission Goals (Left Column)
        doc.setTextColor(...colors.text);
        doc.setFontSize(12);
        doc.setFont(undefined, 'bold');
        doc.text('Mission Goals', col1X, col1Y);
        col1Y += 6;
        
        if (state.missionGoals.length > 0) {
          state.missionGoals.forEach((goal, idx) => {
            // Goal box
            doc.setFillColor(...colors.background);
            doc.setDrawColor(...colors.border);
            doc.roundedRect(col1X, col1Y, colWidth, 22, 2, 2, 'FD');
            
            // Goal title
            doc.setFontSize(9);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(...colors.primaryDark);
            doc.text(goal.title, col1X + 3, col1Y + 5);
            
            // Goal description
            doc.setFontSize(8);
            doc.setFont(undefined, 'normal');
            doc.setTextColor(...colors.textSecondary);
            const descLines = doc.splitTextToSize(goal.description, colWidth - 6);
            doc.text(descLines.slice(0, 2), col1X + 3, col1Y + 10);
            
            col1Y += 25;
          });
        } else {
          doc.setFontSize(8);
          doc.setTextColor(...colors.textSecondary);
          doc.text('No goals defined', col1X, col1Y + 5);
          col1Y += 10;
        }
        
        // Value Realized (Right Column)
        doc.setTextColor(...colors.text);
        doc.setFontSize(12);
        doc.setFont(undefined, 'bold');
        doc.text('Value Realized', col2X, col2Y);
        col2Y += 6;
        
        if (state.valueRealized.length > 0) {
          state.valueRealized.forEach((value, idx) => {
            // Value box
            doc.setFillColor(...colors.background);
            doc.setDrawColor(...colors.border);
            doc.roundedRect(col2X, col2Y, colWidth, 22, 2, 2, 'FD');
            
            // Value icon based on type
            const iconColor = value.type.includes('Savings') || value.type.includes('Reduction') ? colors.success :
                            value.type.includes('Increase') ? colors.primary : colors.warning;
            doc.setFillColor(...iconColor);
            doc.circle(col2X + 5, col2Y + 11, 2, 'F');
            
            // Value type
            doc.setFontSize(9);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(...colors.text);
            doc.text(value.type, col2X + 10, col2Y + 5);
            
            // Value description
            doc.setFontSize(8);
            doc.setFont(undefined, 'normal');
            doc.setTextColor(...colors.textSecondary);
            const valueLines = doc.splitTextToSize(value.description, colWidth - 13);
            doc.text(valueLines.slice(0, 2), col2X + 10, col2Y + 10);
            
            // Date
            doc.setFontSize(7);
            doc.text(new Date(value.date).toLocaleDateString(), col2X + colWidth - 25, col2Y + 19);
            
            col2Y += 25;
          });
        } else {
          doc.setFontSize(8);
          doc.setTextColor(...colors.textSecondary);
          doc.text('No value realized yet', col2X, col2Y + 5);
          col2Y += 10;
        }
        
        // Set y to the max of both columns
        y = Math.max(col1Y, col2Y) + 10;
        
        // Current Objectives Section
        doc.setTextColor(...colors.text);
        doc.setFontSize(14);
        doc.setFont(undefined, 'bold');
        doc.text('Current Objectives', margin, y);
        y += 8;
        
        if (state.objectives.length > 0) {
          state.objectives.forEach((obj, idx) => {
            // Objective card
            const cardHeight = obj.kpis && obj.kpis.length > 0 ? 30 + (obj.kpis.length * 8) : 30;
            doc.setFillColor(...colors.background);
            doc.setDrawColor(...colors.border);
            doc.roundedRect(margin, y, contentWidth, cardHeight, 3, 3, 'FD');
            
            // Status indicator
            const statusColor = obj.status === 'Completed' ? colors.success : 
                              obj.status === 'In Progress' ? colors.primary : 
                              colors.textSecondary;
            doc.setFillColor(...statusColor);
            doc.circle(margin + 5, y + 5, 2, 'F');
            
            // Objective name
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(...colors.text);
            doc.text(obj.name, margin + 10, y + 6);
            
            // Target date
            doc.setFontSize(8);
            doc.setFont(undefined, 'normal');
            doc.setTextColor(...colors.textSecondary);
            doc.text(`Target: ${new Date(obj.targetDate).toLocaleDateString()}`, contentWidth - 20, y + 6);
            
            // Description
            doc.setFontSize(8);
            const descLines = doc.splitTextToSize(obj.description, contentWidth - 10);
            doc.text(descLines.slice(0, 2), margin + 5, y + 12);
            
            // KPIs
            if (obj.kpis && obj.kpis.length > 0) {
              let kpiY = y + 20;
              obj.kpis.forEach(kpi => {
                const type = getKPIType(kpi.typeKey);
                const delta = calculateDelta(kpi.currentValue, kpi.previousValue);
                const deltaNum = parseFloat(delta);
                const isPositive = type.higherIsBetter ? deltaNum >= 0 : deltaNum <= 0;
                
                // KPI name
                doc.setFontSize(8);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(...colors.textSecondary);
                doc.text(`â€¢ ${type.label}:`, margin + 10, kpiY);
                
                // Current value
                doc.setFont(undefined, 'bold');
                doc.setTextColor(...colors.text);
                doc.text(`${kpi.currentValue}${type.unit}`, margin + 60, kpiY);
                
                // Delta
                if (kpi.comparePrevious && kpi.previousValue !== undefined) {
                  doc.setTextColor(...(isPositive ? colors.success : colors.danger));
                  doc.text(`${delta > 0 ? '+' : ''}${delta}%`, margin + 80, kpiY);
                }
                
                kpiY += 8;
              });
            }
            
            y += cardHeight + 5;
          });
        } else {
          doc.setFontSize(9);
          doc.setTextColor(...colors.textSecondary);
          doc.text('No current objectives defined', margin, y + 5);
          y += 15;
        }
        
        // Key Stakeholders Section (if space permits)
        if (y < pageHeight - 60) {
          doc.setTextColor(...colors.text);
          doc.setFontSize(14);
          doc.setFont(undefined, 'bold');
          doc.text('Key Stakeholders', margin, y);
          y += 8;
          
          if (state.stakeholders.length > 0) {
            // Create a row of stakeholder badges
            let xPos = margin;
            state.stakeholders.slice(0, 4).forEach((stakeholder, idx) => {
              const badgeWidth = 45;
              
              // Badge background
              doc.setFillColor(...colors.background);
              doc.setDrawColor(...colors.border);
              doc.roundedRect(xPos, y, badgeWidth, 20, 2, 2, 'FD');
              
              // Initials circle
              doc.setFillColor(...colors.primary);
              doc.circle(xPos + 8, y + 10, 6, 'F');
              doc.setTextColor(255, 255, 255);
              doc.setFontSize(8);
              doc.setFont(undefined, 'bold');
              const initials = stakeholder.name.split(' ').map(n => n[0]).join('');
              doc.text(initials, xPos + 5, y + 12);
              
              // Name
              doc.setTextColor(...colors.text);
              doc.setFontSize(7);
              doc.setFont(undefined, 'normal');
              const firstName = stakeholder.name.split(' ')[0];
              doc.text(firstName, xPos + 16, y + 8);
              
              // Role
              doc.setTextColor(...colors.textSecondary);
              doc.setFontSize(6);
              const shortTitle = stakeholder.title.length > 20 ? stakeholder.title.substring(0, 17) + '...' : stakeholder.title;
              doc.text(shortTitle, xPos + 16, y + 13);
              
              xPos += badgeWidth + 5;
            });
            
            if (state.stakeholders.length > 4) {
              doc.setFontSize(8);
              doc.setTextColor(...colors.textSecondary);
              doc.text(`+${state.stakeholders.length - 4} more`, xPos, y + 10);
            }
          }
        }
        
        // Footer
        doc.setFillColor(...colors.primary);
        doc.rect(0, pageHeight - 15, pageWidth, 15, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(8);
        doc.text('Responsive Platform - Customer Success', margin, pageHeight - 8);
        doc.text(`Products: ${state.products.join(', ')}`, pageWidth - margin - 60, pageHeight - 8);
        
        // Watermark
        doc.setTextColor(20, 184, 166);
        doc.setFontSize(11);
        doc.setFont(undefined, 'bold');
        doc.text('Atiq Azel Khan', pageWidth - margin - 40, pageHeight - 22, { angle: -3 });
        
        // Save
        const filename = `${state.customerName.replace(/\s+/g, '-').toLowerCase()}-success-plan-${new Date().toISOString().split('T')[0]}.pdf`;
        doc.save(filename);
        showNotification('PDF exported successfully', 'success');
      } catch (error) {
        showNotification('PDF export failed. Please try again.', 'error');
      }
      
      btn.disabled = false;
      btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V7.414A2 2 0 0015.414 6L12 2.586A2 2 0 0010.586 2H6zm5 6a1 1 0 10-2 0v3.586l-1.293-1.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V8z" clip-rule="evenodd" /></svg>Export PDF';
    }

    function exportToExcel() {
      try {
        const wb = XLSX.utils.book_new();
        
        // Plan Overview
        const overview = [{
          'Mission Summary': state.missionSummary,
          'Health Status': state.planHealth,
          'Active Products': state.products.join(', ')
        }];
        
        // Objectives with KPIs
        const objectives = [];
        state.objectives.forEach(obj => {
          objectives.push({
            'Objective': obj.name,
            'Status': obj.status,
            'Target Date': obj.targetDate,
            'Type': 'Current'
          });
          
          if (obj.kpis) {
            obj.kpis.forEach(kpi => {
              const type = getKPIType(kpi.typeKey);
              objectives.push({
                'Objective': `  â†’ ${type.label}`,
                'Status': `${kpi.currentValue} ${type.unit}`,
                'Target Date': `Delta: ${calculateDelta(kpi.currentValue, kpi.previousValue)}%`,
                'Type': 'KPI'
              });
            });
          }
        });
        
        // Add sheets
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(overview), 'Overview');
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(objectives), 'Objectives & KPIs');
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(state.missionGoals), 'Mission Goals');
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(state.valueRealized), 'Value Realized');
        
        XLSX.writeFile(wb, 'customer-success-plan-responsive.xlsx');
        showNotification('Excel exported successfully', 'success');
      } catch (error) {
        showNotification('Excel export failed. Please try again.', 'error');
      }
    }

    // ---------- Storage ----------
    function saveToLocalStorage() {
      try {
        localStorage.setItem('responsiveCustomerSuccess', JSON.stringify(state));
      } catch (error) {
        // Silently fail - localStorage may be disabled
      }
    }

    function loadFromLocalStorage() {
      try {
        const saved = localStorage.getItem('responsiveCustomerSuccess');
        if (saved) {
          Object.assign(state, JSON.parse(saved));
        }
      } catch (error) {
        // Silently fail - localStorage may be disabled
      }
    }

    // ---------- Render All ----------
    function renderAll() {
      renderCustomerName();
      renderMissionSummary();
      renderMissionGoalsDisplay();
      renderValueDisplay();
      renderObjectives();
      renderStakeholders();
      renderProducts();
    }
    
    function renderCustomerName() {
      const display = $('#customer-name-display');
      if (display) {
        display.textContent = state.customerName || 'Customer';
      }
    }

          // ---------- Initialize ----------
      function init() {
        // Set date
        const dateEl = $('#last-updated-date');
        if (dateEl) {
          dateEl.textContent = new Date().toLocaleDateString('en-US', { 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
          });
        }
        
        // Set responsive font size for title
        function updateTitleSize() {
          const title = $('#main-title');
          if (title) {
            const width = window.innerWidth;
            if (width >= 1024) {
              title.style.fontSize = '36px';
            } else if (width >= 768) {
              title.style.fontSize = '32px';
            } else {
              title.style.fontSize = '28px';
            }
          }
        }
        
        updateTitleSize();
        window.addEventListener('resize', updateTitleSize);
        
        loadFromLocalStorage();
        renderAll();
        setupSectionEditing();
        setupEventHandlers();
        
        // Add keyboard shortcuts
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') {
            const modal = $('.modal-overlay');
            if (modal) closeModal();
          }
        });
      }

    // Start the app
    init();
  </script>
</body>
</html>
